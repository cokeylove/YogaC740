C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 1   


C51 COMPILER V8.12, COMPILATION OF MODULE OEM_UCSI_CYP_CCG4
OBJECT MODULE PLACED IN Code\Oem\OEM_UCSI_CYP_CCG4.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Code\Oem\OEM_UCSI_CYP_CCG4.C LA WL(1) CD OT(9,SIZE) NOAREGS OR INCDIR(.\Cod
                    -e\CORE\INCLUDE\;.\Code\OEM\INCLUDE\;.\Code\CHIP\INCLUDE\)

line level    source

   1          //*****************************************************************************
   2          //
   3          //  oem_ucsi_opm_ppm.c
   4          //
   5          //  Copyright (c) 2012-
   6          //
   7          //  Created on: 2012/11/21
   8          //
   9          //      Author:
  10          //
  11          //*****************************************************************************
  12          //*****************************************************************************
  13          // Include all header file
  14          #include <CORE_INCLUDE.H>
  15          #include <OEM_INCLUDE.H>
  16          
  17          #if SUPPORT_UCSI
              /**
               * ****************************************************************************
               * external memory copy
               *
               * @return
               *
               * @parameter
               *
               * ****************************************************************************
               */
              void std_memcpy(XBYTE *p_destination,XBYTE *p_source,XWORD P_num)
              {
                      XWORD l_num;
              
                      for(l_num=0x00;l_num<P_num;l_num++)
                      {
                              *(p_destination+l_num) = *(p_source+l_num);
                      }
              }
              
              /**
               * ****************************************************************************
               * external memory set
               *
               * @return
               *
               * @parameter
               *
               * ****************************************************************************
               */
              void std_memset(XBYTE *p_ptr,XBYTE p_value,XWORD P_num)
              {
                      XWORD l_num;
              
                      for(l_num=0x00;l_num<P_num;l_num++)
                      {
                              *(p_ptr+l_num) = p_value;
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 2   

                      }
              }
              
              /**
               * ****************************************************************************
               * external memory compare
               *
               * @return
               *
               * @parameter
               *
               * ****************************************************************************
               */
              BYTE std_memcmp(XBYTE *ptr1,XBYTE *ptr2,XWORD P_num)
              {
              
                      XWORD l_num;
              
                      for(l_num=0x00;l_num<P_num;l_num++)
                      {
                              if(*(ptr1+l_num) != *(ptr2+l_num))
                              {       /* no match */
                                      return 1;
                              }
                      }
              
                      /* match */
                      return 0;
              }
              
              BYTE CCG4_UCSI_Reg_Read(BYTE Cmd_Region,BYTE *R_data_buffer,BYTE R_Length)
              {
                      XBYTE SMB_DATA_OEM = Cmd_Region;
              
                      if (I2CCompatibleWrite2Read(UCSI_PD_channel,CYPRESS_CCG4_UCSI_ADDR,1,&SMB_DATA_OEM,R_Length,R_data_buffer
             -))
                      {
                              return TRUE;
                      }
              
                      return FALSE;
              }
              
              BYTE CCG4_UCSI_Reg_Write(BYTE Cmd_Region,BYTE *W_data_buffer,BYTE W_Length)
              {
                      BYTE i;
              
                      UCSI_TUNNEL_Buffer[0] = Cmd_Region;
              
                      for (i = 0; i < W_Length ; i++)
                      {
                              UCSI_TUNNEL_Buffer[i+1] = *W_data_buffer;
                              W_data_buffer++;
                      }
              
                      if (I2CCompatibleWrite(UCSI_PD_channel,CYPRESS_CCG4_UCSI_ADDR,(W_Length+1),&UCSI_TUNNEL_Buffer))
                      {
                              return TRUE;
                      }
              
                      return FALSE;
              }
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 3   

              
              void ucsi_reset(void)
              {
                      //P_UCSI_DATA p = &pUCSI;
              
                      
              
                      //pUCSI = *p;
                      //72JERRY083:s+Change MMIO to mailbox for accessing UCSI registers.
                      BYTE index;
                      std_memset(&pUCSI,0x00,sizeof(T_UCSI_DATA));
                      for(index=0; index< 128; index++)
                      {
                              BRAMBK0[index] = 0x00;
                      }
                      //72JERRY083:e+Change MMIO to mailbox for accessing UCSI registers.     
              }
              
              BYTE ucsi_init(XBYTE *pBuffer)
              {
                      if (pBuffer)
                      {
                              std_memset(pBuffer,0x00,sizeof(T_UCSI_DATA));
              
                              //pUCSI = (P_UCSI_DATA)pBuffer;
              
                              // pPPM.pUCSI->u16Version = UCSI_TUNNEL_VERSION;
              
                              ucsi_reset();
                      }
              
                      UCSI_Tunnel_Proc = TUNNEL_WAIT_INIT;
                      //UCSI_Tunnel_Step = 0;
              
                      SCLKTS_A = 0x03; // Select the SMBUS1 clock to 400Khz.
              
              ///     Init_PD_INT_Wakeup(); Must init it
              
                      return sizeof(T_UCSI_DATA);
              }
              
              
              void CCG4_tunnel_set_alert(void)
              {
                      //if (pPPM.u16NotifyMask & BIT0)
                      //{
                      //      UCSI_TUNNEL_DEBUG(0xC5);
                      //      pPPM.u8MISC.field.sci_wait_ack = 1;
                              ECSMI_SCIEvent(QUCSI_Data_Ready);
                      //}
                      //else
                      //{
                      //      UCSI_TUNNEL_DEBUG(0xC6);
                      //}
              }
              
              void CCG4_Tunnel_Proc_Change(BYTE proc_step)
              {
                      /* Proc Change Debug */
                      //UCSI_TUNNEL_DEBUG(0xC0+proc_step);
              
                      //UCSI_Tunnel_Step = 0;
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 4   

                      UCSI_Tunnel_Proc = proc_step;
              }
              
              BYTE CCG4_Tunnel_Release_Interrupt(BYTE INTR)
              {
                      XBYTE result = FALSE;
                      XBYTE PD_Write_Buffer[3]; 
              
                      /* Release the CCG4_INT# pin to high */
                      PD_Write_Buffer[0] = 0x06;  // INTR_REG (0x0006)
                      PD_Write_Buffer[1] = 0x00;
                      PD_Write_Buffer[2] = INTR;  // Write one to clear for BIT3 (Release the INT# pin)
              
                      if (I2CCompatibleWrite(UCSI_PD_channel, CYPRESS_CCG4_HPI_ADDR ,3,&PD_Write_Buffer))
                      {
                              result = TRUE;
                      }
              
                      return result;
              }
              
              BYTE CCG4_Read_Interrupt_status(void)
              {
                      XBYTE result = FALSE;
                  XBYTE PD_Write_Buffer[2];
                      XBYTE PD_Read_Buffer[2];
              
                      /* Read status*/
                      PD_Write_Buffer[0] = 0x06;
                      PD_Write_Buffer[1] = 0x00;
              
                      if (I2CCompatibleWrite2Read(UCSI_PD_channel,CYPRESS_CCG4_HPI_ADDR ,2,&PD_Write_Buffer,1,&PD_Read_Buffer))
                      {
                              UCSI_Int_status = PD_Read_Buffer[0];
                              result = TRUE;
                              return TRUE;
                      }
                      RamDebug(0xDC);
                      RamDebug(0xFF);
                      UCSI_Int_status = 0x00;
              
                      return result;
              }
              //
              // 72JERRY069: Start Support identify typec adapter ID 
              //
              BYTE CCG4_Read_Adapter_Watts(void)
              {
                      XBYTE result = FALSE;
                  XBYTE PD_Write_Buffer[2];
                      XBYTE PD_Read_Buffer[2];
              
                      /* Read status*/
                      PD_Write_Buffer[0] = 0x41;
                      PD_Write_Buffer[1] = 0x00;
              
                      if (I2CCompatibleWrite2Read(UCSI_PD_channel,CYPRESS_CCG4_HPI_ADDR ,2,&PD_Write_Buffer,1,&PD_Read_Buffer))
                      {
                              TYPEC_Adapter_Watts = PD_Read_Buffer[0];
                              result = TRUE;
                              return TRUE;
                      }
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 5   

              
                      TYPEC_Adapter_Watts = 0x00;
              
                      return result;
              }
              void TypecAdapterDetection(void)
              {
                      if(IS_MASK_CLEAR(SYS_STATUS,AC_ADP))
                      {
                      CLEAR_MASK(SYS_STATUS,b5UnSuitAdpPow);
                          CLEAR_MASK(SYS_STATUS,b4IllegalAdp);
                          TYPEC_Adapter_Watts=0;
                          AdapterID=0;
                      return;
                      }
                      if (!CCG4_Read_Adapter_Watts())
                      {
                              return; 
                      }
                      switch(TYPEC_Adapter_Watts)
                      {
                      case 45:
                         AdapterID = AdapterID_45W;
                         break;
                      case 65:
                         AdapterID = AdapterID_65W;
                         break;
                      case 90:
                         AdapterID = AdapterID_90W;
                         break;
              //72JERRY075: Start optimize 
                     // case 120:
                     //    AdapterID = AdapterID_120W;
                     //   break;
                     //case 135:
                     //    AdapterID = AdapterID_135W;
                     //    break;
                     // case 175:
                    //     AdapterID = AdapterID_170W;
                    //     break;
                    //  case 230:
                    //     AdapterID = AdapterID_230W;
                    //     break;
              //72JERRY075: End
                      case 0xFF:
                         AdapterID = AdapterID_NON_SUPPORT;
                         break;
                      default:
                                      AdapterID = AdapterID_NON_SUPPORT;//72JERRY076: NO adapter ID
                         break;
                      }
                      if(TYPEC_Adapter_Watts>=45)
                      {
                              CLEAR_MASK(SYS_STATUS,b5UnSuitAdpPow);
                          CLEAR_MASK(SYS_STATUS,b4IllegalAdp);
                      }
                      if(TYPEC_Adapter_Watts<45 && TYPEC_Adapter_Watts>=36)
                      {
                              SET_MASK(SYS_STATUS,b5UnSuitAdpPow);
                          CLEAR_MASK(SYS_STATUS,b4IllegalAdp);
                      }
                      if(TYPEC_Adapter_Watts<36 && TYPEC_Adapter_Watts>=5)
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 6   

                      {
                              CLEAR_MASK(SYS_STATUS,b5UnSuitAdpPow);
                          SET_MASK(SYS_STATUS,b4IllegalAdp);
                      }
              }
              //
              //72JERRY069: End 
              //
              /**
               ** The main process of handling UCSI
               ** Hook 100ms
               **/
              
              BYTE ucsi_run(void)
              {
                 if(IS_MASK_SET(PDFWStatus,b5PDFWUpdate)) //When PD FW udpate, EC don't handle UCSI
                 {
                     //72JERRY075: Start optimize ucsi function
                         // if(SysPowState !=SYSTEM_S0)
                              //{
                              //      CLEAR_MASK(PDFWStatus,b5PDFWUpdate);    
                              //      CCG4_Tunnel_Proc_Change(0xFF); //After FW update and shutdown, EC start to handle UCSI
                         //   UCSI_Data_status=0x00;
                          //  UCSI_Int_status=0x00;
                         //   ucsi_reset();
                        //  }
                        //72JERRY075: End
                         return 0;
                 }
                 if((IS_MASK_CLEAR(SYS_MISC1,ACPI_OS) ||((SYS_STATUS&0x07) != 0x06))&& (SysPowState !=SYSTEM_S0))    //7
             -2JERRY069: Only do UCSI in S0//72JERRY076: Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
                 {
                              CLEAR_MASK(PDFWStatus,b5PDFWUpdate);    
                              CCG4_Tunnel_Proc_Change(TUNNEL_SERVICE); //After FW update and shutdown, EC start to handle UCSI
                          UCSI_Data_status=0x00;
                          UCSI_Int_status=0x00;
                          UCSI_Q20_Retry=0;//72JERRY076: Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
                          ucsi_reset();
                          return 0;
                      }
              
                 //72JERRY075: End -Optimize ucsi method only running the method under S0 mode and after ACPI init.
                      //TypecAdapterProction();
                 // TUNNEL Initial Debug 
                      //UCSI_TUNNEL_DEBUG(0xA0);
                  //UCSI_TUNNEL_DEBUG(UCSI_Tunnel_Proc);
                 switch (UCSI_Tunnel_Proc)
                 {
                      // ----------------------- 
                      // USCI TUNNEL Ready check 
                      // ----------------------- 
                      case TUNNEL_WAIT_INIT:
                              if (CCG4_UCSI_Reg_Read(UCSI_Version,&pUCSI.u16Version, UCSI_Version_SIZE))
                              {    
                                      //RamDebug(0xD0);
                                      if (pUCSI.u16Version != 0x0000) // non-zero CCG4-Version
                                      {   
                                              //RamDebug(0xD1);
                                              CCG4_Tunnel_Proc_Change(TUNEL_IRQ_HANDLER);
                                      }
                                      else
                                      {
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 7   

                                              //RamDebug(0xD2);
                                              CCG4_Tunnel_Proc_Change(TUNNEL_WAIT_INIT);
                                      }
                              }
                          break;
                  // ----------------------- 
                      // USCI TUNNEL IRQ Handler
                      // -----------------------
                  case TUNEL_IRQ_HANDLER:
                              //if (IS_UCSI_TUNNEL_INT())
                              //{
                                      //RamDebug(0xD3);
                                  if (CCG4_Read_Interrupt_status())
                                      {
                                              if(IS_MASK_SET(UCSI_Int_status,b3UCSIIntStatus))
                                      {
                                                      //RamDebug(0xD4);
                                                      CCG4_Tunnel_Proc_Change(TUNNEL_LPM_SERVICE);
                                              }
                                      }
                                      break;
                              //}
                      //break;
              
                      // ----------------------- 
                      // USCI TUNNEL service check 
                      // ----------------------- 
                      case TUNNEL_SERVICE:
                      //72JERRY083:s+Change MMIO to mailbox for accessing UCSI registers.
                        if(UCSI_WRITEIN_CMD0==0xE0)
                        {
                              SET_MASK(UCSI_Data_status,b7OSDataReady);
                              CLEAR_MASK(UCSI_Data_status,b6CCGDataReady);
                              UCSI_WRITEIN_CMD0=0;
                              RamDebug(0xE0);
                        }
                        else
                        {
                               if (IS_MASK_SET(UCSI_Data_status,b4QeventBIOSReceived))
                               {
                                      if (UCSI_READOUT_CMD0==0xE1)
                                      {
                                              CLEAR_MASK(UCSI_Data_status,b7OSDataReady);
                                              CLEAR_MASK(UCSI_Data_status,b6CCGDataReady);
                                              UCSI_READOUT_CMD0=0;
                                              RamDebug(0xE1);
                                      }
                               }
                        }
                        //72JERRY083:e+Change MMIO to mailbox for accessing UCSI registers.
              // 72JERRY075: Start optimize clear Q20 flag after last cmd and cmd completed flag
                              if(IS_MASK_SET(UCSI_Data_status,b5CmdCompletedIndicator) &&(IS_MASK_SET(UCSI_Data_status,b3Cmd04_ACK_CC_
             -CI))) 
                              {
                                      //CLEAR_MASK(UCSI_Data_status,b6CCGDataReady);//72JERRY076: Optimize ucsi function to handle OPM,EC not
             -ify OS every 2S by Q_20.
                                      CLEAR_MASK(UCSI_Data_status,b5CmdCompletedIndicator);
                                      CLEAR_MASK(UCSI_Data_status,b3Cmd04_ACK_CC_CI);
                                      //RamDebug(0xDD);//72JERRY076: Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
                              }
              //72JERRY075: Emd 
                          if(IS_MASK_SET(UCSI_Data_status,b7OSDataReady))
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 8   

                              {   
                                      //RamDebug(0xD8);
                                      UCSI_Q20_Retry=0;//72JERRY076: Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
                          SET_MASK(UCSI_Data_status,b4QeventBIOSReceived);//72JERRY076: Optimize ucsi function to handle
             - OPM,EC notify OS every 2S by Q_20.
                                      CCG4_Tunnel_Proc_Change(TUNNEL_OPM_SERVICE);
                                      break;
                              }
                              else
                              {
                                //CLEAR_MASK(UCSI_Data_status,b6CCGDataReady);
                              //}
                              //if (IS_UCSI_TUNNEL_INT())
                              //{
                                      //RamDebug(0xD5);
                                      if(IS_MASK_SET(UCSI_Data_status,b4QeventBIOSReceived))//72JERRY076: Optimize ucsi function to handle OP
             -M,EC notify OS every 2S by Q_20.
                                      {
                                              if((IS_MASK_CLEAR(UCSI_Data_status,b6CCGDataReady)))//||(IS_MASK_SET(UCSI_Data_status,b4QeventBIOSRece
             -ived)))//72JERRY075
                                              {  
                                      //ucsi_reset();
                                                      UCSI_Q20_Retry=0;//72JERRY076: Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
                                                      if (CCG4_Read_Interrupt_status())
                                                      {
                                              //RamDebug(0xD6);
                                                              if(IS_MASK_SET(UCSI_Int_status,b3UCSIIntStatus))//72JERRY076: Optimize ucsi function to handle OPM,E
             -C notify OS every 2S by Q_20.
                                                      {
                                                                      //RamDebug(0xD7);
                                                                      //UCSI_TUNNEL_DEBUG(UCSI_Int_status);
                                                                      //ucsi_reset();//72JERRY076: Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
                                                                      CCG4_Tunnel_Proc_Change(TUNNEL_LPM_SERVICE);
                                                                      break;
                                                              }
                                                              //72JERRY076:S+ Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
                                                              else
                                                              {
                                                                      if((pUCSI.unCCI0.byte==0x04)&&(pUCSI.unCCI3.byte==0x00))
                                                                      {
                                                                              if(pUCSI.stControl.u8Cmd!=0x00)
                                                                              {
                                                                                      //SET_MASK(UCSI_Data_status,b7OSDataReady);//72JERRY083: Remove patch for UCSI driver can't acces
             -s _Q20.
                                                                                      RamDebug(0xE3);
                                                                              }
                                                                      }
                                                              }
                                                      }
                                              }
              //72JERRY075£ºStart optimize ucsi function( don't notify Q20 more times.)
                                              else
                                              {
                                                      if(IS_MASK_SET(UCSI_Data_status,b6CCGDataReady))
                                                      {
                                                              UCSI_Q20_Retry--;
                                                              if(UCSI_Q20_Retry==0)
                                                              {
                                                                      UCSI_Q20_Retry=100;
                                                                      //CCG4_tunnel_set_alert();//Patch for UCSI driver can't access _Q20//72JERRY083: Remove patch for U
             -CSI driver can't access _Q20.
                                                              //72JERRY083: s+Optimize ucsi function to hang lenovo log.
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 9   

                                                                         if (CCG4_Read_Interrupt_status())
                                            {
                                                 if(IS_MASK_SET(UCSI_Int_status,b3UCSIIntStatus))
                                            {
                                                       //RamDebug(0xD4);
                                                 CCG4_Tunnel_Proc_Change(TUNNEL_LPM_SERVICE);
                                             }
                                               else
                                               {
                                                              CCG4_tunnel_set_alert();
                                              }
                                         }
              //72JERRY083: e+Optimize ucsi function to hang lenovo log.
                                                                      RamDebug(0xE2);
                                                              }
                                                      }
                                              }
                              }
                                      //72JERRY076: E+Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
              //72JERRY075: end
                              //      break;
                              }
                              //if(IS_MASK_CLEAR(UCSI_Data_status,b6CCGDataReady))
                              //{  
                              //if(IS_MASK_SET(UCSI_Data_status,b7OSDataReady))
                              //{   
                                      //RamDebug(0xD8);
                              //      CCG4_Tunnel_Proc_Change(TUNNEL_OPM_SERVICE);
                              //      break;
                              //}
                              //}
                          break;
              
                      //----------------------- 
                      // LPM Service -> TUNNEL Service   
                      // ----------------------- 
                      case TUNNEL_LPM_SERVICE:
                              if(IS_MASK_SET(UCSI_Int_status,b3UCSIIntStatus))
                              {
                                if(IS_MASK_SET(SYS_MISC1,ACPI_OS) && ((SYS_STATUS&0x07) == 0x06) &&(SysPowState==SYSTEM_S0))//can move
             - to in front of accessing PD//72JERRY076: Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
                                {
                                      if (CCG4_UCSI_Reg_Read(UCSI_MessageIn,&pUCSI.pMsgIn, UCSI_MessageIn_SIZE))
                                      {
                                              RamDebug(0xD9);
                                              std_memcpy(&UCSI_MSG_IN,&pUCSI.pMsgIn, UCSI_MessageIn_SIZE);//72JERRY083:Change MMIO to mailbox for ac
             -cessing UCSI registers.
                                              //RamDebug(BRAMBK0[0x14]);
                                              if (CCG4_UCSI_Reg_Read(UCSI_Cci,&pUCSI.unCCI0, UCSI_CCI_SIZE))
                                              {
                                                  RamDebug(0xDA);
                                                      std_memcpy(&UCSI_CCI,&pUCSI.unCCI0, UCSI_CCI_SIZE);//72JERRY083:Change MMIO to mailbox for accessing 
             -UCSI registers.
                                                  //RamDebug(BRAMBK0[0x10]);
                                                  //RamDebug(BRAMBK0[0x13]);
                                                  CLEAR_MASK(UCSI_Data_status,b5CmdCompletedIndicator);
              //72JERRY075: Start check busy and complete cmd
                                                  if(pUCSI.unCCI3.byte==0x20)
                                                  {
                                                      SET_MASK(UCSI_Data_status,b5CmdCompletedIndicator);
                                                  }
                                                  if(pUCSI.unCCI3.byte==0x10)
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 10  

                                                  {
                                                      RamDebug(0xE5);
                                                      //CLEAR_MASK(UCSI_Data_status,b6CCGDataReady);//7RJERRY004: Optimize ucsi function to handle OPM,
             -EC notify OS every 2S by Q_20.
                                                      //CCG4_tunnel_set_alert();//7RJERRY004: Optimize ucsi function to handle OPM,EC notify OS every 2
             -S by Q_20.
                                                              //CCG4_Tunnel_Release_Interrupt(UCSI_Int_status);//7RJERRY004: Optimize ucsi function to handle OPM,
             -EC notify OS every 2S by Q_20.
                                                              
                                                      //CCG4_Tunnel_Proc_Change(TUNNEL_SERVICE);//72JERRY076: Optimize ucsi function to handle OPM,EC n
             -otify OS every 2S by Q_20.
                                                              //break;//72JERRY076: Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
                                                  }
              //72JERRY075: End
                                                      //SET_MASK(UCSI_Data_status,b6CCGDataReady);//72JERRY075
                                                      if(IS_MASK_SET(SYS_MISC1,ACPI_OS) && ((SYS_STATUS&0x07) == 0x06) && (SysPowState==SYSTEM_S0))
                                      {
                                              SET_MASK(UCSI_Data_status,b6CCGDataReady); //72JERRY075: optimize 
                                      CCG4_tunnel_set_alert();
                                                              CCG4_Tunnel_Release_Interrupt(UCSI_Int_status);
                                                              UCSI_Q20_Retry=100;//72JERRY076: Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
                                                      CCG4_Tunnel_Proc_Change(TUNNEL_SERVICE);
                                                              break;
                                                      }
                                              }
                                      }
                                }
                              }
                              break;
              
                      // -----------------------
                      //   OPM Service  -> TUNNEL Service  
                      // ----------------------- 
                      case TUNNEL_OPM_SERVICE:
                          if(IS_MASK_SET(UCSI_Data_status,b7OSDataReady))
                              {  
                                   std_memcpy(&pUCSI.pMsgOut,&UCSI_MSG_OUT,UCSI_MessageOut_SIZE);//72JERRY083:Change MMIO to mailbox f
             -or accessing UCSI registers.
                                      if (CCG4_UCSI_Reg_Write(UCSI_MessageOut,&pUCSI.pMsgOut,UCSI_MessageOut_SIZE))
                                  {
                                              RamDebug(0xDB);
                                              //RamDebug(BRAMBK0[0x24]);
                                              //std_memcpy(&UCSI_MSG_OUT,&pUCSI.pMsgOut,UCSI_MessageOut_SIZE);
                                               std_memcpy(&pUCSI.stControl,&UCSI_CONTROL,UCSI_CONTROL_SIZE);//72JERRY083:Change MMIO to mailbox for 
             -accessing UCSI registers.
                                              if (CCG4_UCSI_Reg_Write(UCSI_Control,&pUCSI.stControl,UCSI_CONTROL_SIZE))
                                              {   
                                                 RamDebug(0xDC);
                                                 //RamDebug(BRAMBK0[0x34]);
                                                 //std_memcpy(&UCSI_CONTROL,&pUCSI.stControl,UCSI_CONTROL_SIZE);
              //72JERRY075: Start optimize check last completed cmd 
                                                 CLEAR_MASK(UCSI_Data_status,b3Cmd04_ACK_CC_CI);
                                                 if(pUCSI.stControl.u8Cmd==0x04)
                                                 {
                                                        SET_MASK(UCSI_Data_status,b3Cmd04_ACK_CC_CI);
                                                 }
              //72JERRY075: End
                                                      CLEAR_MASK(UCSI_Data_status,b7OSDataReady);
                                                  //CLEAR_MASK(UCSI_Data_status,b6CCGDataReady);
                                                      //CLEAR_MASK(UCSI_Data_status,b4QeventBIOSReceived);//72JERRY076: Optimize ucsi function to handle OP
             -M,EC notify OS every 2S by Q_20.
                                               
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 11  

                                              //      ucsi_reset();//72JERRY076: Optimize ucsi function to handle OPM,EC notify OS every 2S by Q_20.
                                                      CCG4_Tunnel_Proc_Change(TUNNEL_SERVICE);
                                              }
                                      }
                      }
                              break;
                      default:
                          //CCG4_Tunnel_Proc_Change(TUNNEL_WAIT_INIT);
                              CCG4_Tunnel_Proc_Change(TUNNEL_OPM_SERVICE);
                          UCSI_Data_status=0x00;
                          UCSI_Int_status=0x00;
                          ucsi_reset();
                          //SCLKTS_A = 0x03;//CLK 400KHz
                          break;
                      }
                      return 0;
              }
              
              //72JERRY081: s+Dsable UCSI function.
              #else
 613          BYTE CCG4_Read_Adapter_Watts(void)
 614          {
 615   1              XBYTE result = FALSE;
 616   1          XBYTE PD_Write_Buffer[2];
 617   1              XBYTE PD_Read_Buffer[2];
 618   1      
 619   1              /* Read status*/
 620   1              PD_Write_Buffer[0] = 0x41;
 621   1              PD_Write_Buffer[1] = 0x00;
 622   1      
 623   1              if (I2CCompatibleWrite2Read(UCSI_PD_channel,CYPRESS_CCG4_HPI_ADDR ,2,&PD_Write_Buffer,1,&PD_Read_Buffer))
 624   1              {
 625   2                      TYPEC_Adapter_Watts = PD_Read_Buffer[0];
 626   2                      result = TRUE;
 627   2                      return TRUE;
 628   2              }
 629   1      
 630   1              TYPEC_Adapter_Watts = 0x00;
 631   1      
 632   1              return result;
 633   1      }
 634          
 635          void TypecAdapterDetection(void)
 636          {
 637   1              if(IS_MASK_CLEAR(SYS_STATUS,AC_ADP))
 638   1              {
 639   2              CLEAR_MASK(SYS_STATUS,b5UnSuitAdpPow);
 640   2                  CLEAR_MASK(SYS_STATUS,b4IllegalAdp);
 641   2                  TYPEC_Adapter_Watts=0;
 642   2                  AdapterID=0;
 643   2              return;
 644   2              }
 645   1              if (!CCG4_Read_Adapter_Watts())
 646   1              {
 647   2                      return; 
 648   2              }
 649   1              switch(TYPEC_Adapter_Watts)
 650   1              {
 651   2              case 45:
 652   2                 AdapterID = AdapterID_45W;
 653   2                 break;
 654   2              case 65:
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 12  

 655   2                 AdapterID = AdapterID_65W;
 656   2                 break;
 657   2              case 90:
 658   2                 AdapterID = AdapterID_90W;
 659   2                 break;
 660   2      //72JERRY075: Start optimize 
 661   2             // case 120:
 662   2             //    AdapterID = AdapterID_120W;
 663   2             //   break;
 664   2             //case 135:
 665   2             //    AdapterID = AdapterID_135W;
 666   2             //    break;
 667   2             // case 175:
 668   2            //     AdapterID = AdapterID_170W;
 669   2            //     break;
 670   2            //  case 230:
 671   2            //     AdapterID = AdapterID_230W;
 672   2            //     break;
 673   2      //72JERRY075: End
 674   2              case 0xFF:
 675   2                 AdapterID = AdapterID_NON_SUPPORT;
 676   2                 break;
 677   2              default:
 678   2                              AdapterID = AdapterID_NON_SUPPORT;//72JERRY076: NO adapter ID
 679   2                 break;
 680   2              }
 681   1              if(TYPEC_Adapter_Watts>=45)
 682   1              {
 683   2                      CLEAR_MASK(SYS_STATUS,b5UnSuitAdpPow);
 684   2                  CLEAR_MASK(SYS_STATUS,b4IllegalAdp);
 685   2              }
 686   1              if(TYPEC_Adapter_Watts<45 && TYPEC_Adapter_Watts>=36)
 687   1              {
 688   2                      SET_MASK(SYS_STATUS,b5UnSuitAdpPow);
 689   2                  CLEAR_MASK(SYS_STATUS,b4IllegalAdp);
 690   2              }
 691   1              if(TYPEC_Adapter_Watts<36 && TYPEC_Adapter_Watts>=5)
 692   1              {
 693   2                      CLEAR_MASK(SYS_STATUS,b5UnSuitAdpPow);
 694   2                  SET_MASK(SYS_STATUS,b4IllegalAdp);
 695   2              }
 696   1      }
 697          //72JERRY081: Dsable UCSI function.
 698          #endif
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 13  

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION CCG4_Read_Adapter_Watts (BEGIN)
                                           ; SOURCE LINE # 613
                                           ; SOURCE LINE # 614
                                           ; SOURCE LINE # 615
0000 E4                CLR     A
0001 900000      R     MOV     DPTR,#result
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 620
0005 A3                INC     DPTR
0006 7441              MOV     A,#041H
0008 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 621
0009 E4                CLR     A
000A A3                INC     DPTR
000B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 623
000C 900000      E     MOV     DPTR,#?_I2CCompatibleWrite2Read?BYTE+04H
000F 7400        R     MOV     A,#HIGH PD_Write_Buffer
0011 F0                MOVX    @DPTR,A
0012 A3                INC     DPTR
0013 7400        R     MOV     A,#LOW PD_Write_Buffer
0015 F0                MOVX    @DPTR,A
0016 A3                INC     DPTR
0017 E4                CLR     A
0018 F0                MOVX    @DPTR,A
0019 A3                INC     DPTR
001A 04                INC     A
001B F0                MOVX    @DPTR,A
001C 7E00        R     MOV     R6,#HIGH PD_Read_Buffer
001E A3                INC     DPTR
001F 7400        R     MOV     A,#HIGH PD_Read_Buffer
0021 F0                MOVX    @DPTR,A
0022 A3                INC     DPTR
0023 7400        R     MOV     A,#LOW PD_Read_Buffer
0025 F0                MOVX    @DPTR,A
0026 7B02              MOV     R3,#02H
0028 7A00              MOV     R2,#00H
002A 7D10              MOV     R5,#010H
002C E4                CLR     A
002D FF                MOV     R7,A
002E 120000      E     LCALL   _I2CCompatibleWrite2Read
0031 EF                MOV     A,R7
0032 6010              JZ      ?C0001
                                           ; SOURCE LINE # 624
                                           ; SOURCE LINE # 625
0034 900000      R     MOV     DPTR,#PD_Read_Buffer
0037 E0                MOVX    A,@DPTR
0038 900000      E     MOV     DPTR,#TYPEC_Adapter_Watts
003B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 626
003C 900000      R     MOV     DPTR,#result
003F 7401              MOV     A,#01H
0041 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 627
0042 FF                MOV     R7,A
0043 22                RET     
                                           ; SOURCE LINE # 628
0044         ?C0001:
                                           ; SOURCE LINE # 630
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 14  

0044 E4                CLR     A
0045 900000      E     MOV     DPTR,#TYPEC_Adapter_Watts
0048 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 632
0049 900000      R     MOV     DPTR,#result
004C E0                MOVX    A,@DPTR
004D FF                MOV     R7,A
                                           ; SOURCE LINE # 633
004E         ?C0002:
004E 22                RET     
             ; FUNCTION CCG4_Read_Adapter_Watts (END)

             ; FUNCTION TypecAdapterDetection (BEGIN)
                                           ; SOURCE LINE # 635
                                           ; SOURCE LINE # 636
                                           ; SOURCE LINE # 637
0000 900000      E     MOV     DPTR,#SYS_STATUS
0003 E0                MOVX    A,@DPTR
0004 20E712            JB      ACC.7,?C0003
                                           ; SOURCE LINE # 638
                                           ; SOURCE LINE # 639
0007 E0                MOVX    A,@DPTR
0008 54DF              ANL     A,#0DFH
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 640
000B E0                MOVX    A,@DPTR
000C 54EF              ANL     A,#0EFH
000E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 641
000F E4                CLR     A
0010 900000      E     MOV     DPTR,#TYPEC_Adapter_Watts
0013 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 642
0014 900000      E     MOV     DPTR,#AdapterID
0017 F0                MOVX    @DPTR,A
0018 22                RET     
                                           ; SOURCE LINE # 644
0019         ?C0003:
                                           ; SOURCE LINE # 645
0019 120000      R     LCALL   CCG4_Read_Adapter_Watts
001C EF                MOV     A,R7
001D 6079              JZ      ?C0004
                                           ; SOURCE LINE # 646
                                           ; SOURCE LINE # 648
001F         ?C0005:
                                           ; SOURCE LINE # 649
001F 900000      E     MOV     DPTR,#TYPEC_Adapter_Watts
0022 E0                MOVX    A,@DPTR
0023 24BF              ADD     A,#0BFH
0025 6014              JZ      ?C0008
0027 24E7              ADD     A,#0E7H
0029 6018              JZ      ?C0009
002B 245B              ADD     A,#05BH
002D 601B              JZ      ?C0011
002F 24D2              ADD     A,#0D2H
0031 7017              JNZ     ?C0011
                                           ; SOURCE LINE # 650
                                           ; SOURCE LINE # 651
0033         ?C0007:
                                           ; SOURCE LINE # 652
0033 900000      E     MOV     DPTR,#AdapterID
0036 7405              MOV     A,#05H
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 15  

0038 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 653
0039 8015              SJMP    ?C0006
                                           ; SOURCE LINE # 654
003B         ?C0008:
                                           ; SOURCE LINE # 655
003B 900000      E     MOV     DPTR,#AdapterID
003E 7402              MOV     A,#02H
0040 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 656
0041 800D              SJMP    ?C0006
                                           ; SOURCE LINE # 657
0043         ?C0009:
                                           ; SOURCE LINE # 658
0043 E4                CLR     A
0044 900000      E     MOV     DPTR,#AdapterID
0047 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 659
0048 8006              SJMP    ?C0006
                                           ; SOURCE LINE # 674
                                           ; SOURCE LINE # 677
004A         ?C0011:
                                           ; SOURCE LINE # 678
004A         ?C0015:
004A 900000      E     MOV     DPTR,#AdapterID
004D 74FF              MOV     A,#0FFH
004F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 679
                                           ; SOURCE LINE # 680
0050         ?C0006:
                                           ; SOURCE LINE # 681
0050 900000      E     MOV     DPTR,#TYPEC_Adapter_Watts
0053 E0                MOVX    A,@DPTR
0054 C3                CLR     C
0055 942D              SUBB    A,#02DH
0057 400B              JC      ?C0012
                                           ; SOURCE LINE # 682
                                           ; SOURCE LINE # 683
0059 900000      E     MOV     DPTR,#SYS_STATUS
005C E0                MOVX    A,@DPTR
005D 54DF              ANL     A,#0DFH
005F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 684
0060 E0                MOVX    A,@DPTR
0061 54EF              ANL     A,#0EFH
0063 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 685
0064         ?C0012:
                                           ; SOURCE LINE # 686
0064 900000      E     MOV     DPTR,#TYPEC_Adapter_Watts
0067 E0                MOVX    A,@DPTR
0068 C3                CLR     C
0069 942D              SUBB    A,#02DH
006B 5011              JNC     ?C0013
006D E0                MOVX    A,@DPTR
006E C3                CLR     C
006F 9424              SUBB    A,#024H
0071 400B              JC      ?C0013
                                           ; SOURCE LINE # 687
                                           ; SOURCE LINE # 688
0073 900000      E     MOV     DPTR,#SYS_STATUS
0076 E0                MOVX    A,@DPTR
C51 COMPILER V8.12   OEM_UCSI_CYP_CCG4                                                     09/14/2018 11:08:44 PAGE 16  

0077 4420              ORL     A,#020H
0079 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 689
007A E0                MOVX    A,@DPTR
007B 54EF              ANL     A,#0EFH
007D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 690
007E         ?C0013:
                                           ; SOURCE LINE # 691
007E 900000      E     MOV     DPTR,#TYPEC_Adapter_Watts
0081 E0                MOVX    A,@DPTR
0082 C3                CLR     C
0083 9424              SUBB    A,#024H
0085 5011              JNC     ?C0004
0087 E0                MOVX    A,@DPTR
0088 C3                CLR     C
0089 9405              SUBB    A,#05H
008B 400B              JC      ?C0004
                                           ; SOURCE LINE # 692
                                           ; SOURCE LINE # 693
008D 900000      E     MOV     DPTR,#SYS_STATUS
0090 E0                MOVX    A,@DPTR
0091 54DF              ANL     A,#0DFH
0093 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 694
0094 E0                MOVX    A,@DPTR
0095 4410              ORL     A,#010H
0097 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 695
                                           ; SOURCE LINE # 696
0098         ?C0004:
0098 22                RET     
             ; FUNCTION TypecAdapterDetection (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    232    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       5
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
