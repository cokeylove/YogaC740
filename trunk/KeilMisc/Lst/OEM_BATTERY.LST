C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 1   


C51 COMPILER V8.12, COMPILATION OF MODULE OEM_BATTERY
OBJECT MODULE PLACED IN Code\OEM\OEM_BATTERY.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Code\OEM\OEM_BATTERY.C LA WL(1) CD OT(9,SIZE) NOAREGS OR INCDIR(.\Code\CORE
                    -\INCLUDE\;.\Code\OEM\INCLUDE\;.\Code\CHIP\INCLUDE\)

line level    source

   1          /*-----------------------------------------------------------------------------
   2           * TITLE: OEM_BATTERY.C
   3           *
   4           * Author : Dino
   5           *
   6           * Note : These functions are reference only.
   7           *        Please follow your project software specification to do some modification.
   8           *---------------------------------------------------------------------------*/
   9          
  10          #include <CORE_INCLUDE.H>
  11          #include <OEM_INCLUDE.H>
  12          
  13          void UpdateNameSpace(void)
  14          {
  15   1              nBattGasgauge=BAT1PERCL;
  16   1      
  17   1      //      Bat0x0FTempL=(((WORD)(nRemainingCapH << 8) + nRemainingCapL)/10);
  18   1      //      Bat0x0FTempH=(((WORD)(nRemainingCapH << 8) + nRemainingCapL)/10)>>8;
  19   1              
  20   1          if((BAT1PERCL<=0x06)&&IS_MASK_CLEAR(SYS_STATUS,AC_ADP))
  21   1          {
  22   2             SET_MASK(Thro_Status2, b5Bat_5PProtect);
  23   2          }
  24   1          else
  25   1          {
  26   2             CLR_MASK(Thro_Status2, b5Bat_5PProtect);
  27   2          }
  28   1             
  29   1              nCycleCounter=EC_oCCBQl;
  30   1              EC_BatteryStatusL = nBattery0x16L;
  31   1              EC_BatteryStatusH = nBattery0x16H;
  32   1      
  33   1              if(IS_MASK_SET(nBattery0x16L,FullyChg))
  34   1          {
  35   2                      SET_MASK(nBatteryStatus1,ENFULL);
  36   2      
  37   2              if(nBattGasgauge == 100) // 100%
  38   2              {
  39   3                  if(IS_MASK_CLEAR(LENOVOPMFW_Temp,BATTERY_FULLED_100))
  40   3                  {
  41   4                      SET_MASK(LENOVOPMFW_Temp,BATTERY_FULLED_100);
  42   4                      ECSMI_SCIEvent(ACPI_BAT1IN_SCI); // Notify BIOS Update Batt Status
  43   4                  }
  44   3              }
  45   2              }
  46   1              else
  47   1          {
  48   2                      CLEAR_MASK(nBatteryStatus1,ENFULL);
  49   2              CLEAR_MASK(LENOVOPMFW_Temp,BATTERY_FULLED_100);
  50   2              }
  51   1      
  52   1              Lenovo_Battery_EM80();
  53   1      
  54   1          //Mos: Reset Battery Protection Status when AC off or battery plugout
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 2   

  55   1              /* 
  56   1              if (IS_MASK_SET(StatusKeeper, BatteryProtectCHG))
  57   1              {
  58   1                      if (!Read_AC_IN())
  59   1                      CLEAR_MASK(StatusKeeper, BatteryProtectCHG);
  60   1              }
  61   1              */  
  62   1      #if turboboostandstorage //storage mode action with support turbo boost charger
  63   1      
  64   1              if(testtoolflag==0)//Add flag for test tool to keep the battery RSOC at 60%
  65   1              {
  66   2                      if(IS_MASK_SET(LENOVOPMFW,BATTERY_STORAGE) && IS_MASK_CLEAR(LENOVOPMFW,BATTERY_MAIN_CAL))
  67   2                      {
  68   3                              nRemainingCapL = Bat0x0FTempL;
  69   3                              nRemainingCapH = Bat0x0FTempH;
  70   3                      
  71   3                              SET_MASK(LENOVOPMFW_Temp,BATTERY_CYCLE_RUNNING);
  72   3                      
  73   3                              if(nBattGasgauge >= 55)
  74   3                              {
  75   4                                      if( IS_MASK_SET(ACOFF_SOURCE, BATTLEARN) )
  76   4                                      { 
  77   5                                      ECSMI_SCIEvent(ACPI_BAT1IN_SCI); 
  78   5                      }
  79   4                                      CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
  80   4                                      BATT_LEN_OFF(); //Mos //add battery learn mode
  81   4                                      //Mos: Change Status bit to avoid bit has been reset
  82   4                      if (IS_MASK_CLEAR(StatusKeeper, BatteryProtectCHG))
  83   4                      {
  84   5                              SET_MASK(nStopChgStat3H, EmStopChgarg);
  85   5                      }
  86   4                      else
  87   4                      {
  88   5                              CLEAR_MASK(nStopChgStat3H, EmStopChgarg);
  89   5                              if(nBattGasgauge == 60)
  90   5                                      {
  91   6                                                      if(KeepBattRemineCap == 0)
  92   6                                                      { 
  93   7                                                      KeepBattRemineCap = (WORD)(nRemainingCapH << 8) + nRemainingCapL; 
  94   7                              }
  95   6                                                      else
  96   6                                                      {
  97   7                                                              CalcBatRCC =(nFullChgCapH<<8)+nFullChgCapL;//ANGELAS101:Modify battery discharge when battery RSOC 
             -is 59% in storage mode.
  98   7                                                              //Mos: Avoid that stop charger but OS show god damn 59%...
  99   7                                                              //if (((WORD)(nRemainingCapH << 8) + nRemainingCapL) > (KeepBattRemineCap + 10))//ANGELAS101:-Modif
             -y battery discharge when battery RSOC is 59% in storage mode.
 100   7                                                              if(((WORD)(nRemainingCapH << 8) + nRemainingCapL) > (KeepBattRemineCap + (CalcBatRCC/200)))//ANGELA
             -S101:+Modify battery discharge when battery RSOC is 59% in storage mode.
 101   7                                                              {
 102   8                                                                      KeepBattRemineCap = 0;
 103   8                                                                      CLEAR_MASK(StatusKeeper, BatteryProtectCHG);
 104   8                                                                      ECSMI_SCIEvent(ACPI_BAT1IN_SCI); // Notify BIOS Update Batt Status
 105   8                                                              }
 106   7                                                      }
 107   6                                              }
 108   5                      }
 109   4                                      //ACOFF_LOW();
 110   4                              
 111   4                              }
 112   3                              else if (nBattGasgauge < 55)
 113   3                              {
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 3   

 114   4                                      CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
 115   4                                      BATT_LEN_OFF(); //MosG25:add battery learn mode
 116   4                                      //Mos: Change Status bit to avoid bit has been reset
 117   4                      SET_MASK(StatusKeeper, BatteryProtectCHG);
 118   4                                      CLR_MASK(nStopChgStat3H,EmStopChgarg);
 119   4                                      //ACOFF_LOW();                                                                                  // charge
 120   4                              }
 121   3                      }
 122   2                      else 
 123   2                      {
 124   3                              //if (IS_MASK_SET(EC_BatteryStatusL,FullyChg)&&(IS_MASK_SET(SYS_STATUS,AC_ADP))) //MEILING025:remove.
 125   3                              if (IS_MASK_SET(EC_BatteryStatusL,FullyChg)&&(IS_MASK_SET(SYS_STATUS,AC_ADP))&&(nBattGasgauge==100)) //
             -MEILING025:add.
 126   3                              {
 127   4                                      nRemainingCapL = nFullChgCapL;
 128   4                                      nRemainingCapH = nFullChgCapH;
 129   4                              }
 130   3                              else
 131   3                              {
 132   4                                      //Mos: return RSOC(0x0d)=0 to BIOS if battery error
 133   4                                      if (ChkBattery_abnormal_status == ChkBattery_abnormal_status_error)
 134   4                                      {
 135   5                                              //nRemainingCapL = 0;  //LMLKBL0006:remove.
 136   5                                              //nRemainingCapH = 0;  //LMLKBL0006:remove.
 137   5                                      }
 138   4                                      else
 139   4                                      {
 140   5                                              nRemainingCapL = Bat0x0FTempL;
 141   5                                              nRemainingCapH = Bat0x0FTempH;
 142   5                                      }
 143   4                              }
 144   3      
 145   3                      if(IS_MASK_SET(LENOVOPMFW_Temp,BATTERY_CYCLE_RUNNING))
 146   3                      {
 147   4                      CLEAR_MASK(LENOVOPMFW_Temp,BATTERY_CYCLE_RUNNING);
 148   4      
 149   4                      if(IS_MASK_SET(ACOFF_SOURCE,BATTLEARN))
 150   4                      {
 151   5                              CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
 152   5                                              BATT_LEN_OFF(); //MosG25:add battery learn mode
 153   5                              //ACOFF_LOW();
 154   5                      }
 155   4                      }
 156   3      
 157   3                              //Mos: Clear BATTERY_CYCLE_fulchg when change to Longest Battery Mode
 158   3                      CLEAR_MASK(StatusKeeper, BatteryProtectCHG);
 159   3                              CLR_MASK(nStopChgStat3H,EmStopChgarg);
 160   3              }
 161   2              }
 162   1              else if(testtoolflag==1)
 163   1              {
 164   2                      if (IS_MASK_SET(LENOVOPMFW,BATTERY_STORAGE) && IS_MASK_CLEAR(LENOVOPMFW,BATTERY_MAIN_CAL)) 
 165   2                      {
 166   3                              //Mos: return RSOC(0x0d)=0 to BIOS if battery error
 167   3                              /*  
 168   3                              if ((ChkBattery_abnormal_status == ChkBattery_abnormal_status_error)
 169   3                                      || (Chk_Trickle_Current_status == Chk_Trickle_Current_status_error))
 170   3                              {
 171   3                                      //nRemainingCapL = 0;
 172   3                                      //nRemainingCapH = 0;
 173   3                                      //Mos: Disable report RSOC(0x0d) = 0 to BIOS, need to modify spec
 174   3                                      nRemainingCapL = Bat0x0FTempL;
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 4   

 175   3                                      nRemainingCapH = Bat0x0FTempH;
 176   3                              }
 177   3                              else
 178   3                              */              
 179   3                      
 180   3                              nRemainingCapL = Bat0x0FTempL;
 181   3                              nRemainingCapH = Bat0x0FTempH;
 182   3                      
 183   3                              SET_MASK(LENOVOPMFW_Temp,BATTERY_CYCLE_RUNNING);
 184   3      
 185   3                              if (nBattGasgauge > 60)
 186   3                              {
 187   4                                      SET_MASK(ACOFF_SOURCE, BATTLEARN);
 188   4                                      BATT_LEN_ON();  //add battery learn mode
 189   4                                      /*
 190   4                                      if(IS_MASK_SET(CHGIC_ReadCmd0x37L, TurboBoost)&&(nNowCurrentH & 0x80))
 191   4                                      {
 192   4                                              ACOFF_LOW();
 193   4                                              CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
 194   4                                      }
 195   4                                      else                      
 196   4                                              ACOFF_HI();             // discharge
 197   4                                      */
 198   4                              }
 199   3                              else if (nBattGasgauge >= 55 && nBattGasgauge <= 60)
 200   3                              {
 201   4                                      if ( IS_MASK_SET(ACOFF_SOURCE, BATTLEARN) )
 202   4                                      { 
 203   5                                      ECSMI_SCIEvent(ACPI_BAT1IN_SCI); 
 204   5                      }
 205   4                                      CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
 206   4                                      BATT_LEN_OFF(); //Mos //add battery learn mode
 207   4                                      //Mos: Change Status bit to avoid bit has been reset
 208   4                      if (IS_MASK_CLEAR(StatusKeeper, BatteryProtectCHG))
 209   4                      {
 210   5                              SET_MASK(nStopChgStat3H, EmStopChgarg);
 211   5                      }
 212   4                      else
 213   4                      {
 214   5                              CLEAR_MASK(nStopChgStat3H, EmStopChgarg);
 215   5                              if (nBattGasgauge == 60)
 216   5                                      {
 217   6                                                      if (KeepBattRemineCap == 0)
 218   6                                                      { 
 219   7                                                      KeepBattRemineCap = (WORD)(nRemainingCapH << 8) + nRemainingCapL; 
 220   7                              }
 221   6                                                      else
 222   6                                                      {
 223   7                                                              CalcBatRCC =(nFullChgCapH<<8)+nFullChgCapL; //ANGELAS101:Modify battery discharge when battery RSOC
             - is 59% in storage mode.
 224   7                                                              //Mos: Avoid that stop charger but OS show god damn 59%...
 225   7                                                              //if (((WORD)(nRemainingCapH << 8) + nRemainingCapL) > (KeepBattRemineCap + 10))//ANGELAS101:Modify
             - battery discharge when battery RSOC is 59% in storage mode.
 226   7                                                      if (((WORD)(nRemainingCapH << 8) + nRemainingCapL) > (KeepBattRemineCap + (CalcBatRCC/200)))//A
             -NGELAS101:Modify battery discharge when battery RSOC is 59% in storage mode.
 227   7                                                              {
 228   8                                                                      KeepBattRemineCap = 0;
 229   8                                                                      CLEAR_MASK(StatusKeeper, BatteryProtectCHG);
 230   8                                                                      ECSMI_SCIEvent(ACPI_BAT1IN_SCI); // Notify BIOS Update Batt Status
 231   8                                                              }
 232   7                                                      }
 233   6                                              }
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 5   

 234   5                      }
 235   4                                      //ACOFF_LOW();                                                                                  // charge
 236   4                              }
 237   3                              else if (nBattGasgauge < 55)
 238   3                              {
 239   4                                      CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
 240   4                                      BATT_LEN_OFF(); //add battery learn mode
 241   4                                      //Mos: Change Status bit to avoid bit has been reset
 242   4                      SET_MASK(StatusKeeper, BatteryProtectCHG);
 243   4                                      CLR_MASK(nStopChgStat3H,EmStopChgarg);
 244   4                                      //ACOFF_LOW();                                                                                  // charge
 245   4                              }
 246   3                      }
 247   2              
 248   2                      else
 249   2                      {
 250   3                              //if (IS_MASK_SET(EC_BatteryStatusL,FullyChg)&&(IS_MASK_SET(SYS_STATUS,AC_ADP))) //MEILING025:remove.
 251   3                              if (IS_MASK_SET(EC_BatteryStatusL,FullyChg)&&(IS_MASK_SET(SYS_STATUS,AC_ADP))&&(nBattGasgauge==100)) //
             -MEILING025:add.
 252   3                              {
 253   4                                      nRemainingCapL = nFullChgCapL;
 254   4                                      nRemainingCapH = nFullChgCapH;
 255   4                              }
 256   3                              else
 257   3                              {
 258   4                                      //Mos: return RSOC(0x0d)=0 to BIOS if battery error
 259   4                                      if (ChkBattery_abnormal_status == ChkBattery_abnormal_status_error)
 260   4                                      {
 261   5                                              //nRemainingCapL = 0;  //LMLKBL0006:remove.
 262   5                                              //nRemainingCapH = 0;  //LMLKBL0006:remove.
 263   5                                      }
 264   4                                      else
 265   4                                      {
 266   5                                              nRemainingCapL = Bat0x0FTempL;
 267   5                                              nRemainingCapH = Bat0x0FTempH;
 268   5                                      }
 269   4                              }
 270   3      
 271   3                      if(IS_MASK_SET(LENOVOPMFW_Temp,BATTERY_CYCLE_RUNNING))
 272   3                      {
 273   4                              CLEAR_MASK(LENOVOPMFW_Temp,BATTERY_CYCLE_RUNNING);
 274   4      
 275   4                              if(IS_MASK_SET(ACOFF_SOURCE,BATTLEARN))
 276   4                              {
 277   5                              CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
 278   5                                              BATT_LEN_OFF(); //add battery learn mode
 279   5                              // ACOFF_LOW();
 280   5                              }
 281   4                      }
 282   3      
 283   3                              //Mos: Clear BATTERY_CYCLE_fulchg when change to Longest Battery Mode
 284   3                      CLEAR_MASK(StatusKeeper, BatteryProtectCHG);
 285   3                              CLR_MASK(nStopChgStat3H,EmStopChgarg);
 286   3                      }
 287   2              }
 288   1      
 289   1      #else
              
                      if (IS_MASK_SET(LENOVOPMFW,BATTERY_STORAGE) && IS_MASK_CLEAR(LENOVOPMFW,BATTERY_MAIN_CAL)) //T075
                      {
                              //Mos: return RSOC(0x0d)=0 to BIOS if battery error
                              /* 
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 6   

                              if ((ChkBattery_abnormal_status == ChkBattery_abnormal_status_error)
                                      || (Chk_Trickle_Current_status == Chk_Trickle_Current_status_error))
                              {
                                      //nRemainingCapL = 0;
                                      //nRemainingCapH = 0;
                                      //Mos: Disable report RSOC(0x0d) = 0 to BIOS, need to modify spec
                                      nRemainingCapL = Bat0x0FTempL;
                                      nRemainingCapH = Bat0x0FTempH;
                              }
                              else
                              */              
                              {
                                      nRemainingCapL = Bat0x0FTempL;
                                      nRemainingCapH = Bat0x0FTempH;
                              }
              
                      SET_MASK(LENOVOPMFW_Temp,BATTERY_CYCLE_RUNNING);
              
                              if (nBattGasgauge > 60)
                              {
                                      SET_MASK(ACOFF_SOURCE, BATTLEARN);
                                      BATT_LEN_ON();  //add battery learn mode
                              
                              }
                              else if (nBattGasgauge >= 55 && nBattGasgauge <= 60)
                              {
                                      if ( IS_MASK_SET(ACOFF_SOURCE, BATTLEARN) )
                                      { 
                                              ECSMI_SCIEvent(ACPI_BAT1IN_SCI); 
                              }
                                      CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
                                      BATT_LEN_OFF(); //add battery learn mode
                                      // Change Status bit to avoid bit has been reset
                              if (IS_MASK_CLEAR(StatusKeeper, BatteryProtectCHG))
                              {
                              SET_MASK(nStopChgStat3H, EmStopChgarg);
                              }
                              else
                              {
                                      CLEAR_MASK(nStopChgStat3H, EmStopChgarg);
                              if (nBattGasgauge == 60)
                                      {
                                                      if (KeepBattRemineCap == 0)
                                                      { 
                                                              KeepBattRemineCap = (WORD)(nRemainingCapH << 8) + nRemainingCapL; 
                                      }
                                                      else
                                                      {
                                                              CalcBatRCC =(nFullChgCapH<<8)+nFullChgCapL; //ANGELAS101:Modify battery discharge when battery RSOC 
             -is 59% in storage mode.
                                                              //Mos: Avoid that stop charger but OS show god damn 59%...
                                                              //if (((WORD)(nRemainingCapH << 8) + nRemainingCapL) > (KeepBattRemineCap + 10))//ANGELAS101:Modify 
             -battery discharge when battery RSOC is 59% in storage mode.
                                                              if (((WORD)(nRemainingCapH << 8) + nRemainingCapL) > (KeepBattRemineCap + (CalcBatRCC/200)))//ANGELA
             -S101:Modify battery discharge when battery RSOC is 59% in storage mode.
                                                              {
                                                                      KeepBattRemineCap = 0;
                                                                      CLEAR_MASK(StatusKeeper, BatteryProtectCHG);
                                                                      ECSMI_SCIEvent(ACPI_BAT1IN_SCI); // Notify BIOS Update Batt Status
                                                              }
                                                      }
                                              }
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 7   

                              }
                                      //ACOFF_LOW();                                                                                  // charge
                              }
                              else if (nBattGasgauge < 55)
                              {
                                      CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
                                      BATT_LEN_OFF(); //add battery learn mode
                                      //Mos: Change Status bit to avoid bit has been reset
                              SET_MASK(StatusKeeper, BatteryProtectCHG);
                                      CLR_MASK(nStopChgStat3H,EmStopChgarg);
                                      //ACOFF_LOW();                                                                                  // charge       
                              }
                      }       
                      else 
                      {
                              //if (IS_MASK_SET(EC_BatteryStatusL,FullyChg)&&(IS_MASK_SET(SYS_STATUS,AC_ADP))) //MEILING025:remove.
                              if (IS_MASK_SET(EC_BatteryStatusL,FullyChg)&&(IS_MASK_SET(SYS_STATUS,AC_ADP))&&(nBattGasgauge==100)) //M
             -EILING025:add.
                              {
                                      nRemainingCapL = nFullChgCapL;
                                      nRemainingCapH = nFullChgCapH;
                              }
                              else
                              {
                                      //Mos: return RSOC(0x0d)=0 to BIOS if battery error
                                      if (ChkBattery_abnormal_status == ChkBattery_abnormal_status_error)
                                      {
                                              //nRemainingCapL = 0;  //LMLKBL0006:remove.
                                              //nRemainingCapH = 0;  //LMLKBL0006:remove.
                                      }
                                      else
                                      {
                                              nRemainingCapL = Bat0x0FTempL;
                                              nRemainingCapH = Bat0x0FTempH;
                                      }
                              }
              
                      if(IS_MASK_SET(LENOVOPMFW_Temp,BATTERY_CYCLE_RUNNING))
                      {
                              CLEAR_MASK(LENOVOPMFW_Temp,BATTERY_CYCLE_RUNNING);
              
                              if(IS_MASK_SET(ACOFF_SOURCE,BATTLEARN))
                              {
                              CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
                                              BATT_LEN_OFF(); //MosG25:add battery learn mode
                              // ACOFF_LOW();
                              }
                      }
              
                              //Mos: Clear BATTERY_CYCLE_fulchg when change to Longest Battery Mode
                      CLEAR_MASK(StatusKeeper, BatteryProtectCHG);
                              CLR_MASK(nStopChgStat3H,EmStopChgarg);
                      }
              
              #endif
 408   1      
 409   1      }
 410          
 411          void ChkLENOVOPMFW(void)
 412          {
 413   1              if (IS_MASK_SET(LENOVOPMFW,BATTERY_MAIN_CAL))                   // check Calibration Cycle enable
 414   1              {
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 8   

 415   2                      if (cBattFlag0.fbit.cBF0_FullToTarget == 0)
 416   2                      {
 417   3                              if (IS_MASK_CLEAR(LENOVOPMFW,BATTERY_CAL_END))
 418   3                              {
 419   4                                      cBattFlag0.fbit.cBF0_FullToTarget = 1;          // charge to 100% then discharge to 1%
 420   4                                      cBattFlag0.fbit.cBF0_Full = 0;
 421   4                                      cBattFlag0.fbit.cBF0_GoTarget = 0;
 422   4                                      cTargetGauge = 1;
 423   4                                      //CLR_MASK(LENOVOPMFW,BATTERY_CYCLE);
 424   4                              }
 425   3                      }
 426   2              }
 427   1              else if (IS_MASK_SET(LENOVOPMFW,BATTERY_CAL_END))
 428   1              {
 429   2                      CLR_MASK(LENOVOPMFW,BATTERY_CAL_END);
 430   2                      cBattFlag0.fbit.cBF0_FullToTarget = 0;
 431   2                      cBattFlag0.fbit.cBF0_Full = 0;
 432   2                      cBattFlag0.fbit.cBF0_GoTarget = 0;
 433   2              //Modify cancel the running of the gauge reset function, the battery can't resume charge. 
 434   2              CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
 435   2                      BATT_LEN_OFF(); 
 436   2                      //ACOFF_LOW();
 437   2              }
 438   1      }
 439          
 440          void ChkGoTarget(void)
 441          {
 442   1              if (cBattFlag0.fbit.cBF0_GoTarget ==1)
 443   1              {
 444   2                      if ((cTargetGauge == nBattGasgauge) ||  (nBattGasgauge < cTargetGauge))
 445   2                      {
 446   3                              CLEAR_MASK(ACOFF_SOURCE, BATTLEARN);
 447   3                              BATT_LEN_OFF(); //add battery learn mode
 448   3                              //ACOFF_LOW();                                                                                  // charge
 449   3                              cBattFlag0.fbit.cCmdAcOff = 0;
 450   3                              if (IS_MASK_SET(LENOVOPMFW,BATTERY_MAIN_CAL))
 451   3                              {
 452   4                                      SET_MASK(LENOVOPMFW,BATTERY_CAL_END);
 453   4                                      CLR_MASK(LENOVOPMFW,BATTERY_MAIN_CAL);
 454   4                      cTargetGauge=0;
 455   4                      SET_MASK(LENOVOPMFW_Temp,BATTERY_CALIBRATION_OK);   // release Calibration mode
 456   4                      uVPCeventSource = General;
 457   4                      uVPCeventSource2 = 0;
 458   4                      ECSMI_SCIEvent(SDV_VPC_notify);
 459   4                      ChkLENOVOPMFW();
 460   4                              }
 461   3                              return;
 462   3                      }
 463   2                      if (nBattGasgauge > cTargetGauge)
 464   2                      {
 465   3                              SET_MASK(ACOFF_SOURCE, BATTLEARN);
 466   3                              BATT_LEN_ON();  //add battery learn mode
 467   3                              //ACOFF_HI();           // discharge
 468   3                              cBattFlag0.fbit.cCmdAcOff = 1;
 469   3                      }
 470   2              }
 471   1              else if (cBattFlag0.fbit.cBF0_FullToTarget == 1)
 472   1              {
 473   2                      if (cBattFlag0.fbit.cBF0_Full ==0)
 474   2                      {
 475   3                              if (IS_MASK_SET(nBattery0x16L,FullyChg))
 476   3                              {
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 9   

 477   4                                      cBattFlag0.fbit.cBF0_Full=1;
 478   4                                      cBattFlag0.fbit.cBF0_GoTarget = 1;                                      // Discharge or Charge to cTargetGauge%
 479   4                              }
 480   3                      }
 481   2              }
 482   1      }
 483          
 484          void ChkS3ResumeRSOC(void)
 485          {
 486   1              /*if (IS_MASK_CLEAR(SYS_STATUS,AC_ADP))
 487   1              {
 488   1                      if ( SystemIsS3 )
 489   1                      {
 490   1                              if (nBattGasgauge <= S3ResumeRSOC)      // check battery under 5%. //martin0216: meet spec: Battery RSOC<6%,
             - and PC is in S3,System wakes up to S0 automatically(System wakes up from S3)
 491   1                              {
 492   1                                   PWSeqStep = 1;
 493   1                                      PowSeqDelay = 1;
 494   1                                RamDebug(0x31);       
 495   1                                   SysPowState=SYSTEM_S3_S0;
 496   1                              }
 497   1                      }
 498   1              }*///ANGELAS093:-Modify battery RSOC below 5% can't into S3.
 499   1              //ANGELAS093:s+Modify battery RSOC below 5% can't into S3.
 500   1              if(IS_MASK_SET(battery_critical,DCdischargeto5ins3))
 501   1              {
 502   2                      PWSeqStep = 1;
 503   2                      PowSeqDelay = 1;
 504   2              RamDebug(0x37);  
 505   2              SysPowState=SYSTEM_S3_S0;
 506   2                      CLEAR_MASK(battery_critical,DC0ver5enterS3);
 507   2                      CLEAR_MASK(battery_critical,DCdischargeto5ins3);
 508   2              }
 509   1              //ANGELAS093:s+Modify battery RSOC below 5% can't into S3.
 510   1      }
 511          //ANGELAS093:s+Modify battery RSOC below 5% can't into S3.
 512          void ChkS3DCRSOC(void)
 513          {
 514   1              if(SystemIsS3)
 515   1              {
 516   2                      if(nBattGasgauge != S3ResumeRSOC)
 517   2                      {
 518   3                              SET_MASK(battery_critical, DC0ver5enterS3);
 519   3                      }
 520   2                      else
 521   2                      {                       
 522   3                              if(IS_MASK_CLEAR(SYS_STATUS,AC_ADP)&&(nBattGasgauge== S3ResumeRSOC)&&IS_MASK_SET(battery_critical,DC0ve
             -r5enterS3))
 523   3                              {
 524   4                                      SET_MASK(battery_critical,DCdischargeto5ins3);  
 525   4                              }
 526   3                              else
 527   3                              {
 528   4                                      CLEAR_MASK(battery_critical,DCdischargeto5ins3);
 529   4                              }
 530   3                              //JIMGBRW025 CLEAR_MASK(battery_critical, DC0ver5enterS3);
 531   3                      }
 532   2              }
 533   1              else
 534   1              {
 535   2                      CLEAR_MASK(battery_critical, DC0ver5enterS3);
 536   2                      CLEAR_MASK(battery_critical,DCdischargeto5ins3);
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 10  

 537   2              }
 538   1      }
 539          //ANGELAS093:e+Modify battery RSOC below 5% can't into S3.
 540          //ANGELAS043:Add start
 541          void RSOC1Pto0P_ShutdownCheck(void)
 542          {
 543   1          if(IS_MASK_SET(SYS_STATUS,AC_ADP)||Read_AC_IN()||nBattGasgauge > 0x01||SystemNotS0)
 544   1          {
 545   2             RSOC1PTO0PCount = 0x00;
 546   2                 RSOC1PTO0PSaveSpace = 0x00;
 547   2          }
 548   1              else
 549   1              {
 550   2                 if(nBattGasgauge == 0x01)
 551   2                 {
 552   3                    SET_MASK(RSOC1PTO0PSaveSpace,RSOCIs1P);
 553   3                 }
 554   2                 else if((nBattGasgauge == 0x00)&&IS_MASK_SET(RSOC1PTO0PSaveSpace,RSOCIs1P))
 555   2                 {
 556   3                      if ( RSOC1PTO0PCount >= RSOC_Shut_Cnt ) // Read 30 times.
 557   3                      {
 558   4                                      ProcessSID(RSOC_1Pto0P_ID);  //Shutdown ID 0x40         
 559   4                      
 560   4                                  SET_MASK(SysStatus,ERR_ShuntDownFlag);      
 561   4                      
 562   4                                      RSOC1PTO0PCount = 0x00;
 563   4                          RSOC1PTO0PSaveSpace = 0x00;
 564   4                                      //SET_MASK(USB_Charger, b2USB_TmlDis);  // Disable USB charger.//72JERRY046:clear Unexpected power shut
             -down flag when power on.
 565   4                                      RSMRST_LOW();
 566   4                                      Delay1MS(1);
 567   4                                      RSMRST_HI();                            
 568   4                      }
 569   3                      else
 570   3                      { 
 571   4                          RSOC1PTO0PCount++; 
 572   4                              }
 573   3                 }
 574   2              }
 575   1      }
 576          //ANGELAS043:Add end
 577          void RSMRST_shutdown(void)                                      //shutdown (RSMRST HI-->low-->HI)
 578          
 579          {
 580   1              RSMRST_LOW();                                   //shutdown (remark first)
 581   1              Delay1MS(1);
 582   1              RSMRST_HI();
 583   1              RSMshutdownCnt++;
 584   1      }
 585          
 586          void DownBatteryPState()
 587          {
 588   1              if ((cBATTThrottling !=0)&&(BatteryAlarm == 0)&&(0x00==ADPIDON10MS_NUM)) //add ADPIDON10MS_NUM judge.
 589   1                      cBATTThrottling--;
 590   1      }
 591          
 592          void UpBatteryPState()
 593          {
 594   1              //if (cBATTThrottling != 0x0F)
 595   1              if (cBATTThrottling != PSTATE_MAXStep)//0ptimize CPU P_state (change 16 step to 8 step).
 596   1                      cBATTThrottling++;
 597   1      }
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 11  

 598          
 599          //MEILING055:S+ decrease GPU throttling every 2s after PnP AC.
 600          void DownACtoBatteryGPUState()
 601          {
 602   1              if((cGPUACtoBattThrottling !=0)&&(cGPUACtoBattTime==0))
 603   1              {
 604   2                      if(IS_MASK_SET(SYS_STATUS,AC_ADP))
 605   2                      {
 606   3                              cGPUACtoBattThrottling=0;
 607   3                      }
 608   2                      else
 609   2                      {
 610   3                              cGPUACtoBattThrottling--;
 611   3                              cGPUACtoBattTime = 4;//2s to do an action
 612   3                              //ANGELAG017: add start
 613   3                              if((nBattGasgauge > 20) && (cGPUACtoBattThrottling == 1))
 614   3                              {
 615   4                                      cGPUACtoBattThrottling=0;
 616   4                                      cGPUACtoBattTime = 0;  ///////2s to do an action
 617   4                              }
 618   3                              else if((nBattGasgauge <= 20) && (cGPUACtoBattThrottling == 2))
 619   3                              {
 620   4                                      cGPUACtoBattThrottling=0;
 621   4                                      cGPUACtoBattTime = 0;  ///////2s to do an action
 622   4                              }
 623   3                              ////ANGELAG017: add end
 624   3                      }
 625   2              }
 626   1      }
 627          //MEILING055:E+.
 628          
 629          //MEILING033:add start CPU prochot control function.
 630          void CPUProchotCtrl()
 631          {
 632   1      if(IS_MASK_CLEAR(Thro_Status, b0ProCH_CPU)&&IS_MASK_CLEAR(Thro_Status2, b3Batt_OTP+b7ProCH_Psys)&&(CPUProc
             -hotONCnt == 0))
 633   1              //if ( IS_MASK_CLEAR(Thro_Status, (b0ProCH_CPU+b1ProCH_VGA+b2ProCH_EXTVGA+b6ProCH_TURBO+b7ProCH_BATT))
 634   1                      //&&IS_MASK_CLEAR(Thro_Status2, (b3Batt_OTP+b5Bat_5PProtect+b6BattRSOC_Low+b7ProCH_ADP))
 635   1                      //&&IS_MASK_CLEAR(LENOVOBATT2, (BATTERY_OCP))  //ANGELAG017: add
 636   1                      //&&IS_MASK_CLEAR(nBatteryStatH, CMBS_CRITICALLOW)&&(CPUProchotONCnt == 0)) //MEILING055:modify ProchotO
             -NCnt name.//72JERRY048:Remove throttling prochot.
 637   1              {       // turn off prochot.  //MEILING033:add prochot on 2S when AC out and battery over temperatrue and batte
             -ry RSOC low.
 638   2                  H_PROCHOT_OFF(); 
 639   2                  nRealThermalPinDIS;
 640   2                  CLR_MASK(pPROCHOT, b0Thermal_PRCOHOTon);    // for AP display.
 641   2              }
 642   1              else
 643   1              {       // turn on prochot.
 644   2                  H_PROCHOT_ON();
 645   2                  nRealThermalPinEN;
 646   2                      SET_MASK(pPROCHOT, b0Thermal_PRCOHOTon);        // for AP display.
 647   2              }     
 648   1      }
 649          //MEILING033:add end.
 650          
 651          void ChkBattery_OTP()
 652          {
 653   1              ITempW01 = (WORD)((EC_oCBTh<<8)+EC_oCBTl);              // get temperature
 654   1              if (ITempW01 > 2730)
 655   1              {
 656   2                      nBattAverTemp = (ITempW01 - 2730) / 10;
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 12  

 657   2              }
 658   1              else
 659   1              {
 660   2                      return;
 661   2              }
 662   1      
 663   1              //LMLKBL0012:S+ add battery OTP shutdown protect in AC mode.
 664   1              if((SystemIsS0)&&(nBattAverTemp >= BatteryOTPShutdown))  //65
 665   1              {
 666   2                      #if !EN_PwrSeqTest
 667   2              SET_MASK(SysStatus,ERR_ShuntDownFlag);//Add battery over temperature protect.
 668   2                      ProcessSID(BATTOVERTEMP_ID);
 669   2                      RSMRST_shutdown();
 670   2                      #endif
 671   2              }
 672   1              //LMLKBL0012:E+.
 673   1              
 674   1              //if ((SystemIsS0)&&(IS_MASK_CLEAR(SYS_STATUS,AC_ADP)))     
 675   1              if ((SystemIsS0)&&(IS_MASK_SET(nBatteryStatH,CMBS_DISCHARGE)))     
 676   1              {
 677   2                      //LMLKBL0012:S-.
 678   2                      /*if(nBattAverTemp >= BatteryOTPShutdown)  //65
 679   2                      {
 680   2                              #if !EN_PwrSeqTest
 681   2                              SET_MASK(SysStatus,ERR_ShuntDownFlag);//Add battery over temperature protect.
 682   2                              ProcessSID(BATTOVERTEMP_ID);
 683   2                              RSMRST_shutdown();
 684   2                              #endif
 685   2                      }*/
 686   2                      //LMLKBL0012:E-.
 687   2                      
 688   2                      if (nBattAverTemp >= BatteryOTP)                                // 60
 689   2                      {
 690   3                              SET_MASK(nStopChgStat3L,ENOVERTEMP);
 691   3                              SET_MASK(BatteryAlarm,BATOTP);
 692   3                              //UpBatteryPState();  //MEILING048:remove.//MEILING051:-Add cpu P_STATE function.
 693   3                              //nRemainingCapL = 0;  //LMLKBL0003:remove.
 694   3                              //nRemainingCapH = 0;  //LMLKBL0003:remove.
 695   3      
 696   3                              //MEILING033:add start prochot on and dGPU throttling set D5.
 697   3                              cGPUBattOTPThrottling = 4;
 698   3                  SET_MASK(Thro_Status2, b3Batt_OTP);
 699   3                              SET_MASK(GPU_Prochot, b3_battery_OTP);
 700   3                              //MEILING033:add end.
 701   3      
 702   3                              //MEILING033:remove start.
 703   3                              /*if (nBattOvrTempCnt > 80)                                     // 2 min
 704   3                              {
 705   3                                      #if !EN_PwrSeqTest
 706   3                                      SET_MASK(SysStatus,ERR_ShuntDownFlag);//Add battery over temperature protect.
 707   3                                      ProcessSID(BATTOVERTEMP_ID);
 708   3                                      RSMRST_shutdown();
 709   3                                      #endif
 710   3                              }
 711   3                              else
 712   3                                      nBattOvrTempCnt ++;*/
 713   3                              //MEILING033:remove end.
 714   3                              
 715   3                      }
 716   2      
 717   2                      else if (nBattAverTemp < BatteryOTPRelease)                     //58
 718   2                      {
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 13  

 719   3                              CLR_MASK(BatteryAlarm,BATOTP);
 720   3                              CLR_MASK(nStopChgStat3L,ENOVERTEMP);
 721   3                              //nBattOvrTempCnt =0;  //MEILING033:remove.
 722   3      
 723   3                              //MEILING033:add start prochot off and dGPU throttling set D1.
 724   3                              cGPUBattOTPThrottling = 0; 
 725   3                  CLEAR_MASK(Thro_Status2, b3Batt_OTP);
 726   3                              CLR_MASK(GPU_Prochot, b3_battery_OTP);
 727   3                              //MEILING033:add end.
 728   3                              
 729   3                      }
 730   2              }
 731   1              else
 732   1              {
 733   2                      CLR_MASK(BatteryAlarm,BATOTP);
 734   2                      CLR_MASK(nStopChgStat3L,ENOVERTEMP);
 735   2                      CLEAR_MASK(Thro_Status2, b3Batt_OTP); //MEILING033:add.
 736   2                      cGPUBattOTPThrottling = 0; //MEILING033:add dGPU throttling to D1.
 737   2                      CLR_MASK(GPU_Prochot, b3_battery_OTP); 
 738   2                      //nBattOvrTempCnt =0;  //MEILING033:remove.
 739   2              }
 740   1      }
 741          
 742          //T069 + s
 743          //////////////////////////////////////////////////////
 744          // check battery out power over 28W
 745          //////////////////////////////////////////////////////
 746          void ChkBattery_OverConsumption()  //MEILING033:modify function name.
 747          {
 748   1          WORD BattPresentVolt; 
 749   1              WORD BattNowCurrent; 
 750   1          BYTE Power_Temp;
 751   1          
 752   1              if ((!Read_AC_IN()) || (IS_MASK_SET(CHGIC_ReadCmd0x12L,BatLearnEnable))) //MEILING033:add learn mode cond
             -ition.
 753   1              { 
 754   2              if (nNowCurrentH & 0x80)
 755   2                      {                  
 756   3                          BattNowCurrent=0xFFFF - (WORD)((nNowCurrentH<<8)+nNowCurrentL);
 757   3                  BattPresentVolt = (WORD)((nPresentVoltH << 8) + nPresentVoltL);
 758   3                  Power_Temp=(BYTE) ((BattPresentVolt*0.1/100) *( BattNowCurrent*0.1/100));     
 759   3                  Chk_Hybrid_STPP_Batt_Output_Power =(LWORD)( Power_Temp*1000000 /292968.75);  
 760   3                              XWTemp1 = 0xFFFF - (WORD)((nNowCurrentH<<8)+nNowCurrentL);
 761   3                              
 762   3                              //MEILING049:S+Modify power limit under DC mode to improve performance follow EC v16.
 763   3                  if(Power_Temp >= SysPower_ProchotOn) //MEILING033:change 45W to 28W.
 764   3                  {  
 765   4                      cGPUBattThrottling = 4; //MEILING033:add dGPU throttling to D5.
 766   4                      SET_MASK(Thro_Status, b7ProCH_BATT); 
 767   4                              }
 768   3                              //MEILING042:S+ add GPU throttling according to system consumption.
 769   3                              else if( (Power_Temp < SysPower_ProchotOn) && (Power_Temp >= SysPower_GPUThrottling) )
 770   3                              {
 771   4                                      //MEILING050:s+Distinguish between 310 or 510.
 772   4                                      if(IS_MASK_SET(pProject0,b7GSKL310OR510))//310
 773   4                                      {
 774   5                                              cGPUBattThrottling = 2; 
 775   5                                              cBATTThrottling = 9;//MEILING051:Add cpu P_STATE function.
 776   5                                      }
 777   4                                      else
 778   4                                      {
 779   5                                              cGPUBattThrottling = 3; 
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 14  

 780   5                                              cBATTThrottling = 7;//MEILING053:add.
 781   5                                      }
 782   4                      CLR_MASK(Thro_Status, b7ProCH_BATT);
 783   4                                      //MEILING050:e+Distinguish between 310 or 510.
 784   4                              }
 785   3                              else if( (Power_Temp < SysPower_GPUThrottling) && (Power_Temp >= SysPower_ProchotOff) )
 786   3                              {
 787   4                                      //MEILING050:s+Distinguish between 310 or 510.
 788   4                                      if(IS_MASK_SET(pProject0,b7GSKL310OR510))
 789   4                                      {
 790   5                                              cGPUBattThrottling = 1; 
 791   5                                              cBATTThrottling = 0; //MEILING053:add.
 792   5                                      }
 793   4                                      else
 794   4                                      {
 795   5                                              cGPUBattThrottling = 2; 
 796   5                                              cBATTThrottling = 0; //MEILING053:add.
 797   5                                      }
 798   4                      CLR_MASK(Thro_Status, b7ProCH_BATT);
 799   4                                      //MEILING050:e+Distinguish between 310 or 510.
 800   4                              }
 801   3                              //MEILING042:E+.
 802   3                  else if(Power_Temp < SysPower_ProchotOff)  //MEILING033:change 35W to 20W.
 803   3                  { 
 804   4                      cGPUBattThrottling = 0; //MEILING033:add dGPU throttling to D1.
 805   4                      cBATTThrottling = 0; //MEILING051:Add cpu P_STATE function.
 806   4                      CLR_MASK(Thro_Status, b7ProCH_BATT); 
 807   4                              }
 808   3              }       
 809   2              }
 810   1              else
 811   1              {
 812   2                      cGPUBattThrottling = 0; //MEILING033:add dGPU throttling to D1.
 813   2                      cBATTThrottling = 0; //MEILING053:add.
 814   2              CLR_MASK(Thro_Status, b7ProCH_BATT);
 815   2              }
 816   1      }
 817          //MEILING049:E+Modify power limit under DC mode to improve performance follow EC v16.
 818          
 819          void ChkBattery_OCP()
 820          {
 821   1      //ANGELAG017: remove start
 822   1      /*      if (!Read_AC_IN())
 823   1              {
 824   1                      if (nNowCurrentH & 0x80)
 825   1                      {
 826   1                              XWTemp1 = 0xFFFF - (WORD)((nNowCurrentH<<8)+nNowCurrentL);
 827   1      
 828   1                              if (XWTemp1 > OCPCapacity)
 829   1                              {
 830   1                                      SET_MASK(BatteryAlarm,BATOCP);
 831   1                                      //UpBatteryPState();  //MEILING048:remove.//MEILING051:-Add cpu P_STATE function.
 832   1                              }
 833   1                              if (XWTemp1 < OCPCapacityRelease)
 834   1                              {
 835   1                                      CLR_MASK(BatteryAlarm,BATOCP);
 836   1                              }
 837   1                      }
 838   1              }
 839   1              else
 840   1              {
 841   1                      CLR_MASK(BatteryAlarm,BATOCP);
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 15  

 842   1              }*/
 843   1              //ANGELAG017: remove end
 844   1              ////ANGELAG017: add start
 845   1              if ((SystemIsS0) && (!Read_AC_IN()))
 846   1              {
 847   2                      if (Bat0x00TempL&0x20)                          // 0x00  bit5
 848   2                      { 
 849   3                              BatteryOCPDelay=10; //last at least 1s
 850   3                              cGPUBattOCPThrottling = 4; //set DGPU D5
 851   3                          SET_MASK(LENOVOBATT2,BATTERY_OCP); //battery OCP CPU prochot
 852   3                      }
 853   2                      else
 854   2                      { 
 855   3                              if(BatteryOCPDelay==0)
 856   3                              {
 857   4                                      cGPUBattOCPThrottling = 0; //set DGPU D1
 858   4                                      CLR_MASK(LENOVOBATT2,BATTERY_OCP); 
 859   4                              }
 860   3                      }
 861   2              }
 862   1              else
 863   1              {
 864   2                      if(BatteryOCPDelay==0)
 865   2                      {
 866   3                              cGPUBattOCPThrottling = 0; //set DGPU D1
 867   3                              CLR_MASK(LENOVOBATT2,BATTERY_OCP); 
 868   3                      }
 869   2              }
 870   1              //ANGELAG017: add end
 871   1      }
 872          
 873          
 874          void ChkBattery_LowVoltage()
 875          {
 876   1          WORD CV1,CV2,CV3,CV4;
 877   1              
 878   1              if (!Read_AC_IN())
 879   1              {
 880   2                      if (nNowCurrentH & 0x80)
 881   2                      {
 882   3                              if(bRSMBusBlock(SMbusChB, SMbusRBK, SmBat_Addr, C_Mdata, &BAT1_MD_1))
 883   3                  {
 884   4                                      
 885   4                              CV4 = (BAT1_MD_6 << 8)+BAT1_MD_5;   // Get Main battery desgin voltage   //MEILING016:remove.  //ME
             -ILING017:add.
 886   4                              CV3 = (BAT1_MD_8 << 8)+BAT1_MD_7;   // Get Main battery desgin voltage   //MEILING016:remove.  /
             -/MEILING017:add.
 887   4                              CV2 = (BAT1_MD_A << 8)+BAT1_MD_9;   // Get Main battery desgin voltage  //MEILING016:change CV3 
             -to CV2.  
 888   4                              CV1 = (BAT1_MD_C << 8)+BAT1_MD_B;   // Get Main battery desgin voltage  //MEILING016:change CV4 
             -to CV1.  
 889   4                              //if ((CV1 < 3000) || (CV2 < 3000) || (CV3 < 3000) || (CV4 < 3000) )  //change 4th && to ||  //M
             -EILING016:remove.
 890   4                                      //if ((CV1 < 3000) || (CV2 < 3000)) //MEILING016:add.  //MEILING017:remove.
 891   4                                      if ((CV1 < 3000) || (CV2 < 3000) || ((CellCount>=3) && (CV3 < 3000)) || ((CellCount==4) && (CV4 < 3000
             -)) ) //MEILING017: add
 892   4                                      {
 893   5                                              if(SystemIsS0)
 894   5                          {
 895   6                              RamDebug(0xB1);
 896   6                              //ECQEvent(0x27);                              
 897   6                              SET_MASK(nBatteryStatH, CMBS_CRITICALLOW);                            
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 16  

 898   6                          }            
 899   5                                      }
 900   4                      else
 901   4                      {
 902   5                              CLR_MASK(nBatteryStatH, CMBS_CRITICALLOW);  
 903   5                      }
 904   4       
 905   4      
 906   4                              //if ((CV1 < 3300) || (CV2 < 3300) || (CV3 < 3300) || (CV4 < 3300) )  //MEILING017:remove.
 907   4                              if ((CV1 < 3000) || (CV2 < 3000) || ((CellCount>=3) && (CV3 < 3000)) || ((CellCount==4) && (CV4 
             -< 3000)) ) //MEILING017: add
 908   4                                      {
 909   5                                              SET_MASK(BatteryAlarm,BATLOWVOL);
 910   5                                              //UpBatteryPState();  //MEILING048:remove.//MEILING051:-Add cpu P_STATE function.
 911   5                                      }
 912   4                      else 
 913   4                                      {
 914   5                                              CLR_MASK(BatteryAlarm,BATLOWVOL);
 915   5                                      }      
 916   4                  }   
 917   3                      }
 918   2              }
 919   1              else
 920   1              {
 921   2                      CLR_MASK(BatteryAlarm,BATLOWVOL);
 922   2              CLR_MASK(nBatteryStatH, CMBS_CRITICALLOW);     
 923   2              }
 924   1      }
 925          
 926          
 927          //MEILING033: add start check battery RSOC low function.
 928          void CkkBattery_RSOCLow()
 929          {
 930   1              if ((!Read_AC_IN()) || (IS_MASK_SET(CHGIC_ReadCmd0x12L,BatLearnEnable)))
 931   1              {
 932   2                      if(nBattGasgauge < BattRSOC_ProchotOn) //turn on prochot and dGPU throttling to D5.
 933   2                      {
 934   3                              cGPUBattLowThrottling = 4; //ANGELAG013: D4 to D5 //MEILING055:change D5 to D4.
 935   3                              //cBATTLowThrottling=7; //ANGELAG013: remove //MEILING055:add.
 936   3                  //SET_MASK(Thro_Status2, b6BattRSOC_Low);   //MEILING039:add.
 937   3                      }
 938   2                      else if(nBattGasgauge >= BattRSOC_ProchotOn) //turn off prochot and dGPU throttling to D1.
 939   2                      {
 940   3                              cGPUBattLowThrottling = 0; 
 941   3                  //CLEAR_MASK(Thro_Status2, b6BattRSOC_Low);  //MEILING039:add.
 942   3                      }
 943   2              }
 944   1              else
 945   1              {
 946   2                      cGPUBattLowThrottling = 0; 
 947   2                      cBATTLowThrottling=0; //MEILING055:add.
 948   2              //CLEAR_MASK(Thro_Status2, b6BattRSOC_Low);  //MEILING039:add.
 949   2              }
 950   1      }
 951          //MEILING033:add end.
 952          
 953          void ChkBattery_FCCchg()
 954          {
 955   1              ChkBattery_FCCchg_count++;
 956   1              if (ChkBattery_FCCchg_count >= 100) //Mos: 10 Sec(100ms 100times)
 957   1              {
 958   2                      ChkBattery_FCCchg_count = 0;
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 17  

 959   2                      ChkBattery_FCCchg_count2++;
 960   2                      if(ChkBattery_FCCchg_count2 < 30)
 961   2                      {
 962   3                        return;
 963   3                      }
 964   2                      ChkBattery_FCCchg_count2 = 0x00;
 965   2                      //Mos: Load default
 966   2                      if ((ChkBattery_FCCchg_lastFCCL == 0) && (ChkBattery_FCCchg_lastFCCH == 0))
 967   2                      {
 968   3                              ChkBattery_FCCchg_lastFCCL = nFullChgCapL;
 969   3                              ChkBattery_FCCchg_lastFCCH = nFullChgCapH;
 970   3                      }
 971   2      
 972   2                      //Mos: Check FCC and Notify OS if FCC change for each 10 sec
 973   2                      if ((ChkBattery_FCCchg_lastFCCL != nFullChgCapL)
 974   2                              || (ChkBattery_FCCchg_lastFCCH != nFullChgCapH))//change "&&" to "||"
 975   2                      {
 976   3                              ECSMI_SCIEvent(ACPI_BAT1IN_SCI);
 977   3                              ChkBattery_FCCchg_lastFCCL = nFullChgCapL;
 978   3                              ChkBattery_FCCchg_lastFCCH = nFullChgCapH;
 979   3                      }
 980   2              }
 981   1      }
 982          
 983          void ChkAvgCurrent()
 984          {
 985   1              //Mos: Modify for meet specification
 986   1              //Average current report to OS
 987   1              //Timer<=60 seconds(The timer starts counting when AC adapter plug out.)
 988   1              //Report "0x00" to EC name space 0xd2, 0xd3 by one time, and then
 989   1              //Report battery Current(0x0a) to EC name space 0xd2, 0xd3
 990   1              //Reset condition:When Timer>60 seconds,Report battery AverageCurrent(0x0b) to EC name space 0xd2, 0xd3
 991   1              if (Bat0x0BTempH & 0x80)
 992   1              {
 993   2                      XWTemp1 = 0xFFFF - (WORD)((Bat0x0BTempH<<8)+Bat0x0BTempL);      
 994   2                      if (XWTemp1 < 400)
 995   2                      {
 996   3                              return;
 997   3                      }
 998   2              }       
 999   1              // Filter the dirty data because when AC not exit, there will only be discharge current.
1000   1              if(IS_MASK_CLEAR(SYS_STATUS,AC_ADP) && SystemIsS0 && IS_MASK_CLEAR(Bat0x0BTempH,BIT7)) //change 'nNowCu
             -rrentH' to 'Bat0x0BTempH'
1001   1          {
1002   2         
1003   2               if(IS_MASK_SET(nNowCurrentH,BIT7))
1004   2              {
1005   3                   nAvgCurrentL = nNowCurrentL;
1006   3                           nAvgCurrentH = nNowCurrentH;
1007   3              }                
1008   2              return;
1009   2          }
1010   1              // Filter the dirty data because when AC not exit, there will only be discharge current.
1011   1              if ( Bat0x0BFakeCnt == 0)
1012   1              {
1013   2                      nAvgCurrentL = Bat0x0BTempL;
1014   2                      nAvgCurrentH = Bat0x0BTempH;
1015   2              }
1016   1              else if(Bat0x0BFakeCnt < 60)
1017   1              {
1018   2                      nAvgCurrentL = nNowCurrentL;
1019   2                      nAvgCurrentH = nNowCurrentH;
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 18  

1020   2              }
1021   1              else if(Bat0x0BFakeCnt == 60)
1022   1              {
1023   2                      nAvgCurrentL = 0;
1024   2                      nAvgCurrentH = 0;
1025   2              }
1026   1      }
1027          
1028          void RST_ChgTimeOutCnt(void)
1029          {
1030   1              TrickleChgTimeOutCnt = 0;
1031   1              FastChgTimeOutCnt = 0;
1032   1              CLEAR_MASK(nStopChgStat3L,ENSTOPCHG);
1033   1              CLEAR_MASK(nStopChgStat3H,ENTRITIMEOUT); //MARTINO006:change 'nStopChgStat3L' to 'nStopChgStat3H'
1034   1      }
1035          
1036          void Battery100ms(void)
1037          {
1038   1              if (inhibit2sec!=0)
1039   1                      inhibit2sec--;
1040   1              else
1041   1                      CLEAR_MASK(nStopChgStat3L,ENCHARGESUSP);                // use for detect battery charging suspend
1042   1      }
1043          void ChkPsys(void) // HEGANGS006Modify protect setting
1044          {
1045   1              if(Read_AC_IN()) // HEGANGS032:Modify power setting 
1046   1              {
1047   2                      if(nBattGasgauge>=5)
1048   2                      cGPUBattThrottling = 0;
1049   2                      else
1050   2                      cGPUBattThrottling = 2;
1051   2                      return;
1052   2              }
1053   1              if(Proch_Delay1>0)
1054   1              Proch_Delay1--;
1055   1              if(Proch_Delay1>10)
1056   1              Proch_Delay1=10;        
1057   1              if ((SystemIsS0) && (!Read_AC_IN()) && (cGPUACtoBattTime == 0))         //DC Mode
1058   1              {
1059   2                      //if(uMBGPU&0x02)//DIS
1060   2                      if(CellCount==2)
1061   2                      {
1062   3                              if (nBattGasgauge > 20)
1063   3                              {
1064   4                                      if (Psys_AvgData >= 403) //1.26V  63W //1.18 = 403
1065   4                                      {       
1066   5                                              SET_MASK(GPU_Prochot, b1_Psys);  // D5
1067   5                                              SET_MASK(Thro_Status2, b7ProCH_Psys);
1068   5                                              Proch_Delay1=10;
1069   5                                      }
1070   4                                      else if ((Psys_AvgData >= 355) && (Psys_AvgData < 403)) //54W--63W 
1071   4                                      {
1072   5                                              if(Proch_Delay1==0)
1073   5                                                      {
1074   6                                              cGPUBattThrottling = 3;         //D4
1075   6                                              CLR_MASK(GPU_Prochot, b1_Psys); 
1076   6                                              CLR_MASK(Thro_Status2, b7ProCH_Psys);
1077   6                                                      }
1078   5                                      }
1079   4                                      else if(Psys_AvgData < 355)   //less than 54W, 1.08V   //1.04
1080   4                                      {
1081   5                                              if(Proch_Delay1==0)
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 19  

1082   5                                                      {
1083   6                                              cGPUBattThrottling = 2; //D3
1084   6                                              CLR_MASK(GPU_Prochot, b1_Psys);
1085   6                                              CLR_MASK(Thro_Status2, b7ProCH_Psys);
1086   6                                              }
1087   5                                      }
1088   4                              }
1089   3                              else if (nBattGasgauge > 7)     //7%-20%
1090   3                              {
1091   4                                      if (Psys_AvgData >= 410) //1.26V  63W(1.26*1024/3=430) //1.2
1092   4                                      {
1093   5                                              SET_MASK(GPU_Prochot, b1_Psys); //D5
1094   5                                              SET_MASK(Thro_Status2, b7ProCH_Psys);
1095   5                                      }
1096   4                                      else if(Psys_AvgData < 403)     //54W, 1.08V //1.18
1097   4                                      {
1098   5                                              cGPUBattThrottling = 3; //D4
1099   5                                              CLR_MASK(GPU_Prochot, b1_Psys);
1100   5                                              CLR_MASK(Thro_Status2, b7ProCH_Psys);
1101   5                                      }
1102   4                              }
1103   3                              else            //0%-7%
1104   3                              {
1105   4                                      cGPUBattThrottling = 4; //D5
1106   4                                      SET_MASK(GPU_Prochot, b1_Psys); 
1107   4                                      if (Psys_AvgData >= 246)    //36W
1108   4                                      {
1109   5                                              SET_MASK(Thro_Status2, b7ProCH_Psys);
1110   5                                      }
1111   4                                      else if(Psys_AvgData < 246)     
1112   4                                      {
1113   5                                              CLR_MASK(Thro_Status2, b7ProCH_Psys);
1114   5                                      }
1115   4                              }
1116   3                      }
1117   2                      //else if(uMBGPU&0x01)//UMA
1118   2                      else if(CellCount==3)
1119   2                      {
1120   3                              if (Psys_AvgData >= 314)    //0.96v 48w //0.9=307 //314 0.92 46w
1121   3                              {
1122   4                                      SET_MASK(GPU_Prochot, b1_Psys); 
1123   4                                      SET_MASK(Thro_Status2, b7ProCH_Psys);
1124   4                              }
1125   3                              else if(Psys_AvgData < 273)     //0.84 42w //0.8=273
1126   3                              {
1127   4                                      CLR_MASK(GPU_Prochot, b1_Psys);
1128   4                                      CLR_MASK(Thro_Status2, b7ProCH_Psys);
1129   4                              }
1130   3                      }
1131   2              }
1132   1              else
1133   1              {
1134   2                      cGPUBattThrottling= 0;
1135   2                      CLR_MASK(GPU_Prochot, b1_Psys);
1136   2                      CLR_MASK(Thro_Status2, b7ProCH_Psys);
1137   2              }
1138   1      
1139   1      }
1140          void TurboDCOnly(void) 
1141          {
1142   1              if ((SystemIsS0) && (!Read_AC_IN())) //HEGANGS013:Modify  cpu turbo setting
1143   1              {
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 20  

1144   2                      if (nBattGasgauge >= 70)
1145   2                      {
1146   3                              if (VGA_TBuff3 >= 51)                           // Check turbo resume.
1147   3                              { 
1148   4                                      SET_MASK(Thro_Status, b6Turbo_DC_CPU);
1149   4                              }
1150   3                              else if(VGA_TBuff3 < 47)
1151   3                              {
1152   4                                      CLR_MASK(Thro_Status, b6Turbo_DC_CPU); 
1153   4                              }
1154   3                      }
1155   2                      else
1156   2                      {
1157   3                              if((VGA_TBuff3 >= 51)||(TEMP_Buff_3>=65))               // Check turbo Off.
1158   3                              { 
1159   4                                      SET_MASK(Thro_Status, b6Turbo_DC_CPU);
1160   4                              }
1161   3                              else if((VGA_TBuff3 < 47)&&(TEMP_Buff_3 < 60))
1162   3                              {
1163   4                                      CLR_MASK(Thro_Status, b6Turbo_DC_CPU); 
1164   4                              }
1165   3                      }
1166   2              }
1167   1              else
1168   1              {
1169   2                      CLR_MASK(Thro_Status,b6Turbo_DC_CPU); 
1170   2              }
1171   1              if ( IS_MASK_CLEAR(Thro_Status, b3Turbo_CPU+b6Turbo_DC_CPU ))
1172   1              {
1173   2                      if ( IS_MASK_SET(uVGATurboFun,uDisCPUTurboOK) )         
1174   2                      {
1175   3                              CLR_MASK(uVGATurboFun, uDisCPUTurboOK); 
1176   3                  ECQEvent(EN_CPUTURBO_67);  
1177   3                      }
1178   2              }
1179   1              else
1180   1              {
1181   2                      if ( IS_MASK_CLEAR(uVGATurboFun,uDisCPUTurboOK) )       // bit3.
1182   2                      {
1183   3                              SET_MASK(uVGATurboFun, uDisCPUTurboOK);                 // Set bit3. 
1184   3                  ECQEvent(DIS_CPUTURBO_66);  
1185   3                      }
1186   2              }
1187   1      }
1188          void Battery1Sec(void)
1189          {
1190   1              //DownBatteryPState();  //MEILING048:remove.//MEILING051:-Add cpu P_STATE function.
1191   1              if (Bat0x0BFakeCnt != 0)
1192   1                      Bat0x0BFakeCnt--;
1193   1      
1194   1              if (BatSMbusFailCount != 0)
1195   1              {
1196   2              SET_MASK(Bat1_FPChgFlag,BIT(0));
1197   2              nBattErrorCnt++;
1198   2              if (nBattErrorCnt > 250)
1199   2                      nBattErrorCnt = 251;
1200   2              if (BatSMbusFailCount > 220)
1201   2                      BatSMbusFailCount = 221;
1202   2              }
1203   1              else
1204   1              {
1205   2                      nBattErrorCnt = 0;
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 21  

1206   2                      if (nNowCurrentL|nNowCurrentH)                  // if  nNowCurrent != 0
1207   2                      {
1208   3                              if ((nNowCurrentH&0x80) == 0)           // nNowCurrent > 0, charging
1209   3                              {                                                               //current(0x0A)>0mA&polling time10cycles
1210   4                                      nBattTempCnt ++;
1211   4                                      if (nBattTempCnt >= 10)
1212   4                                              nBattTempCnt = 11;                      // nBattTempCnt > 10
1213   4                              }
1214   3                              else                                                            // discharging
1215   3                              {
1216   4                                      nBattTempCnt = 0;
1217   4                                      RST_ChgTimeOutCnt();
1218   4                              }
1219   3                      }
1220   2                      else
1221   2                      {
1222   3                              nBattTempCnt = 0;
1223   3                      }
1224   2              }
1225   1      }
1226          
1227          
1228          const sRSmbusBStruct code ABatCommandTable [] =
1229          {//     command               REG                      no.
1230                  { C_Date,               &nManufactureDateL              ,0x00},                         //Batpollstep1 = 0      WORD
1231                  { C_Dchem,              &batteryChemistry               ,0x04},                         //Batpollstep1 = 1      BLOCK
1232                  { C_Mname,              &BATTMANUFACTURE                ,0x0A},                         //Batpollstep1 = 2      BLOCK
1233                  { C_Dname,              &BATTDEVICENAME                 ,0x0A},                         //Batpollstep1 = 3              BLOCK
1234                  { C_OpMfgFun5,  &BAT1_Bar_Code          ,0x0A},             //Batpollstep1 = 4       BLOCK  //MEILING031:
             -add. 
1235                  { C_Date,               &nManufactureDateL              ,0x00},                         //Batpollstep1 = 5      WORD
1236                  { C_DCap,           &nDesignCapL                        ,0x00},                         //Batpollstep1 = 6      WORD    0~8 initial only
1237                  { C_DVolt,              &nDesignVoltL                   ,0x00},                         //Batpollstep1 = 7      WORD
1238                  { C_SerialNo,   &nSerialNumL                    ,0x00},                         //Batpollstep1 = 8      WORD
1239                  { C_mode,               &EC_C_modeL                             ,0x00},                         //Batpollstep1 = 9              WORD
1240                  { C_ChargingV,  &nChargingVoltL                 ,0x00},                         //Batpollstep1 = 10     WORD
1241                  { C_CycleCount, &EC_oCCBQl                              ,0x00},                         //Batpollstep1 = 11     WORD
1242                  { C_volt,               &nPresentVoltL                  ,0x00},                         //Batpollstep1 = 12     WORD
1243                  { C_current,    &nNowCurrentL                   ,0x00},                         //Batpollstep1 = 13     WORD
1244                  { C_ChargingI,  &nBattCharCurrentL      ,0x00},                         //Batpollstep1 = 14     WORD
1245                  { C_BatStatus,  &nBattery0x16L                  ,0x00},                         //Batpollstep1 = 15     WORD
1246                  { C_RMcap,              &Bat0x0FTempL                   ,0x00},                         //Batpollstep1 = 16     WORD    9~19 normal polling
1247                  { C_current,    &nNowCurrentL                   ,0x00},                         //Batpollstep1 = 17     WORD
1248                  { C_FCcap,              &nFullChgCapL                   ,0x00},                         //Batpollstep1 = 18     WORD
1249                  { C_temp,               &EC_oCBTl                               ,0x00},                         //Batpollstep1 = 19     WORD
1250                  { C_RSOC,               &BAT1PERCL                      ,0x00},                         //Batpollstep1 = 20     WORD
1251                  { C_current,    &nNowCurrentL                   ,0x00},                         //Batpollstep1 = 21     WORD
1252                  { C_AVcurrent,  &Bat0x0BTempL                   ,0x00},                         //Batpollstep1 = 22     WORD
1253                  { C_LVMfgFun2,  &Bat0x3ETempL                   ,0x00},                         //Batpollsetp1 = 23     WORD
1254                  { C_access,             &Bat0x00TempL                   ,0x00},                         //Batpollsetp1 = 24     WORD
1255                  { C_current,    &nNowCurrentL                   ,0x00},                         //Batpollstep1 = 25     WORD
1256                  { C_RSOC,               &BAT1PERCL                      ,0x00},                         //Batpollstep1 = 26     WORD  //Add read battery RSOC at bottom of tab
             -le.
1257                  //{ C_D_FET,    &SHIPMODE_L                     ,0x00},                                 //Batpollstep1 = 27     WORD
1258          
1259          };
1260          
1261          //-----------------------------------------------------------------------------
1262          // get 1 battery data
1263          //-----------------------------------------------------------------------------
1264          void GetBatData(BYTE _STEP)
1265          {
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 22  

1266   1              switch (_STEP)
1267   1          {
1268   2              case 1: //block data
1269   2              //Mos: Break C_Dchem directly
1270   2              //Cause That memory overlap with C_Dname, it will cause Data unstable, I can't get same data 3 times
1271   2                              //break;//ANGELAS107:-Add code for GBSI function.
1272   2                      case 2: //block data
1273   2                      case 3: //block
1274   2                      case 4: //block data //MEILING031:add.
1275   2                              if(     !bRSMBusBlock(SMbusChB, SMbusRBK, SmBat_Addr,
1276   2                                      ABatCommandTable[_STEP].cmd,
1277   2                                      ABatCommandTable[_STEP].smbdataA))
1278   2                              {       // SMBUS FAIL
1279   3                                      BatSMbusFailCount++;
1280   3                                      //ResetSMBus(SMbusChB); //MEILING002: add  //MEILING014:remove.
1281   3                              }
1282   2                              else
1283   2                              {       // SMBUS OK
1284   3                                      BatSMbusFailCount=0;
1285   3                              }
1286   2                              break;
1287   2      
1288   2                      default: //word data
1289   2                              if(!bRWSMBus(SMbusChB, SMbusRW, SmBat_Addr,
1290   2                                 ABatCommandTable[_STEP].cmd,
1291   2                                 ABatCommandTable[_STEP].smbdataA,
1292   2                                 SMBus_NoPEC))
1293   2                              {       // SMBUS FAIL
1294   3                                      BatSMbusFailCount++;
1295   3                                      //ResetSMBus(SMbusChB); //MEILING002: add  //MEILING014:remove.
1296   3                              }
1297   2                              else
1298   2                              {       // SMBUS OK
1299   3                                      BatSMbusFailCount=0;
1300   3                              }
1301   2      
1302   2                              break;
1303   2              }
1304   1      }
1305          
1306          
1307          void ChkBattery_Percl()
1308          {
1309   1          bRWSMBus(SMbusChB, SMbusRW, SmBat_Addr,C_RSOC,&BAT1PERCL ,SMBus_NoPEC);
1310   1      }
1311          
1312          //-----------------------------------------------------------------------------
1313          // battery plug in first fast update all information
1314          //-----------------------------------------------------------------------------
1315          void FirstGetBatData(void)
1316          {
1317   1              BYTE i,j;
1318   1              WORD DesignVoltage; //MEILING017: add
1319   1      
1320   1              Batpollstep1 = 0;
1321   1              nBatteryStatL = 0;
1322   1              for (i=0;i<(sizeof(ABatCommandTable)/4);i++)
1323   1              {
1324   2              GetBatData(Batpollstep1);
1325   2              Batpollstep1++;
1326   2              }
1327   1          Batpollstep1=8;
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 23  

1328   1          SHA1_SEED = (WORD)((TL0+Bat0x0FTempL)<<8);
1329   1      
1330   1              //Mos: Move to OEM_PollingBatData_TASK() to make sure Battery data stable.
1331   1              /*if( ( BATTMANUFACTURE[0] == 'S' ) && ((BATTMANUFACTURE[1] == 'A' )||( BATTMANUFACTURE[1] == 'a' )) )
1332   1                  nBatteryStatL |= 0x10 ;     // SANYO
1333   1              else if( (BATTMANUFACTURE[0] == 'S' ) && ( BATTMANUFACTURE[1] == 'O' ) )
1334   1                  nBatteryStatL |= 0x20 ;     // Sony
1335   1              else if( (BATTMANUFACTURE[0] == 'P' ) && (( BATTMANUFACTURE[1] == 'A' )|| ( BATTMANUFACTURE[1] == 'a' )) 
             -)
1336   1                      nBatteryStatL |= 0x40 ; // Panasonic
1337   1              else if( (BATTMANUFACTURE[0] == 'S' ) && ( BATTMANUFACTURE[1] == 'U' ) )
1338   1                      nBatteryStatL |= 0x50 ; // Samsung
1339   1              else if( (BATTMANUFACTURE[0] == 'L' ) && ( BATTMANUFACTURE[1] == 'G' ) )
1340   1                      nBatteryStatL |= 0x30 ; // LG
1341   1              else if( (BATTMANUFACTURE[0] == 'C' ) && (( BATTMANUFACTURE[1] == 'P' ) || ( BATTMANUFACTURE[1] == 'p' ))
             - )
1342   1                      nBatteryStatL |= 0x60;  // CPT Celxpert
1343   1              else if( (BATTMANUFACTURE[0] == 'S' ) && (BATTMANUFACTURE[1] == 'M' ) )
1344   1                      nBatteryStatL |= 0x70;  // Simplo*/
1345   1              
1346   1              //ANGELAS107:S+Add code for GBSI function.
1347   1          if((batteryChemistry[0]=='L')&&(batteryChemistry[1]=='I')&&(batteryChemistry[2]=='O')&&(batteryChemist
             -ry[3]=='N'))
1348   1                      SET_MASK(nBatteryStatL,CMBS_BATTTYPE);  
1349   1              else
1350   1                  CLEAR_MASK(nBatteryStatL,CMBS_BATTTYPE);
1351   1          //ANGELAS107:E+Add code for GBSI function.
1352   1      
1353   1              OCPCapacity = (WORD)((nDesignCapH<<8)+nDesignCapL);
1354   1              OCPCapacity = OCPCapacity *8;
1355   1              //Mos: According Batt - Patrick request, reduce Over Current Point from 0.8 DesignCap to 0.78 DesignCap.
1356   1              //T059- OCPCapacity = OCPCapacity - (OCPCapacity * 2 / 10);
1357   1              //T059- OCPCapacity = OCPCapacity / (WORD)((nDesignVoltH<<8)+nDesignVoltL);
1358   1              //T059- OCPCapacity = OCPCapacity * 1000;
1359   1      
1360   1          OCPCapacity =(WORD)((LWORD)OCPCapacity*1000 / (WORD)((nDesignVoltH<<8)+nDesignVoltL));
1361   1      
1362   1              OCPCapacityRelease = (WORD)((nDesignCapH<<8)+nDesignCapL);
1363   1              OCPCapacityRelease = OCPCapacityRelease *7;
1364   1      
1365   1          OCPCapacityRelease =(WORD)((LWORD)OCPCapacityRelease*1000 / (WORD)((nDesignVoltH<<8)+nDesignVoltL));
1366   1      
1367   1              //MEILING017: add start
1368   1              DesignVoltage=(WORD)((nDesignVoltH<<8)+ nDesignVoltL);
1369   1              if((DesignVoltage >= 14000) && (DesignVoltage <= 15200))  //Cell: 4series   14V~15.2V
1370   1                      CellCount=4;
1371   1              else if((DesignVoltage >= 9000) && (DesignVoltage <= 13200)) //Cell: 3series   10.5V~11.4V
1372   1                      CellCount=3;
1373   1              else if((DesignVoltage >= 6000) && (DesignVoltage <= 8800)) //Cell: 2series   7V~7.6V
1374   1                      CellCount=2;
1375   1              //MEILING017: add end
1376   1      
1377   1              S3ResumeRSOC = S3RSOCPercentage;                // Set S3 resuem in the battery under 5%.
1378   1              BatteryOTP = BatteryOTPHi;
1379   1              BatteryOTPRelease = BatteryOTPLow;
1380   1              BatteryOTPShutdown = BatteryOTPSD;
1381   1      
1382   1      
1383   1              UpdateNameSpace();
1384   1              Chk_Battery_Full();
1385   1              nBattErrorCnt = 0;
1386   1              SHA1_SEED = SHA1_SEED + (WORD)(TL0);
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 24  

1387   1              srand(SHA1_SEED);
1388   1      
1389   1              if (BatSMbusFailCount==0)
1390   1              {
1391   2                      Battdata_ready = 1;
1392   2                      WSMbusTemp01 = EC_C_modeH;
1393   2                      if ((WSMbusTemp01^0xE0)&0xE0)                           // check bit15,bit14,bit13=1  ??
1394   2                      {
1395   3                              WSMbusTemp01=EC_C_modeL;
1396   3                              WSMbusTemp02=EC_C_modeH;
1397   3                              WSMbusTemp02|=0xE0;
1398   3                              if(!bRWSMBus(SMbusChB, SMbusWW, SmBat_Addr, C_mode, &WSMbusTemp01,SMBus_NoPEC))
1399   3                              {
1400   4                                      BatSMbusFailCount++;
1401   4                              }
1402   3                      }
1403   2              }
1404   1      }
1405          
1406          void Chk_Battery_Full(void)
1407          {
1408   1              if (IS_MASK_CLEAR(SYS_STATUS,AC_ADP)||(IS_MASK_SET(SYS_STATUS,AC_ADP)&&IS_MASK_SET(ACOFF_SOURCE,BATTLEARN
             -)))
1409   1              {
1410   2              CLEAR_MASK(SEL_STATE0,CHARGE_A);                //clear  battery charging flag
1411   2              CLEAR_MASK(nBatteryStatH,CMBS_CHARGE);  //clear  battery charging flag
1412   2              SET_MASK(nBatteryStatH,CMBS_DISCHARGE); //set battery discharging flag
1413   2              return;
1414   2              }
1415   1      
1416   1              //if ((cBattFlag0.fbit.cCmdAcOff==1)||Read_ACOFF()||IS_MASK_SET(EC_BatteryStatusL,FullyChg)||((nStopChgSt
             -at3L|nStopChgStat3H)!=0))
1417   1              if ((cBattFlag0.fbit.cCmdAcOff==1)||IS_MASK_SET(EC_BatteryStatusL,FullyChg)||((nStopChgStat3L|nStopChgSta
             -t3H)!=0))
1418   1              {
1419   2                      CLEAR_MASK(SEL_STATE0,CHARGE_A);                                //clear  battery charging flag
1420   2                      CLEAR_MASK(nBatteryStatH,CMBS_CHARGE);          //clear  battery charging flag
1421   2                      CLEAR_MASK(nBatteryStatH,CMBS_DISCHARGE);       //clear battery discharging flag
1422   2                      return;
1423   2              }
1424   1              else
1425   1              {
1426   2                      if ((cBattFlag0.fbit.cBF0_GoTarget ==1) && (cTargetGauge == nBattGasgauge))
1427   2                      {
1428   3                              CLEAR_MASK(SEL_STATE0,CHARGE_A);                        //clear  battery charging flag
1429   3                              CLEAR_MASK(nBatteryStatH,CMBS_CHARGE);          //clear  battery charging flag
1430   3                              CLEAR_MASK(nBatteryStatH,CMBS_DISCHARGE);       //clear battery discharging flag
1431   3                              return;
1432   3                      }
1433   2              }
1434   1      
1435   1              if (IS_MASK_CLEAR(LENOVOPMFW,BATTERY_STORAGE))  
1436   1              {
1437   2                      if (IS_MASK_SET(nBattery0x16L,FullyChg))        // || IS_MASK_SET(CHGIC_ReadCmd0x12L,ChargeInhibit))
1438   2                      {
1439   3                              CLEAR_MASK(SEL_STATE0,CHARGE_A);                        //clear  battery charging flag
1440   3                              CLEAR_MASK(nBatteryStatH,CMBS_CHARGE);          //clear  battery charging flag
1441   3                              SET_MASK(nBatteryStatH,CMBS_DISCHARGE);         //set battery discharging flag
1442   3                      }
1443   2                      else
1444   2                      {
1445   3                              SET_MASK(SEL_STATE0,CHARGE_A);                          //set battery charging flag
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 25  

1446   3                              SET_MASK(nBatteryStatH,CMBS_CHARGE);            //set battery charging flag
1447   3                              CLEAR_MASK(nBatteryStatH,CMBS_DISCHARGE);       //clear battery discharging flag
1448   3                      }
1449   2              }
1450   1              else
1451   1              {
1452   2                      if (IS_MASK_SET(EC_BatteryStatusL,FullyChg))    // || IS_MASK_SET(CHGIC_ReadCmd0x12L,ChargeInhibit))
1453   2                      {
1454   3                              CLEAR_MASK(SEL_STATE0,CHARGE_A);                        //clear  battery charging flag
1455   3                              CLEAR_MASK(nBatteryStatH,CMBS_CHARGE);          //clear  battery charging flag
1456   3                      }
1457   2                      else
1458   2                      {
1459   3                              SET_MASK(SEL_STATE0,CHARGE_A);                          //set battery charging flag
1460   3                              SET_MASK(nBatteryStatH,CMBS_CHARGE);            //set battery charging flag
1461   3                              CLEAR_MASK(nBatteryStatH,CMBS_DISCHARGE);       //clear battery discharging flag
1462   3                      }
1463   2              }
1464   1      }
1465          
1466          void Unlock_ShipMode(void)
1467          {
1468   1              /*BYTE sCmd;
1469   1              WORD sData;
1470   1      
1471   1              // first command = 0x34, data1 = 0x2000, data2 = 0x4000
1472   1              sCmd = C_D_FET;
1473   1              sData = 0x0020;         // word form L/H
1474   1              if (!bRWSMBus(SMbusChB, SMbusWW, SmBat_Addr, sCmd, &sData,SMBus_NoPEC))
1475   1              {
1476   1                      SMbusFailCnt3++;
1477   1              }
1478   1      
1479   1              sCmd = C_D_FET;
1480   1              sData = 0x0040;         // word form L/H
1481   1              if (!bRWSMBus(SMbusChB, SMbusWW, SmBat_Addr, sCmd, &sData,SMBus_NoPEC))
1482   1              {
1483   1                      SMbusFailCnt2++;
1484   1              }
1485   1              */
1486   1              // change all SMBus_NoPEC to SMBus_NeedPEC
1487   1          if(IS_MASK_SET(BATTUPDATEFW,BIT0))
1488   1              return;
1489   1              ShipModeEn=0x00;   //ANGELAS032: add
1490   1              CLEAR_MASK(EMStatusBit2,b0SetBatteryShipMode); //ANGELAS079:add
1491   1              WSMbusTemp01=0x00;
1492   1              WSMbusTemp02=0x20;
1493   1      
1494   1              if(!bRWSMBus(SMbusChB, SMbusWW, SmBat_Addr, C_D_FET, &WSMbusTemp01,SMBus_NeedPEC)) 
1495   1              {
1496   2                      SMbusFailCnt3++;
1497   2              }
1498   1      
1499   1              WSMbusTemp01=0x00;
1500   1              WSMbusTemp02=0x40;
1501   1      
1502   1              if(!bRWSMBus(SMbusChB, SMbusWW, SmBat_Addr, C_D_FET, &WSMbusTemp01,SMBus_NeedPEC))
1503   1              {
1504   2                      SMbusFailCnt2++;
1505   2              }
1506   1              // start Shipmode disable 5s loop once
1507   1              if(bRWSMBus(SMbusChB, SMbusRW, SmBat_Addr, C_D_FET, &ShipModeACK,SMBus_NoPEC))
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 26  

1508   1              {
1509   2                  if(ShipModeACK!=0x00)
1510   2                  {
1511   3                 ShipModeCnt=1;
1512   3                      }       
1513   2              }
1514   1              else
1515   1              {
1516   2                  SMbusFailCnt4++;
1517   2              ShipModeCnt=1;
1518   2              }
1519   1              // End Shipmode disable 5s loop once 
1520   1      }
1521          
1522          void Lock_ShipMode(void)
1523          {
1524   1              /*
1525   1              BYTE sCmd;
1526   1              WORD sData;
1527   1      
1528   1              // first command = 0x34, data1 = 0x0000, data2 = 0x1000
1529   1              sCmd = C_D_FET;
1530   1              sData = 0x0000;         // word form L/H
1531   1              if (!bRWSMBus(SMbusChB, SMbusWW, SmBat_Addr, sCmd, &sData,SMBus_NoPEC))
1532   1              {
1533   1                      SMbusFailCnt3++;
1534   1              }
1535   1      
1536   1              sCmd = C_D_FET;
1537   1              sData = 0x0010;         // word form L/H
1538   1              if (!bRWSMBus(SMbusChB, SMbusWW, SmBat_Addr, sCmd, &sData,SMBus_NoPEC))
1539   1              {
1540   1                      SMbusFailCnt2++;
1541   1              }
1542   1              */
1543   1              //change all SMBus_NoPEC to SMBus_NeedPEC
1544   1      
1545   1              //LMLKBL0019:s+Add time delay for Clear First Used Date to Enable ship mode following the requirements of
             - the battery and re-try mechanism.
1546   1              BYTE retryNum = 0x00; 
1547   1          SMbusFailCnt3 = 0x00; 
1548   1          SMbusFailCnt2 = 0x00;
1549   1              
1550   1              WSMbusTemp01=0x00;
1551   1              WSMbusTemp02=0x00;
1552   1              if(!bRWSMBus(SMbusChB, SMbusWW, SmBat_Addr, C_D_FET, &WSMbusTemp01,SMBus_NeedPEC))
1553   1              {
1554   2                      SMbusFailCnt3++;
1555   2              }
1556   1              
1557   1              Delay1MS(250);
1558   1      
1559   1              WSMbusTemp01=0x00;
1560   1              WSMbusTemp02=0x10;
1561   1              if(!bRWSMBus(SMbusChB, SMbusWW, SmBat_Addr, C_D_FET, &WSMbusTemp01,SMBus_NeedPEC))
1562   1              {
1563   2                      SMbusFailCnt2++;
1564   2              }
1565   1      
1566   1              for(retryNum=0x00;retryNum<0x06;retryNum++)
1567   1          {
1568   2              if((SMbusFailCnt3 == 0x00)&&(SMbusFailCnt2 == 0x00))
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 27  

1569   2                      break;
1570   2      
1571   2              ProcessSID(0xA5);
1572   2              SMbusFailCnt3 = 0x00;
1573   2              SMbusFailCnt2 = 0x00;
1574   2                 
1575   2              Delay1MS(0x0A);
1576   2              Delay1MS(250); //ANGELAG015: add
1577   2                 
1578   2              WSMbusTemp01=0x00;
1579   2              WSMbusTemp02=0x00;
1580   2              if(!bRWSMBus(SMbusChB, SMbusWW, SmBat_Addr, C_D_FET, &WSMbusTemp01,SMBus_NeedPEC))
1581   2              {
1582   3                      SMbusFailCnt3++;
1583   3              }
1584   2                 
1585   2              Delay1MS(250);
1586   2             
1587   2              WSMbusTemp01=0x00;
1588   2              WSMbusTemp02=0x10;
1589   2              if(!bRWSMBus(SMbusChB, SMbusWW, SmBat_Addr, C_D_FET, &WSMbusTemp01,SMBus_NeedPEC))
1590   2              {
1591   3                      SMbusFailCnt2++;
1592   3              }
1593   2              }
1594   1              //LMLKBL0019:e+Add time delay for Clear First Used Date to Enable ship mode following the requirements of
             - the battery and re-try mechanism.
1595   1      
1596   1      }
1597          
1598          
1599          //-----------------------------------------------------------------------------
1600          // read all battery about information
1601          // polling time : 1sec
1602          //-----------------------------------------------------------------------------
1603          void OEM_PollingBatData_TASK(void)
1604          {
1605   1              XBYTE i,j;
1606   1          XBYTE *ptr;
1607   1      
1608   1              if(IS_MASK_CLEAR(BATTUPDATEFW,BIT0))
1609   1              {
1610   2              GetBatData(Batpollstep1);
1611   2           // ChkBattery_OverConsumption();  //MEILING033:change over 45W to 28W.
1612   2              Batpollstep1++;
1613   2      
1614   2              if(Batpollstep1 >= (sizeof(ABatCommandTable)/4))
1615   2              {
1616   3                              ////////////////////////
1617   3                              //Mos: Battery Debounce Block
1618   3                              //Get 9 entry from battery table, loop and XOR each byte, calculate a hash byte
1619   3                              //If hash result same as previous, then counter +1
1620   3                              //If counter > 3 times, mean battery data stable, keep Batpollstep1 = 9 to skip first 9 entry in batter
             -y table
1621   3                              //otherwise, clean counter and loop the table again.
1622   3                              if (Get_Batt_debounce_count < 3)
1623   3                              {
1624   4                                      Get_Batt_debounce_hash2 = Get_Batt_debounce_hash1;
1625   4                                      Get_Batt_debounce_hash1 = 0x00;
1626   4                                      for (i=0; i<9; i++)
1627   4                                      {
1628   5                                              if(ABatCommandTable[i].block_limit == 0x00)
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 28  

1629   5                                                      Get_Batt_debounce_hash1 ^= *ABatCommandTable[i].smbdataA;
1630   5                                              else
1631   5                                              {
1632   6                                                      ptr = ABatCommandTable[i].smbdataA;
1633   6                                                      for(j=0; j<ABatCommandTable[i].block_limit; j++)
1634   6                                                      {
1635   7                                                              Get_Batt_debounce_hash1 ^= *ptr;
1636   7                                                              ptr++;
1637   7                                                      }
1638   6                                              }
1639   5                                      }
1640   4      
1641   4                                      if (Get_Batt_debounce_hash2 == Get_Batt_debounce_hash1)
1642   4                                              Get_Batt_debounce_count++;
1643   4                                      else
1644   4                                              Get_Batt_debounce_count = 0;
1645   4      
1646   4                                      Batpollstep1=0; //revert Batpollstep1 for start over
1647   4                                      //Mos: Fill nBatteryStatL after Battery Data stable.
1648   4                                      if ( Get_Batt_debounce_count >= 3 )
1649   4                                      {
1650   5                                              if( ( BATTMANUFACTURE[0] == 'S' ) && ((BATTMANUFACTURE[1] == 'A' )||( BATTMANUFACTURE[1] == 'a' )) )
1651   5                                              nBatteryStatL |= 0x10 ; // SANYO
1652   5                                              else if( (BATTMANUFACTURE[0] == 'S' ) && ( BATTMANUFACTURE[1] == 'O' ) )
1653   5                                              nBatteryStatL |= 0x20 ; // Sony
1654   5                                              else if( (BATTMANUFACTURE[0] == 'P' ) && (( BATTMANUFACTURE[1] == 'A' )|| ( BATTMANUFACTURE[1] == 'a'
             - )) )
1655   5                                                      nBatteryStatL |= 0x40 ; // Panasonic
1656   5                                              else if( (BATTMANUFACTURE[0] == 'S' ) && ( BATTMANUFACTURE[1] == 'U' ) )
1657   5                                                      nBatteryStatL |= 0x50 ; // Samsung
1658   5                                              else if( (BATTMANUFACTURE[0] == 'L' ) && ( BATTMANUFACTURE[1] == 'G' ) )
1659   5                                                      nBatteryStatL |= 0x30 ; // LG
1660   5                                              else if( (BATTMANUFACTURE[0] == 'C' ) && (( BATTMANUFACTURE[1] == 'P' ) || ( BATTMANUFACTURE[1] == 'p
             -' )) )
1661   5                                                      nBatteryStatL |= 0x60;  // CPT Celxpert
1662   5                                              else if( (BATTMANUFACTURE[0] == 'S' ) && (BATTMANUFACTURE[1] == 'M' ) )
1663   5                                                      nBatteryStatL |= 0x70;  // Simplo*/
1664   5                                      }
1665   4                              }
1666   3                              else
1667   3                              {
1668   4                              Batpollstep1=9;
1669   4                              }
1670   3              }
1671   2                      UpdateNameSpace();//:optimize .
1672   2                      ChkLENOVOPMFW();
1673   2                      ChkGoTarget();
1674   2                      Chk_Battery_Full();
1675   2                      if(GPUProchotONCnt == 0) //ANGELAG033: add
1676   2                      { //ANGELAG033: add
1677   3                              ChkBattery_OTP();
1678   3                              //ChkBattery_OCP();  //MEILING046:remove.//MEILING051:-Add cpu P_STATE function.
1679   3                              ChkBattery_OCP();  //ANGELAG017: add
1680   3                      //      ChkPsys();  //ANGELAG019: add
1681   3                              CkkBattery_RSOCLow(); //MEILING033:add
1682   3                      } //ANGELAG033: add
1683   2              ChkBattery_LowVoltage();
1684   2                      ChkBattery_FCCchg();
1685   2                      ChkAvgCurrent();
1686   2                      ChkS3DCRSOC();//ANGELAS093:Modify battery RSOC below 5% can't into S3.
1687   2                      ChkS3ResumeRSOC();
1688   2                      RSOC1Pto0P_ShutdownCheck();//ANGELAS043:Add
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 29  

1689   2              }
1690   1      }
1691          
1692          
1693          //-----------------------------------------------------------------
1694          // Service Charger SMBus
1695          //-----------------------------------------------------------------
1696          void WriteSmartChgIC(void)
1697          {
1698   1              BYTE sCmd, *sData;
1699   1              WORD BattNowCurrent; 
1700   1      
1701   1              if (!Read_AC_IN())
1702   1              {
1703   2                      return;
1704   2              }
1705   1              if(CHGIC_ptr>=4) 
1706   1              {
1707   2                      CHGIC_ptr=0;
1708   2              }
1709   1              else 
1710   1              {
1711   2                      CHGIC_ptr++;
1712   2              }
1713   1              switch( CHGIC_ptr )
1714   1              {
1715   2                      case 0x00:
1716   2                              sCmd  = C_ChargeCurrent;
1717   2                              sData = &nBattCharCurrentL;
1718   2                              break;
1719   2                      case 0x01:
1720   2                              sCmd  = C_ChargeVoltage;
1721   2                              sData = &nChargingVoltL;
1722   2                              break;
1723   2                      case 0x02:
1724   2                              if(IS_MASK_CLEAR(SEL_STATE0,PRESENT_A))//AC only
1725   2                              {
1726   3                                      CHGIC_InputCurrentL=0x00;//
1727   3                                      CHGIC_InputCurrentH=0x0B;
1728   3                              }
1729   2                              else  //AC+DC
1730   2                              {
1731   3                                      if(nBattGasgauge >= 10)
1732   3                                      {
1733   4                                              CHGIC_InputCurrentL=0x80;//
1734   4                                              CHGIC_InputCurrentH=0x0B;
1735   4                                      }
1736   3                                      else
1737   3                                      {
1738   4                                              CHGIC_InputCurrentL=0x00;//
1739   4                                              CHGIC_InputCurrentH=0x0B;
1740   4                                      }
1741   3                              }
1742   2                          sCmd  = C_InputCurrent;
1743   2                  sData = &CHGIC_InputCurrentL;
1744   2                  break;
1745   2                      case 0x03:
1746   2                              if ((CHGIC_ReadCmd0x12L!=0) || (CHGIC_ReadCmd0x12H!=0))
1747   2                              {
1748   3                                      if ((cBattFlag0.fbit.cCmdAcOff==1)||IS_MASK_SET(EC_BatteryStatusL,FullyChg))    
1749   3                                      {
1750   4                                              SET_MASK(CHGIC_WriteCmd0x12L,ChargeInhibit);    
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 30  

1751   4                                      }
1752   3                                      else
1753   3                                      {
1754   4                                              if ((cBattFlag0.fbit.cBF0_GoTarget ==1) && (cTargetGauge == nBattGasgauge))
1755   4                                              {
1756   5                                                      SET_MASK(CHGIC_WriteCmd0x12L,ChargeInhibit);    
1757   5                                              }
1758   4                                              else
1759   4                                              {
1760   5                                                      CLR_MASK(CHGIC_WriteCmd0x12L,ChargeInhibit);    
1761   5                                              }
1762   4                                      }
1763   3                                      
1764   3                                      if (nStopChgStat3L|nStopChgStat3H|inhibit2sec|ACOFF_SOURCE)                                     
1765   3                                      {
1766   4                                              SET_MASK(CHGIC_WriteCmd0x12L,ChargeInhibit);    
1767   4                                      }
1768   3                                      sCmd = C_ChargerMode;
1769   3                                      sData = &CHGIC_WriteCmd0x12L; 
1770   3                              }
1771   2                              else
1772   2                              {
1773   3                                      return;
1774   3                              }
1775   2                              break;
1776   2                      case 0x04:
1777   2                      sCmd = C_ChargerMode3;
1778   2                      sData = &CHGIC_WriteCmd0x37L;
1779   2                              break;
1780   2                      default:
1781   2                              return;
1782   2              }
1783   1              if (!bRWSMBus(SMbusChB, SMbusWW, Charger_Addr, sCmd, sData,SMBus_NoPEC))
1784   1              {
1785   2                      CHGIC_SMbusFailCnt++;
1786   2              }
1787   1      }
1788          
1789          
1790          const sRSmbusBStruct code ReadChgIcCmdTable [] =
1791          {//     command                   REG                    no.
1792            { C_ChargeCurrent,    &CHGIC_ReadCmd0x14L     ,0x00},
1793            { C_ChargeVoltage,    &CHGIC_ReadCmd0x15L     ,0x00},
1794            { C_InputCurrent,     &CHGIC_ReadCmd0x3FL     ,0x00},
1795            { C_ChargerMode,      &CHGIC_ReadCmd0x12L             ,0x00},
1796            { C_ChargerMode3,     &CHGIC_ReadCmd0x37L             ,0x00} 
1797          };
1798          void ReadSmartChgIC(void)
1799          {
1800   1              //      if (IS_MASK_SET(SEL_STATE0,PRESENT_A))
1801   1              {
1802   2              if(!bRWSMBus(SMbusChB, SMbusRW, Charger_Addr,
1803   2                   ReadChgIcCmdTable[CHGIC_ptr].cmd,
1804   2                   ReadChgIcCmdTable[CHGIC_ptr].smbdataA,
1805   2                     SMBus_NoPEC))
1806   2              {  // SMBUS FAIL
1807   3                      CHGIC_SMbusFailCnt++;
1808   3              }
1809   2              }
1810   1      }
1811          
1812          void Chk_Shutdown_Volt(void)
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 31  

1813          {
1814   1              WORD cutoff_volt;
1815   1              #if EN_PwrSeqTest
                                return;
                      #endif
1818   1      
1819   1              if( (BATTMANUFACTURE[0] == 'L' ) && ( BATTMANUFACTURE[1] == 'G' ) )
1820   1              {
1821   2                      cutoff_volt = 8250 ;    //  shutdown Voltage 8.25V  for LG 3S battery
1822   2              }
1823   1              else
1824   1              {
1825   2              cutoff_volt = 8500;             // Voltage 8.5V for Sanyo battery
1826   2          }
1827   1      
1828   1      
1829   1              ITempW01 = (WORD)((nPresentVoltH<<8)+nPresentVoltL);    // get now voltage
1830   1      
1831   1              if (ITempW01 < cutoff_volt)     //  shutdown Voltage
1832   1              {
1833   2                      BatLowCnt++;
1834   2                      if ((BatLowCnt >= 6)&&((SysPowState==SYSTEM_S0)||(SysPowState==SYSTEM_S3)))
1835   2                      {
1836   3                      //SET_MASK(SysStatus,ERR_ShuntDownFlag);
1837   3                              //ProcessSID(BATTLOWVOLT_ID);
1838   3                              //RSMRST_shutdown();    //shutdown (RSMRST HI-->low-->HI)
1839   3                      }
1840   2              }
1841   1              else
1842   1              {
1843   2                      BatLowCnt =0;
1844   2              }
1845   1      }
1846          
1847          
1848          
1849          void Chk_BAT1PERCL_5(void)
1850          {
1851   1              if ((BAT1PERCL <= 0)&&(IS_MASK_SET(nBattery0x16L,Dsg))) // BAT1PERCL <= 5%  //T064: change 5 to 0
1852   1              {
1853   2                      //cBATTThrottling = 0x0F;
1854   2                      //cBATTThrottling = PSTATE_MAXStep;//0ptimize CPU P_state (change 16 step to 8 step).  //MEILING048:remo
             -ve.//MEILING051:-Add cpu P_STATE function.
1855   2                      SET_MASK(BatteryAlarm,BATPercl_5);
1856   2              }
1857   1              else
1858   1              {
1859   2                      if (IS_MASK_SET(BatteryAlarm,BATPercl_5))
1860   2                      {
1861   3                              CLEAR_MASK(BatteryAlarm,BATPercl_5);
1862   3                              if (BatteryAlarm == 0)
1863   3                              {
1864   4                                      //cBATTThrottling = 0;  //MEILING048:remove.//MEILING051:-Add cpu P_STATE function.
1865   4                              }
1866   3                      }
1867   2              }
1868   1      }
1869          
1870          
1871          
1872          void Chk_BatSMbusFailCount(void)
1873          {
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 32  

1874   1              BYTE sCmd, *sData;
1875   1      
1876   1              if (nBattErrorCnt==0)
1877   1              {
1878   2                      CLEAR_MASK(nStopChgStat3L,ENCOMMFAIL);  // clear bat communication fail and clear STOP charge
1879   2                      CLEAR_MASK(Bat1_FPChgFlag,BIT(0));
1880   2                      Chk_BAT1PERCL_5();
1881   2                      if (IS_MASK_SET(nBattery0x16L,Dsg))
1882   2                      {
1883   3                              Chk_Shutdown_Volt();
1884   3                      }
1885   2                      return;
1886   2              }
1887   1      
1888   1              //if (IS_MASK_CLEAR(SYS_STATUS,AC_ADP)||(IS_MASK_SET(SYS_STATUS,AC_ADP)&&Read_ACOFF()))         // discharge
1889   1              if (IS_MASK_CLEAR(SYS_STATUS,AC_ADP))           // discharge
1890   1              {
1891   2      
1892   2                      RST_ChgTimeOutCnt();
1893   2      
1894   2                      if (nBattErrorCnt==30)
1895   2                      {
1896   3                              //cBATTThrottling = 0x0F;
1897   3                              //cBATTThrottling = PSTATE_MAXStep;//0ptimize CPU P_state (change 16 step to 8 step). //MEILING048:remo
             -ve.//MEILING051:-Add cpu P_STATE function.
1898   3      
1899   3                              //nRemainingCapL = 0;  //LMLKBL0006:remove.
1900   3                              //nRemainingCapH = 0;  //LMLKBL0006:remove.
1901   3                              SMbusFailCnt2++;
1902   3                      }
1903   2                      if (nBattErrorCnt>=150)
1904   2                      {
1905   3                              #if !EN_PwrSeqTest
1906   3                              //cBATTThrottling = 0x0F;
1907   3                              //cBATTThrottling = PSTATE_MAXStep;//0ptimize CPU P_state (change 16 step to 8 step).  //MEILING048:rem
             -ove.//MEILING051:-Add cpu P_STATE function.
1908   3                              SMbusFailCnt3++;
1909   3                              nBattErrorCnt = 151;
1910   3                              if ((SysPowState==SYSTEM_S0)||(SysPowState==SYSTEM_S3))
1911   3                              {
1912   4                      SET_MASK(SysStatus,ERR_ShuntDownFlag);//Add battery smbus fail shutdown ID.
1913   4                                      ProcessSID(BATTCOMMFAIL_ID);
1914   4                                      RSMRST_shutdown();
1915   4                              }
1916   3                              #endif
1917   3                      }
1918   2              }
1919   1              else
1920   1              {
1921   2                      //if (IS_MASK_SET(SYS_STATUS,AC_ADP)&&(!Read_ACOFF()))                                  // battery charge
1922   2                      if (IS_MASK_SET(SYS_STATUS,AC_ADP))                                     // battery charge
1923   2                      {
1924   3                              if ((nBattErrorCnt != 0)&&(nBattErrorCnt < 30))
1925   3                              {
1926   4                                      nBattCharCurrentL = 0x00;                       // 256mA
1927   4                                      nBattCharCurrentH = 0x01;
1928   4                                      nChargingVoltL = 0xD0;                          // 8.4V     //LMLKBL0002:change 0xA0 to 0xD0.
1929   4                                      nChargingVoltH = 0x20;              //LMLKBL0002:change 0x41 to 0x20.
1930   4                                      //CHGIC_InputCurrentL = 0x00;
1931   4                                      //CHGIC_InputCurrentH = 0x0C;
1932   4                                      SMbusFailCnt3++;
1933   4                              }
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 33  

1934   3                              if ((nBattErrorCnt >= 30))                              // disable charge
1935   3                              {
1936   4                                      //nBattCharCurrentL = 0x00;                     // 0 mA
1937   4                                      //nBattCharCurrentH = 0x00;
1938   4                                      //nChargingVoltL = 0x00;                                // 0 V
1939   4                                      //nChargingVoltH = 0x00;
1940   4                                      //CHGIC_InputCurrentL = 0x00;
1941   4                                      //CHGIC_InputCurrentH = 0x00;
1942   4                                      RST_ChgTimeOutCnt();
1943   4                                      SET_MASK(nStopChgStat3L,ENCOMMFAIL);    // Set bat communication fail and STOP charge.
1944   4                                                                                                                              //      charge inhibit
1945   4                                      SMbusFailCnt2++;
1946   4                              }
1947   3                      }
1948   2              }
1949   1      }
1950          
1951          
1952          
1953          void Chk_CHG_TimeOut(void)                      // every 1 min
1954          {
1955   1          if (nBattTempCnt < 10)
1956   1                      return;
1957   1              if (IS_MASK_SET(CHGIC_ReadCmd0x12L,ChargeInhibit))
1958   1                      return;
1959   1              
1960   1              if((nBattCharCurrentH > 1) || ((nBattCharCurrentH == 1) && (nBattCharCurrentL >= 0xF4))) // nBattCharCurr
             -ent >= 0x01F4  (500mA)
1961   1              {
1962   2                      TrickleChgTimeOutCnt = 0;
1963   2                      FastChgTimeOutCnt++;
1964   2                      if (FastChgTimeOutCnt >= 720) //12hour
1965   2                      {
1966   3                              FastChgTimeOutCnt = 721;
1967   3                              SET_MASK(nStopChgStat3L,ENSTOPCHG);
1968   3                      }
1969   2              }
1970   1              else // nBattCharCurrent < 0x01F4  (500mA)
1971   1              {
1972   2                      FastChgTimeOutCnt = 0;
1973   2                      TrickleChgTimeOutCnt++;
1974   2                      if (TrickleChgTimeOutCnt >= 360) //12hour
1975   2                      {
1976   3                              TrickleChgTimeOutCnt = 361;
1977   3                              SET_MASK(nStopChgStat3H,ENTRITIMEOUT); //MARTINO006:change 'nStopChgStat3L' to 'nStopChgStat3H'
1978   3                      }
1979   2              }
1980   1      }
1981          
1982          void ChkBattery_abnormal(void)
1983          {
1984   1              if(IS_MASK_SET(BATTUPDATEFW,BIT0))
1985   1                 return;
1986   1      
1987   1              switch(ChkBattery_abnormal_status)
1988   1              {
1989   2              case ChkBattery_abnormal_status_normal:
1990   2                      if(IS_MASK_SET(CHGIC_ReadCmd0x12L, ChargeInhibit)
1991   2                              && IS_MASK_CLEAR(nNowCurrentH, BIT7) && (nNowCurrentL > 100) )
1992   2                      {
1993   3                              ChkBattery_abnormal_count++;
1994   3                              if (ChkBattery_abnormal_count>5)
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 34  

1995   3                              {
1996   4                                      ChkBattery_abnormal_status = ChkBattery_abnormal_status_error;
1997   4                              }
1998   3                      }
1999   2                      else
2000   2                      {
2001   3                              ChkBattery_abnormal_status = ChkBattery_abnormal_status_normal;
2002   3                              ChkBattery_abnormal_count = 0;
2003   3                      }
2004   2                      break;
2005   2              case ChkBattery_abnormal_status_error:
2006   2                      //Mos: Reset until EC power down
2007   2                      SET_MASK(ACOFF_SOURCE, CHARGECURRENT);
2008   2                      BATT_LEN_ON(); //ANGELAS047:add
2009   2                      //ACOFF_HI();
2010   2                      break;
2011   2              default:
2012   2                      ChkBattery_abnormal_status = ChkBattery_abnormal_status_normal;
2013   2                      ChkBattery_abnormal_count = 0;
2014   2                      break;
2015   2              }
2016   1      }
2017          
2018          
2019          BYTE Compare_data(XBYTE *buf1, XBYTE *buf2, BYTE count)
2020          {
2021   1              do 
2022   1              {
2023   2                      if( *buf1 != *buf2 ) return FALSE;
2024   2                      buf1++;
2025   2                      buf2++;
2026   2                      count--;
2027   2              }while(count);
2028   1              return TRUE;
2029   1      }
2030          
2031          void Compare_Auth_Result(void)
2032          {
2033   1              //inverse result for compare
2034   1              //inverse(&Hn0, &Hn4+3);
2035   1              if(Compare_data(&K, &RBATH0, 20) )
2036   1              {
2037   2                      CLEAR_MASK(nStopChgStat3H,NotLenovoBattery);    // SHA1 pass,legal
2038   2                      CLEAR_MASK(LENOVOBATT,BATTERY_LEGAL);                   // SHA1 pass,legal
2039   2                      CLEAR_MASK(LV_Authen_Step_CNT,BIT(6));          // authentication ok
2040   2                      SHA1failCnt=0x00;
2041   2                      SHA1FailRetry=0x00;
2042   2              }
2043   1              else
2044   1              {
2045   2                      SHA1failCnt ++;
2046   2                      if (SHA1failCnt < 4)
2047   2                      {
2048   3                              Service_Auth_Step=23;                                           //if  SHA1failCnt <3, retry
2049   3                      }
2050   2                      else
2051   2                      {
2052   3                          SHA1FailRetry++;
2053   3                              //if(SHA1FailRetry < 10)  
2054   3                          if((SHA1FailRetry!= 3)&&(SHA1FailRetry<11)) 
2055   3                          {
2056   4                              Service_Auth_Step = 1;
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 35  

2057   4                          }
2058   3                  else if(SHA1FailRetry == 3)  //add judge         
2059   3                          {
2060   4                                  SET_MASK(nStopChgStat3H,NotLenovoBattery);  // SHA1 no pass, battery illegal
2061   4                                  SET_MASK(LENOVOBATT,BATTERY_LEGAL);                 // SHA1 no pass, battery illegal
2062   4                                  SET_MASK(LV_Authen_Step_CNT,BIT(6));                // authentication Fail
2063   4                                  Service_Auth_Step = 1;  
2064   4                          }
2065   3              }  
2066   2              }
2067   1      }
2068          
2069          BYTE SendChallengeToBat(void)
2070          {
2071   1              BYTE SMBus_work;
2072   1              SMBus_work = bWSMBusBlock(SMbusChB, SMbusWBK, BatteryAddress, 0x27, &BATchallenger, 20, TRUE);
2073   1              if( SMBus_work ) 
2074   1                      return TRUE;
2075   1              
2076   1              return FALSE;
2077   1      }
2078          
2079          BYTE GetChallengeFromBat(void)
2080          {
2081   1              if( bRSMBusBlock(SMbusChB, SMbusRBK, BatteryAddress, 0x28, &RBATH0) ) 
2082   1                      return TRUE;
2083   1              
2084   1              return FALSE;
2085   1      }
2086          
2087          void SetRandomKey(BYTE N)
2088          {
2089   1              char *ptr;
2090   1              BYTE i;
2091   1      
2092   1              if( N==1 )
2093   1              {
2094   2                      ptr = BATchallenger;
2095   2                      for(i=0;i<20;i++)
2096   2                      {
2097   3                              *ptr = (char)(rand()&0xff);
2098   3                              ptr++;
2099   3                      }
2100   2      
2101   2                      /* bq20zxx two pass example key */
2102   2                      //SHA1_W[4] = 0x20212223;
2103   2                      //SHA1_W[5] = 0x24252627;
2104   2                      //SHA1_W[6] = 0x28292A2B;
2105   2                      //SHA1_W[7] = 0x2C2D2E2F;
2106   2                      //SHA1_W[8] = 0x30313233;
2107   2      
2108   2                      /* LV Sample example key */
2109   2                      //SHA1_W[4] =0xC82CA3CA;
2110   2                      //SHA1_W[5] =0x10DEC726;
2111   2                      //SHA1_W[6] =0x8E070A7C;
2112   2                      //SHA1_W[7] =0xF0D1FE82;
2113   2                      //SHA1_W[8] =0x20AAD3B8;
2114   2      
2115   2      
2116   2                      /* SHA1 one pass example key */
2117   2                      //SHA1_W[4] = 0x00000000;
2118   2                      //SHA1_W[5] = 0x00000000;
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 36  

2119   2                      //SHA1_W[6] = 0x00000000;
2120   2                      //SHA1_W[7] = 0x00000000;
2121   2                      //SHA1_W[8] = 0x00000000;
2122   2              }
2123   1          else 
2124   1          {
2125   2                      // move first time result to challenge
2126   2                      //SHA1_W[4]=Hn0;
2127   2                      N_Bit_Shift = 0;
2128   2                      ITempW01 = &Hn0;
2129   2                      AddrX_High = (ITempW01 >> 8);
2130   2                      AddrX_Low  = (ITempW01 & 0xFF);
2131   2                      ITempW01 = &SHA1_W[4];
2132   2                      AddrZ_High = (ITempW01 >> 8);
2133   2                      AddrZ_Low  = (ITempW01 & 0xFF);
2134   2                      Cal_CTRL = Rotate_Shift_right_BIT;
2135   2      
2136   2                      //SHA1_W[5]=Hn1;
2137   2                      AddrX_Low+=4;
2138   2                      AddrZ_Low+=4;
2139   2                      Cal_CTRL = Rotate_Shift_right_BIT;
2140   2      
2141   2                      //SHA1_W[6]=Hn2;
2142   2                      AddrX_Low+=4;
2143   2                      AddrZ_Low+=4;
2144   2                      Cal_CTRL = Rotate_Shift_right_BIT;
2145   2      
2146   2                      //SHA1_W[7]=Hn3;
2147   2                      AddrX_Low+=4;
2148   2                      AddrZ_Low+=4;
2149   2                      Cal_CTRL = Rotate_Shift_right_BIT;
2150   2      
2151   2                      //SHA1_W[8]=Hn4;
2152   2                      AddrX_Low+=4;
2153   2                      AddrZ_Low+=4;
2154   2                      Cal_CTRL = Rotate_Shift_right_BIT;
2155   2              }
2156   1      }
2157          
2158          
2159          
2160          void LV_BAT_Authentication(void)
2161          {
2162   1              unsigned long xdata * byte_sha1_pntr;
2163   1          int j;
2164   1      
2165   1              //===================================================================
2166   1              // Service SHA1 algorithm
2167   1              //===================================================================
2168   1              switch(Service_Auth_Step)
2169   1              {
2170   2              case 1:
2171   2                      //InitializeFix();              // initial H and W(0~4/9~15)
2172   2                      SetRandomKey(1);                // initial W(4~8)
2173   2                      Service_Auth_Step=2;
2174   2                      break;
2175   2              case 21:                                        // SHA1 start send data delay 10 sec
2176   2                      SendChallengeToBat();   // send to battery
2177   2                      Service_Auth_Step=22;
2178   2                      break;
2179   2              case 22:
2180   2                      byte_sha1_pntr = sha1_auth(&BATchallenger);
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 37  

2181   2                      for (j=0; j<5 ;j++)
2182   2                      {
2183   3                              K[j] = *byte_sha1_pntr;
2184   3                              byte_sha1_pntr++;
2185   3                      }
2186   2                      Service_Auth_Step=23;
2187   2                      break;
2188   2              case 23:
2189   2                      Service_Auth_Step=24;
2190   2                      break;
2191   2              case 24:
2192   2                      Service_Auth_Step=25;   // wait  for battery authentication
2193   2                      break;
2194   2              case 25:
2195   2                      GetChallengeFromBat();
2196   2                      Service_Auth_Step=0;
2197   2                      Compare_Auth_Result();
2198   2                      break;
2199   2              case 0:
2200   2                      Service_Auth_Step=0;
2201   2                      break;
2202   2              default:
2203   2                      Service_Auth_Step ++;
2204   2                      break;
2205   2              }
2206   1      }
2207          
2208          
2209          void Lenovo_Battery_EM80(void)
2210          {
2211   1              if (EM8_TEST == 0)
2212   1              {
2213   2                      if (IS_MASK_SET(Bat0x3ETempH,BIT0)&&(IS_MASK_SET(SYS_STATUS,AC_ADP))&&IS_MASK_CLEAR(LENOVOPMFW,BATTERY_S
             -TORAGE))                // 0x3E  bit8 G41:under storage mode Battery has been running over 72hrs ,EM can't pop out a message.
2214   2                      { 
2215   3                              SET_MASK(LENOVOBATT,BATTERY_USAGE);
2216   3              }
2217   2                      else
2218   2                      { 
2219   3                          CLEAR_MASK(LENOVOBATT,BATTERY_USAGE); 
2220   3              }
2221   2      
2222   2                      if (Bat0x00TempL&0x03)                          // 0x00  bit1, bit0
2223   2                      { 
2224   3                          SET_MASK(LENOVOBATT,BAD_BATT); 
2225   3              }       // Battery bad
2226   2                      else
2227   2                      { 
2228   3                          CLEAR_MASK(LENOVOBATT,BAD_BATT); 
2229   3              }
2230   2      
2231   2                      if (IS_MASK_SET(Bat0x3ETempH,BIT1))                     // 0x3E  bit9
2232   2                      { 
2233   3                          SET_MASK(LENOVOBATT,BATTERY_Exhaustion); 
2234   3              }       // Battery poor  (Exhaustion)
2235   2                      else
2236   2                      { 
2237   3                          CLEAR_MASK(LENOVOBATT,BATTERY_Exhaustion);   
2238   3              }
2239   2              }
2240   1              else
2241   1              { 
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 38  

2242   2                  LENOVOBATT = EM8_TEST ; 
2243   2          }
2244   1      }
2245          
2246          //JERRYCRZ010:+S Through the charger IC option control battery learn mode.
2247          void BATT_LEN_OFF(void)
2248          {
2249   1              CLEAR_MASK(CHGIC_WriteCmd0x12L,BatLearnEnable); //ANGELAS016:Change charge IC option setting. read to wri
             -te
2250   1          if (!bRWSMBus(SMbusChB, SMbusWW, Charger_Addr, C_ChargerMode, &CHGIC_WriteCmd0x12L,SMBus_NoPEC)) //ANG
             -ELAS016:Change charge IC option setting. read to write
2251   1          {
2252   2                      CHGIC_SMbusFailCnt++;
2253   2                      RamDebug(0x13);
2254   2          }
2255   1      }
2256          void BATT_LEN_ON(void)
2257          {
2258   1              SET_MASK(CHGIC_WriteCmd0x12L,BatLearnEnable); //ANGELAS016:Change charge IC option setting. read to writ
             -e
2259   1              if (!bRWSMBus(SMbusChB, SMbusWW, Charger_Addr, C_ChargerMode, &CHGIC_WriteCmd0x12L,SMBus_NoPEC)) //ANGELA
             -S016:Change charge IC option setting. read to write
2260   1          {
2261   2                      CHGIC_SMbusFailCnt++;
2262   2                      RamDebug(0x12);
2263   2          }
2264   1      }
2265          //JERRYCRZ010:E+Through the charger IC option control battery learn mode.
2266          //ANGELAS070:add start
2267          const SRTVTstruct code RTVTTable [] =
2268          {
2269                  {20,0x040E},
2270                  {21,0x0409},
2271                  {22,0x0404},
2272                  {23,0x03FF},
2273                  {24,0x03F9},
2274                  {25,0x03F4},
2275                  {26,0x03EE},
2276                  {27,0x03E8},
2277                  {28,0x03E2},
2278                  {29,0x03DB},
2279                  {30,0x03D5},
2280                  {31,0x03CE},
2281                  {32,0x03C7},
2282                  {33,0x03C0},
2283                  {34,0x03B9},
2284                  {35,0x03B1},
2285                  {36,0x03AA},
2286                  {37,0x03A2},
2287                  {38,0x039A},
2288                  {39,0x0392},
2289                  {40,0x0389},
2290                  {41,0x0381},
2291                  {42,0x0378},
2292                  {43,0x0370},
2293                  {44,0x0367},
2294                  {45,0x035E},
2295                  {46,0x0354},
2296                  {47,0x034B},
2297                  {48,0x0342},
2298                  {49,0x0338},
2299                  {50,0x032E},
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 39  

2300                  {51,0x0324},
2301                  {52,0x031A},
2302                  {53,0x0310},
2303                  {54,0x0306},
2304                  {55,0x02FC},
2305                  {56,0x02F2},
2306                  {57,0x02E7},
2307                  {58,0x02DD},
2308                  {59,0x02D2},
2309                  {60,0x02C8},
2310                  {61,0x02BD},
2311                  {62,0x02B2},
2312                  {63,0x02A8},
2313                  {64,0x029D},
2314                  {65,0x0292},
2315                  {66,0x0287},
2316                  {67,0x027D},
2317                  {68,0x0272},
2318                  {69,0x0267},
2319                  {70,0x025D},
2320                  {71,0x0252},
2321                  {72,0x0247},
2322                  {73,0x023D},
2323                  {74,0x0232},
2324                  {75,0x0228},
2325                  {76,0x021E},
2326                  {77,0x0213},
2327                  {78,0x0209},
2328                  {79,0x01FF},
2329                  {80,0x01F5},
2330                  {81,0x01EB},
2331                  {82,0x01E1},
2332                  {83,0x01D7},
2333                  {84,0x01CE},
2334                  {85,0x01C4},
2335                  {86,0x01BB},
2336                  {87,0x01B1},
2337                  {88,0x01A8},
2338                  {89,0x019F},
2339                  {90,0x0196},
2340                  {91,0x018E},
2341                  {92,0x0185},
2342                  {93,0x017C},
2343                  {94,0x0174},
2344                  {95,0x016C},
2345                  {96,0x0164},
2346                  {97,0x015C},
2347                  {98,0x0154},
2348                  {99,0x014C},
2349                  {100,0x0145},
2350                  {101,0x013D},
2351                  {102,0x0136},
2352                  {103,0x012F},
2353                  {104,0x0128},
2354                  {105,0x0121},
2355                  {106,0x011A},
2356          
2357          };
2358          
2359          void PollingCPURT(void)
2360          {
2361   1              BYTE i;
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 40  

2362   1              BYTE j=0;
2363   1      
2364   1              for (i=0;i<(sizeof(RTVTTable)/sizeof(SRTVTstruct));i++)
2365   1              {
2366   2                      if(NTC_V2<RTVTTable[j].VOL)
2367   2                      {
2368   3                              j++;
2369   3                      }
2370   2                      else if(NTC_V2>=RTVTTable[j].VOL)
2371   2                      {
2372   3                              ThermistorCPU_TEMP=RTVTTable[j].TEM;//JERRYCRZ024:Change fan table follow thermal team.
2373   3                              return;
2374   3                      }       
2375   2              }
2376   1      }
2377          
2378          
2379          void PollingGPURT(void)
2380          {
2381   1              BYTE i;
2382   1              BYTE j=0;
2383   1      
2384   1              for (i=0;i<(sizeof(RTVTTable)/sizeof(SRTVTstruct));i++)
2385   1              {
2386   2                      if(NTC_V1<RTVTTable[j].VOL)
2387   2                      {
2388   3                              j++;
2389   3                      }
2390   2                      else if(NTC_V1>=RTVTTable[j].VOL)
2391   2                      {
2392   3                              EXTVGA_TEMP=RTVTTable[j].TEM;//JERRYCRZ024:Change fan table follow thermal team.
2393   3                              return;
2394   3                      }               
2395   2              }
2396   1      }
2397          //ANGELAS070:add end
2398          
2399          //ANGELAG015: add start
2400          void Clear_Batt_First_Used_Date(void)
2401          {
2402   1              if(IS_MASK_SET(SEL_STATE0,PRESENT_A)) 
2403   1                {
2404   2                      if(IS_MASK_SET(pProject0,b1uFUdayClr))
2405   2                      {
2406   3                              if(!bRWSMBus(SMbusChB,SMbusRW,SmBat_Addr,FirstUsedDate,&batteryFirstUsedDateL,SMBus_NeedPEC))
2407   3                              {
2408   4                                      RamDebug(0xAE);
2409   4                                      return;
2410   4                              }
2411   3                              if(batteryFirstUsedDateH != 0x00 || batteryFirstUsedDateL != 0x00)
2412   3                              {
2413   4                                      batteryFirstUsedDateH = 0x00;
2414   4                                      batteryFirstUsedDateL = 0x00;
2415   4                                      if(!bRWSMBus(SMbusChB,SMbusWW,SmBat_Addr,FirstUsedDate,&batteryFirstUsedDateL,SMBus_NeedPEC))
2416   4                                      {
2417   5                                              RamDebug(0xAD);
2418   5                                              return;
2419   5                                      }
2420   4                              }
2421   3                              else
2422   3                              {
2423   4                                      CLEAR_MASK(pProject0,b1uFUdayClr);
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 41  

2424   4                              }
2425   3                      }
2426   2      
2427   2                }
2428   1      }
2429          //ANGELAG015: add end
2430          // 72JERRY013: Start Support fast charging and modify charger IC setting
2431          /* **************************************************************************************
2432          * Battery_Expresscharge():
2433          * 1. Battery Support Express charging
2434          * 2. Lenovo App Control Express charging
2435          *****************************************************************************************/
2436          void Battery_Expresscharge(void)
2437          {
2438   1         if(IS_MASK_CLEAR(EC_C_modeL,b4QuickChargeMode))
2439   1         {
2440   2          return;
2441   2         }//check support quick charge?
2442   1         if (IS_MASK_SET(OEMControl,Expresschargemode))
2443   1         { 
2444   2                      if(IS_MASK_CLEAR(Bat0x3ETempH,Expresscharge_mode))
2445   2                      {
2446   3                              SET_MASK(Bat0x3ETempH,Expresscharge_mode);
2447   3                              if(bRWSMBus(SMbusChB,SMbusWW,SmBat_Addr,C_LVMfgFun2,&Bat0x3ETempL,SMBus_NeedPEC))
2448   3                              {
2449   4                                      RamDebug(0xD1);
2450   4                              }
2451   3             }
2452   2              }
2453   1              else
2454   1              {
2455   2                      if(IS_MASK_SET(Bat0x3ETempH,Expresscharge_mode))
2456   2                      {
2457   3                              CLEAR_MASK(Bat0x3ETempH,Expresscharge_mode);
2458   3                              if(bRWSMBus(SMbusChB,SMbusWW,SmBat_Addr,C_LVMfgFun2,&Bat0x3ETempL,SMBus_NeedPEC))
2459   3                              {
2460   4                                      RamDebug(0xD2);
2461   4                              }
2462   3                      }
2463   2              }
2464   1      }
2465          // 72JERRY013: End
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 42  

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION Com0217 (BEGIN)
0000         L?0536:
0000 E4                CLR     A
0001 900000      E     MOV     DPTR,#WSMbusTemp01
0004 F0                MOVX    @DPTR,A
0005 7410              MOV     A,#010H
0007         L?0537:
0007 900000      E     MOV     DPTR,#WSMbusTemp02
000A         L?0538:
000A F0                MOVX    @DPTR,A
000B 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+03H
000E 7434              MOV     A,#034H
0010 F0                MOVX    @DPTR,A
0011 7E00        E     MOV     R6,#HIGH WSMbusTemp01
0013 A3                INC     DPTR
0014 7400        E     MOV     A,#HIGH WSMbusTemp01
0016 F0                MOVX    @DPTR,A
0017 7400        E     MOV     A,#LOW WSMbusTemp01
0019         L?0539:
0019 A3                INC     DPTR
001A         L?0540:
001A F0                MOVX    @DPTR,A
001B A3                INC     DPTR
001C 7401              MOV     A,#01H
001E F0                MOVX    @DPTR,A
001F 7B16              MOV     R3,#016H
0021 7D8C              MOV     R5,#08CH
0023 FF                MOV     R7,A
0024 22                RET     
0025         L?0541:
0025         L?0542:
0025 900000      E     MOV     DPTR,#nRemainingCapH
0028 E0                MOVX    A,@DPTR
0029 900000      E     MOV     DPTR,#nRemainingCapL
002C         L?0543:
002C FE                MOV     R6,A
002D         L?0544:
002D E0                MOVX    A,@DPTR
002E 7C00              MOV     R4,#00H
0030 2400              ADD     A,#00H
0032 FF                MOV     R7,A
0033 EC                MOV     A,R4
0034 3E                ADDC    A,R6
0035 22                RET     
0036         L?0545:
0036 900000      E     MOV     DPTR,#AddrX_Low
0039 E0                MOVX    A,@DPTR
003A 2404              ADD     A,#04H
003C F0                MOVX    @DPTR,A
003D 900000      E     MOV     DPTR,#AddrZ_Low
0040 E0                MOVX    A,@DPTR
0041 2404              ADD     A,#04H
0043 F0                MOVX    @DPTR,A
0044 900000      E     MOV     DPTR,#Cal_CTRL
0047 7420              MOV     A,#020H
0049 F0                MOVX    @DPTR,A
004A 900000      E     MOV     DPTR,#AddrX_Low
004D E0                MOVX    A,@DPTR
004E 2404              ADD     A,#04H
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 43  

0050 F0                MOVX    @DPTR,A
0051 900000      E     MOV     DPTR,#AddrZ_Low
0054 E0                MOVX    A,@DPTR
0055 2404              ADD     A,#04H
0057         L?0546:
0057 F0                MOVX    @DPTR,A
0058 900000      E     MOV     DPTR,#Cal_CTRL
005B 7420              MOV     A,#020H
005D F0                MOVX    @DPTR,A
005E 22                RET     
005F         L?0547:
005F 900000      R     MOV     DPTR,#_STEP
0062 E0                MOVX    A,@DPTR
0063 FF                MOV     R7,A
0064 25E0              ADD     A,ACC
0066 25E0              ADD     A,ACC
0068 2400        R     ADD     A,#LOW ABatCommandTable
006A F582              MOV     DPL,A
006C E4                CLR     A
006D 3400        R     ADDC    A,#HIGH ABatCommandTable
006F F583              MOV     DPH,A
0071 E4                CLR     A
0072 93                MOVC    A,@A+DPTR
0073 FE                MOV     R6,A
0074 EF                MOV     A,R7
0075         L?0548:
0075 25E0              ADD     A,ACC
0077 25E0              ADD     A,ACC
0079 2400        R     ADD     A,#LOW ABatCommandTable+01H
007B F582              MOV     DPL,A
007D E4                CLR     A
007E 3400        R     ADDC    A,#HIGH ABatCommandTable+01H
0080 F583              MOV     DPH,A
0082 E4                CLR     A
0083 93                MOVC    A,@A+DPTR
0084 22                RET     
0085         L?0549:
0085 FE                MOV     R6,A
0086 E4                CLR     A
0087 FD                MOV     R5,A
0088 900000      E     MOV     DPTR,#CalcBatRCC
008B 120000      E     LCALL   ?C?LSTXDATA
008E E4                CLR     A
008F 7BC8              MOV     R3,#0C8H
0091 FA                MOV     R2,A
0092 F9                MOV     R1,A
0093 F8                MOV     R0,A
0094 900000      E     MOV     DPTR,#CalcBatRCC
0097 120000      E     LCALL   ?C?LLDXDATA
009A 120000      E     LCALL   ?C?ULDIV
009D C8                XCH     A,R0
009E EC                MOV     A,R4
009F C8                XCH     A,R0
00A0 C9                XCH     A,R1
00A1 ED                MOV     A,R5
00A2 C9                XCH     A,R1
00A3 CA                XCH     A,R2
00A4 EE                MOV     A,R6
00A5 CA                XCH     A,R2
00A6 CB                XCH     A,R3
00A7 EF                MOV     A,R7
00A8 CB                XCH     A,R3
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 44  

00A9 900000      E     MOV     DPTR,#KeepBattRemineCap
00AC         L?0550:
00AC E0                MOVX    A,@DPTR
00AD FE                MOV     R6,A
00AE A3                INC     DPTR
00AF E0                MOVX    A,@DPTR
00B0 FF                MOV     R7,A
00B1 E4                CLR     A
00B2 FC                MOV     R4,A
00B3 FD                MOV     R5,A
00B4 22                RET     
00B5         L?0551:
00B5         L?0552:
00B5 75F003            MOV     B,#03H
00B8 EF                MOV     A,R7
00B9 900000      R     MOV     DPTR,#RTVTTable+01H
00BC 120000      E     LCALL   ?C?OFFXADD
00BF E4                CLR     A
00C0 93                MOVC    A,@A+DPTR
00C1 FC                MOV     R4,A
00C2 7401              MOV     A,#01H
00C4 93                MOVC    A,@A+DPTR
00C5 FD                MOV     R5,A
00C6 C3                CLR     C
00C7 22                RET     
00C8         L?0553:
00C8 F0                MOVX    @DPTR,A
00C9 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+03H
00CC 7412              MOV     A,#012H
00CE F0                MOVX    @DPTR,A
00CF 7E00        E     MOV     R6,#HIGH CHGIC_WriteCmd0x12L
00D1 A3                INC     DPTR
00D2 7400        E     MOV     A,#HIGH CHGIC_WriteCmd0x12L
00D4 F0                MOVX    @DPTR,A
00D5 7400        E     MOV     A,#LOW CHGIC_WriteCmd0x12L
00D7         L?0554:
00D7 A3                INC     DPTR
00D8 F0                MOVX    @DPTR,A
00D9 E4                CLR     A
00DA A3                INC     DPTR
00DB F0                MOVX    @DPTR,A
00DC 7B12              MOV     R3,#012H
00DE 7D8C              MOV     R5,#08CH
00E0 7F01              MOV     R7,#01H
00E2 22                RET     
00E3         L?0555:
00E3 900000      E     MOV     DPTR,#Psys_AvgData+01H
00E6         L?0556:
00E6 E0                MOVX    A,@DPTR
00E7 9493              SUBB    A,#093H
00E9         L?0557:
00E9 900000      E     MOV     DPTR,#Psys_AvgData
00EC E0                MOVX    A,@DPTR
00ED 9401              SUBB    A,#01H
00EF 22                RET     
00F0         L?0558:
00F0 E0                MOVX    A,@DPTR
00F1 FC                MOV     R4,A
00F2 A3                INC     DPTR
00F3 E0                MOVX    A,@DPTR
00F4 FD                MOV     R5,A
00F5 E4                CLR     A
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 45  

00F6 120000      E     LCALL   ?C?FCASTI
00F9 7BCD              MOV     R3,#0CDH
00FB 7ACC              MOV     R2,#0CCH
00FD 79CC              MOV     R1,#0CCH
00FF 783D              MOV     R0,#03DH
0101 120000      E     LCALL   ?C?FPMUL
0104 E4                CLR     A
0105 FB                MOV     R3,A
0106 FA                MOV     R2,A
0107 79C8              MOV     R1,#0C8H
0109 7842              MOV     R0,#042H
010B 020000      E     LJMP    ?C?FPDIV
010E         L?0559:
010E         L?0560:
010E 900000      E     MOV     DPTR,#Bat0x0FTempL
0111 E0                MOVX    A,@DPTR
0112 900000      E     MOV     DPTR,#nRemainingCapL
0115 F0                MOVX    @DPTR,A
0116 900000      E     MOV     DPTR,#Bat0x0FTempH
0119 22                RET     
011A         L?0562:
011A         L?0563:
011A 900000      E     MOV     DPTR,#SysPowState
011D E0                MOVX    A,@DPTR
011E 6410              XRL     A,#010H
0120 22                RET     
0121         L?0564:
0121 2400              ADD     A,#00H
0123 FF                MOV     R7,A
0124 EC                MOV     A,R4
0125 3E                ADDC    A,R6
0126 F0                MOVX    @DPTR,A
0127 A3                INC     DPTR
0128 EF                MOV     A,R7
0129 F0                MOVX    @DPTR,A
012A 22                RET     
012B         L?0565:
012B         L?0566:
012B E4                CLR     A
012C         L?0567:
012C 75F001            MOV     B,#01H
012F 020000      E     LJMP    ?C?IILDX
0132         L?0568:
0132 900000      R     MOV     DPTR,#i
0135 E0                MOVX    A,@DPTR
0136 25E0              ADD     A,ACC
0138 25E0              ADD     A,ACC
013A 2400        R     ADD     A,#LOW ABatCommandTable+03H
013C F582              MOV     DPL,A
013E E4                CLR     A
013F 3400        R     ADDC    A,#HIGH ABatCommandTable+03H
0141 F583              MOV     DPH,A
0143 E4                CLR     A
0144 93                MOVC    A,@A+DPTR
0145 22                RET     
0146         L?0569:
0146 900000      E     MOV     DPTR,#XWTemp1+01H
0149         L?0570:
0149 FE                MOV     R6,A
014A C3                CLR     C
014B 74FF              MOV     A,#0FFH
014D 9F                SUBB    A,R7
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 46  

014E F0                MOVX    @DPTR,A
014F 74FF              MOV     A,#0FFH
0151 9E                SUBB    A,R6
0152 22                RET     
0153         L?0571:
0153         L?0572:
0153 900000      E     MOV     DPTR,#nBattGasgauge
0156 E0                MOVX    A,@DPTR
0157 FF                MOV     R7,A
0158 900000      E     MOV     DPTR,#cTargetGauge
015B E0                MOVX    A,@DPTR
015C 6F                XRL     A,R7
015D 22                RET     
015E         L?0573:
015E         L?0574:
015E E0                MOVX    A,@DPTR
015F 54EF              ANL     A,#0EFH
0161 F0                MOVX    @DPTR,A
0162 900000      E     MOV     DPTR,#nBatteryStatH
0165 E0                MOVX    A,@DPTR
0166 54FD              ANL     A,#0FDH
0168 22                RET     
0169         L?0575:
0169 E0                MOVX    A,@DPTR
016A 900000      E     MOV     DPTR,#nRemainingCapH
016D F0                MOVX    @DPTR,A
016E 900000      E     MOV     DPTR,#LENOVOPMFW_Temp
0171 E0                MOVX    A,@DPTR
0172 4401              ORL     A,#01H
0174 F0                MOVX    @DPTR,A
0175 900000      E     MOV     DPTR,#nBattGasgauge
0178 E0                MOVX    A,@DPTR
0179 22                RET     
017A         L?0576:
017A 900000      E     MOV     DPTR,#nFullChgCapL
017D E0                MOVX    A,@DPTR
017E 900000      E     MOV     DPTR,#ChkBattery_FCCchg_lastFCCL
0181 F0                MOVX    @DPTR,A
0182 900000      E     MOV     DPTR,#nFullChgCapH
0185 E0                MOVX    A,@DPTR
0186 900000      E     MOV     DPTR,#ChkBattery_FCCchg_lastFCCH
0189 F0                MOVX    @DPTR,A
018A 22                RET     
018B         L?0577:
018B F0                MOVX    @DPTR,A
018C 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+03H
018F 743E              MOV     A,#03EH
0191 F0                MOVX    @DPTR,A
0192 7E00        E     MOV     R6,#HIGH Bat0x3ETempL
0194 A3                INC     DPTR
0195 7400        E     MOV     A,#HIGH Bat0x3ETempL
0197 F0                MOVX    @DPTR,A
0198 A3                INC     DPTR
0199 7400        E     MOV     A,#LOW Bat0x3ETempL
019B 22                RET     
019C         L?0578:
019C         L?0579:
019C CB                XCH     A,R3
019D EF                MOV     A,R7
019E CB                XCH     A,R3
019F FA                MOV     R2,A
01A0 E4                CLR     A
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 47  

01A1 F9                MOV     R1,A
01A2 F8                MOV     R0,A
01A3 22                RET     
01A4         L?0580:
01A4 900000      E     MOV     DPTR,#S3ResumeRSOC
01A7         L?0581:
01A7 E0                MOVX    A,@DPTR
01A8 FF                MOV     R7,A
01A9 900000      E     MOV     DPTR,#nBattGasgauge
01AC E0                MOVX    A,@DPTR
01AD 22                RET     
01AE         L?0582:
01AE A3                INC     DPTR
01AF F0                MOVX    @DPTR,A
01B0 E4                CLR     A
01B1 A3                INC     DPTR
01B2         L?0583:
01B2 F0                MOVX    @DPTR,A
01B3 7B16              MOV     R3,#016H
01B5 7D0C              MOV     R5,#0CH
01B7 7F01              MOV     R7,#01H
01B9 22                RET     
01BA         L?0584:
01BA         L?0585:
01BA 900000      E     MOV     DPTR,#SMbusFailCnt3
01BD E0                MOVX    A,@DPTR
01BE 04                INC     A
01BF F0                MOVX    @DPTR,A
01C0 22                RET     
01C1         L?0586:
01C1         L?0587:
01C1 900000      E     MOV     DPTR,#SMbusFailCnt2
01C4 E0                MOVX    A,@DPTR
01C5 04                INC     A
01C6 F0                MOVX    @DPTR,A
01C7 22                RET     
01C8         L?0588:
01C8 900000      R     MOV     DPTR,#sCmd
01CB F0                MOVX    @DPTR,A
01CC 7B01              MOV     R3,#01H
01CE 22                RET     
01CF         L?0589:
01CF 900000      E     MOV     DPTR,#BatteryAlarm
01D2 E0                MOVX    A,@DPTR
01D3 54FD              ANL     A,#0FDH
01D5 F0                MOVX    @DPTR,A
01D6 900000      E     MOV     DPTR,#nStopChgStat3L
01D9 E0                MOVX    A,@DPTR
01DA 547F              ANL     A,#07FH
01DC F0                MOVX    @DPTR,A
01DD 22                RET     
01DE         L?0590:
01DE 900000      E     MOV     DPTR,#nStopChgStat3H
01E1 E0                MOVX    A,@DPTR
01E2 54BF              ANL     A,#0BFH
01E4 F0                MOVX    @DPTR,A
01E5 900000      E     MOV     DPTR,#nBattGasgauge
01E8 E0                MOVX    A,@DPTR
01E9 643C              XRL     A,#03CH
01EB 22                RET     
01EC         L?0591:
01EC         L?0592:
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 48  

01EC 900000      E     MOV     DPTR,#cBattFlag0
01EF E0                MOVX    A,@DPTR
01F0 13                RRC     A
01F1 13                RRC     A
01F2 543F              ANL     A,#03FH
01F4 22                RET     
01F5         L?0593:
01F5 FE                MOV     R6,A
01F6 E0                MOVX    A,@DPTR
01F7 7C00              MOV     R4,#00H
01F9 2400              ADD     A,#00H
01FB F500        E     MOV     ITempW01+01H,A
01FD EC                MOV     A,R4
01FE 3E                ADDC    A,R6
01FF F500        E     MOV     ITempW01,A
0201 D3                SETB    C
0202 22                RET     
0203         L?0594:
0203         L?0595:
0203 E0                MOVX    A,@DPTR
0204 FF                MOV     R7,A
0205 900000      E     MOV     DPTR,#nBattAverTemp
0208 E0                MOVX    A,@DPTR
0209 C3                CLR     C
020A 9F                SUBB    A,R7
020B 22                RET     
020C         L?0596:
020C C3                CLR     C
020D 900000      R     MOV     DPTR,#CV1+01H
0210 E0                MOVX    A,@DPTR
0211 94B8              SUBB    A,#0B8H
0213 900000      R     MOV     DPTR,#CV1
0216 E0                MOVX    A,@DPTR
0217 940B              SUBB    A,#0BH
0219 22                RET     
021A         L?0597:
021A C3                CLR     C
021B 900000      R     MOV     DPTR,#CV4+01H
021E E0                MOVX    A,@DPTR
021F 94B8              SUBB    A,#0B8H
0221 900000      R     MOV     DPTR,#CV4
0224 E0                MOVX    A,@DPTR
0225 940B              SUBB    A,#0BH
0227 22                RET     
0228         L?0598:
0228 C3                CLR     C
0229 900000      E     MOV     DPTR,#Psys_AvgData+01H
022C E0                MOVX    A,@DPTR
022D 94F6              SUBB    A,#0F6H
022F 900000      E     MOV     DPTR,#Psys_AvgData
0232 E0                MOVX    A,@DPTR
0233 9400              SUBB    A,#00H
0235 22                RET     
0236         L?0599:
0236         L?0600:
0236 900000      E     MOV     DPTR,#nDesignVoltH
0239 E0                MOVX    A,@DPTR
023A FE                MOV     R6,A
023B 900000      E     MOV     DPTR,#nDesignVoltL
023E 22                RET     
023F         L?0601:
023F A3                INC     DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 49  

0240         L?0602:
0240 F0                MOVX    @DPTR,A
0241 7B16              MOV     R3,#016H
0243 7D14              MOV     R5,#014H
0245 7F01              MOV     R7,#01H
0247 22                RET     
0248         L?0603:
0248 900000      R     MOV     DPTR,#CV2+01H
024B E0                MOVX    A,@DPTR
024C 94B8              SUBB    A,#0B8H
024E 900000      R     MOV     DPTR,#CV2
0251 E0                MOVX    A,@DPTR
0252 940B              SUBB    A,#0BH
0254 22                RET     
0255         L?0604:
0255 900000      R     MOV     DPTR,#CV3+01H
0258 E0                MOVX    A,@DPTR
0259 94B8              SUBB    A,#0B8H
025B 900000      R     MOV     DPTR,#CV3
025E E0                MOVX    A,@DPTR
025F 940B              SUBB    A,#0BH
0261 22                RET     
0262         L?0605:
0262 F0                MOVX    @DPTR,A
0263 A3                INC     DPTR
0264 EF                MOV     A,R7
0265 F0                MOVX    @DPTR,A
0266 900000      E     MOV     DPTR,#OCPCapacityRelease
0269 E0                MOVX    A,@DPTR
026A FE                MOV     R6,A
026B A3                INC     DPTR
026C E0                MOVX    A,@DPTR
026D FF                MOV     R7,A
026E 22                RET     
026F         L?0606:
026F         L?0607:
026F 900000      E     MOV     DPTR,#CHGIC_SMbusFailCnt
0272 E0                MOVX    A,@DPTR
0273 04                INC     A
0274 F0                MOVX    @DPTR,A
0275 22                RET     
0276         L?0608:
0276 75F003            MOV     B,#03H
0279 EF                MOV     A,R7
027A 900000      R     MOV     DPTR,#RTVTTable
027D 120000      E     LCALL   ?C?OFFXADD
0280 E4                CLR     A
0281 93                MOVC    A,@A+DPTR
0282 22                RET     
0283         L?0609:
0283 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+03H
0286 743F              MOV     A,#03FH
0288 F0                MOVX    @DPTR,A
0289 7E00        E     MOV     R6,#HIGH batteryFirstUsedDateL
028B A3                INC     DPTR
028C 7400        E     MOV     A,#HIGH batteryFirstUsedDateL
028E F0                MOVX    @DPTR,A
028F 22                RET     
0290         L?0610:
0290         L?0611:
0290 900000      E     MOV     DPTR,#nBattGasgauge
0293 E0                MOVX    A,@DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 50  

0294 C3                CLR     C
0295 9437              SUBB    A,#037H
0297 22                RET     
0298         L?0612:
0298 900000      E     MOV     DPTR,#nFullChgCapL
029B E0                MOVX    A,@DPTR
029C 900000      E     MOV     DPTR,#nRemainingCapL
029F F0                MOVX    @DPTR,A
02A0 900000      E     MOV     DPTR,#nFullChgCapH
02A3 22                RET     
02A4         L?0613:
02A4         L?0614:
02A4 900000      E     MOV     DPTR,#ACOFF_SOURCE
02A7 E0                MOVX    A,@DPTR
02A8 54FB              ANL     A,#0FBH
02AA F0                MOVX    @DPTR,A
02AB 22                RET     
02AC         L?0615:
02AC         L?0616:
02AC 900000      E     MOV     DPTR,#SysStatus
02AF E0                MOVX    A,@DPTR
02B0 4402              ORL     A,#02H
02B2 F0                MOVX    @DPTR,A
02B3 22                RET     
02B4         L?0617:
02B4         L?0618:
02B4 900000      E     MOV     DPTR,#nBattGasgauge
02B7 E0                MOVX    A,@DPTR
02B8 D3                SETB    C
02B9 9414              SUBB    A,#014H
02BB 22                RET     
02BC         L?0619:
02BC         L?0620:
02BC 900000      E     MOV     DPTR,#GPU_Prochot
02BF E0                MOVX    A,@DPTR
02C0 4402              ORL     A,#02H
02C2 F0                MOVX    @DPTR,A
02C3 22                RET     
02C4         L?0621:
02C4 C3                CLR     C
02C5         L?0622:
02C5 900000      E     MOV     DPTR,#nBattGasgauge
02C8 E0                MOVX    A,@DPTR
02C9 9407              SUBB    A,#07H
02CB 22                RET     
02CC         L?0623:
02CC E4                CLR     A
02CD 900000      E     MOV     DPTR,#TrickleChgTimeOutCnt
02D0 F0                MOVX    @DPTR,A
02D1 A3                INC     DPTR
02D2 F0                MOVX    @DPTR,A
02D3 900000      E     MOV     DPTR,#FastChgTimeOutCnt
02D6 22                RET     
02D7         L?0624:
02D7 7BE8              MOV     R3,#0E8H
02D9 7A03              MOV     R2,#03H
02DB F9                MOV     R1,A
02DC F8                MOV     R0,A
02DD 120000      E     LCALL   ?C?LMUL
02E0 EC                MOV     A,R4
02E1 22                RET     
02E2         L?0625:
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 51  

02E2 900000      E     MOV     DPTR,#cBattFlag0
02E5 E0                MOVX    A,@DPTR
02E6 C4                SWAP    A
02E7 13                RRC     A
02E8 13                RRC     A
02E9 13                RRC     A
02EA 5401              ANL     A,#01H
02EC 22                RET     
02ED         L?0626:
02ED 900000      E     MOV     DPTR,#nStopChgStat3H
02F0 E0                MOVX    A,@DPTR
02F1 FF                MOV     R7,A
02F2 900000      E     MOV     DPTR,#nStopChgStat3L
02F5 E0                MOVX    A,@DPTR
02F6 4F                ORL     A,R7
02F7 22                RET     
02F8         L?0627:
02F8 E0                MOVX    A,@DPTR
02F9 4410              ORL     A,#010H
02FB F0                MOVX    @DPTR,A
02FC 900000      E     MOV     DPTR,#nBatteryStatH
02FF E0                MOVX    A,@DPTR
0300 4402              ORL     A,#02H
0302 22                RET     
0303         L?0628:
0303 900000      E     MOV     DPTR,#NTC_V2+01H
0306 E0                MOVX    A,@DPTR
0307 9D                SUBB    A,R5
0308 900000      E     MOV     DPTR,#NTC_V2
030B E0                MOVX    A,@DPTR
030C 9C                SUBB    A,R4
030D 22                RET     
030E         L?0629:
030E 900000      E     MOV     DPTR,#NTC_V1+01H
0311 E0                MOVX    A,@DPTR
0312 9D                SUBB    A,R5
0313 900000      E     MOV     DPTR,#NTC_V1
0316 E0                MOVX    A,@DPTR
0317 9C                SUBB    A,R4
0318 22                RET     
0319         L?0630:
0319 F0                MOVX    @DPTR,A
031A E0                MOVX    A,@DPTR
031B 54FE              ANL     A,#0FEH
031D F0                MOVX    @DPTR,A
031E E0                MOVX    A,@DPTR
031F 54FB              ANL     A,#0FBH
0321 F0                MOVX    @DPTR,A
0322 22                RET     
0323         L?0631:
0323 E4                CLR     A
0324 900000      E     MOV     DPTR,#RSOC1PTO0PCount
0327 F0                MOVX    @DPTR,A
0328 900000      E     MOV     DPTR,#RSOC1PTO0PSaveSpace
032B F0                MOVX    @DPTR,A
032C 22                RET     
032D         L?0632:
032D 900000      E     MOV     DPTR,#GPDRC
0330 E0                MOVX    A,@DPTR
0331 54FE              ANL     A,#0FEH
0333 F0                MOVX    @DPTR,A
0334 7F01              MOV     R7,#01H
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 52  

0336 22                RET     
0337         L?0633:
0337 E4                CLR     A
0338 900000      E     MOV     DPTR,#cGPUBattThrottling
033B F0                MOVX    @DPTR,A
033C 900000      E     MOV     DPTR,#cBATTThrottling
033F F0                MOVX    @DPTR,A
0340 22                RET     
0341         L?0634:
0341 2400              ADD     A,#00H
0343 FF                MOV     R7,A
0344 EC                MOV     A,R4
0345 3E                ADDC    A,R6
0346 F0                MOVX    @DPTR,A
0347 A3                INC     DPTR
0348 EF                MOV     A,R7
0349 F0                MOVX    @DPTR,A
034A 22                RET     
034B         L?0635:
034B D3                SETB    C
034C A3                INC     DPTR
034D E0                MOVX    A,@DPTR
034E 9460              SUBB    A,#060H
0350 900000      R     MOV     DPTR,#DesignVoltage
0353 E0                MOVX    A,@DPTR
0354 22                RET     
0355         L?0636:
0355 900000      R     MOV     DPTR,#sCmd
0358 F0                MOVX    @DPTR,A
0359 7B01              MOV     R3,#01H
035B 22                RET     
             ; FUNCTION Com0217 (END)

             ; FUNCTION UpdateNameSpace (BEGIN)
                                           ; SOURCE LINE # 13
                                           ; SOURCE LINE # 14
                                           ; SOURCE LINE # 15
0000 900000      E     MOV     DPTR,#BAT1PERCL
0003 E0                MOVX    A,@DPTR
0004 900000      E     MOV     DPTR,#nBattGasgauge
0007 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 20
0008 900000      E     MOV     DPTR,#BAT1PERCL
000B E0                MOVX    A,@DPTR
000C D3                SETB    C
000D 9406              SUBB    A,#06H
000F 5010              JNC     ?C0001
0011 900000      E     MOV     DPTR,#SYS_STATUS
0014 E0                MOVX    A,@DPTR
0015 20E709            JB      ACC.7,?C0001
                                           ; SOURCE LINE # 21
                                           ; SOURCE LINE # 22
0018 900000      E     MOV     DPTR,#Thro_Status2
001B E0                MOVX    A,@DPTR
001C 4420              ORL     A,#020H
001E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 23
001F 8007              SJMP    ?C0002
0021         ?C0001:
                                           ; SOURCE LINE # 25
                                           ; SOURCE LINE # 26
0021 900000      E     MOV     DPTR,#Thro_Status2
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 53  

0024 E0                MOVX    A,@DPTR
0025 54DF              ANL     A,#0DFH
0027 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 27
0028         ?C0002:
                                           ; SOURCE LINE # 29
0028 900000      E     MOV     DPTR,#EC_oCCBQl
002B E0                MOVX    A,@DPTR
002C 900000      E     MOV     DPTR,#nCycleCounter
002F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 30
0030 900000      E     MOV     DPTR,#nBattery0x16L
0033 E0                MOVX    A,@DPTR
0034 900000      E     MOV     DPTR,#EC_BatteryStatusL
0037 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 31
0038 900000      E     MOV     DPTR,#nBattery0x16H
003B E0                MOVX    A,@DPTR
003C 900000      E     MOV     DPTR,#EC_BatteryStatusH
003F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 33
0040 900000      E     MOV     DPTR,#nBattery0x16L
0043 E0                MOVX    A,@DPTR
0044 30E521            JNB     ACC.5,?C0003
                                           ; SOURCE LINE # 34
                                           ; SOURCE LINE # 35
0047 900000      E     MOV     DPTR,#nBatteryStatus1
004A E0                MOVX    A,@DPTR
004B 4402              ORL     A,#02H
004D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 37
004E 900000      E     MOV     DPTR,#nBattGasgauge
0051 E0                MOVX    A,@DPTR
0052 6464              XRL     A,#064H
0054 7020              JNZ     ?C0006
                                           ; SOURCE LINE # 38
                                           ; SOURCE LINE # 39
0056 900000      E     MOV     DPTR,#LENOVOPMFW_Temp
0059 E0                MOVX    A,@DPTR
005A 20E219            JB      ACC.2,?C0006
                                           ; SOURCE LINE # 40
                                           ; SOURCE LINE # 41
005D E0                MOVX    A,@DPTR
005E 4404              ORL     A,#04H
0060 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 42
0061 7F25              MOV     R7,#025H
0063 120000      E     LCALL   _ECSMI_SCIEvent
                                           ; SOURCE LINE # 43
                                           ; SOURCE LINE # 44
                                           ; SOURCE LINE # 45
0066 800E              SJMP    ?C0006
0068         ?C0003:
                                           ; SOURCE LINE # 47
                                           ; SOURCE LINE # 48
0068 900000      E     MOV     DPTR,#nBatteryStatus1
006B E0                MOVX    A,@DPTR
006C 54FD              ANL     A,#0FDH
006E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 49
006F 900000      E     MOV     DPTR,#LENOVOPMFW_Temp
0072 E0                MOVX    A,@DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 54  

0073 54FB              ANL     A,#0FBH
0075 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 50
0076         ?C0006:
                                           ; SOURCE LINE # 52
0076 120000      R     LCALL   Lenovo_Battery_EM80
                                           ; SOURCE LINE # 64
0079 900000      E     MOV     DPTR,#testtoolflag
007C E0                MOVX    A,@DPTR
007D 6003              JZ      $ + 5H
007F 020000      R     LJMP    ?C0007
                                           ; SOURCE LINE # 65
                                           ; SOURCE LINE # 66
0082 900000      E     MOV     DPTR,#LENOVOPMFW
0085 E0                MOVX    A,@DPTR
0086 30E47C            JNB     ACC.4,?C0008
0089 E0                MOVX    A,@DPTR
008A 20E278            JB      ACC.2,?C0008
                                           ; SOURCE LINE # 67
                                           ; SOURCE LINE # 68
                                           ; SOURCE LINE # 69
008D 120000      R     LCALL   L?0559
                                           ; SOURCE LINE # 71
                                           ; SOURCE LINE # 73
0090 120000      R     LCALL   L?0575
0093 C3                CLR     C
0094 9437              SUBB    A,#037H
0096 4062              JC      ?C0009
                                           ; SOURCE LINE # 74
                                           ; SOURCE LINE # 75
0098 900000      E     MOV     DPTR,#ACOFF_SOURCE
009B E0                MOVX    A,@DPTR
009C 30E205            JNB     ACC.2,?C0010
                                           ; SOURCE LINE # 76
                                           ; SOURCE LINE # 77
009F 7F25              MOV     R7,#025H
00A1 120000      E     LCALL   _ECSMI_SCIEvent
                                           ; SOURCE LINE # 78
00A4         ?C0010:
                                           ; SOURCE LINE # 79
                                           ; SOURCE LINE # 80
00A4 120000      R     LCALL   L?0561
                                           ; SOURCE LINE # 82
00A7 900000      E     MOV     DPTR,#StatusKeeper
00AA E0                MOVX    A,@DPTR
00AB 20E103            JB      ACC.1,?C0011
                                           ; SOURCE LINE # 83
                                           ; SOURCE LINE # 84
                                           ; SOURCE LINE # 85
00AE 020000      R     LJMP    ?C0485
00B1         ?C0011:
                                           ; SOURCE LINE # 87
                                           ; SOURCE LINE # 88
                                           ; SOURCE LINE # 89
00B1 120000      R     LCALL   L?0590
00B4 6003              JZ      $ + 5H
00B6 020000      R     LJMP    ?C0048
                                           ; SOURCE LINE # 90
                                           ; SOURCE LINE # 91
00B9 900000      E     MOV     DPTR,#KeepBattRemineCap
00BC E0                MOVX    A,@DPTR
00BD 7002              JNZ     ?C0478
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 55  

00BF A3                INC     DPTR
00C0 E0                MOVX    A,@DPTR
00C1         ?C0478:
00C1 7003              JNZ     ?C0014
                                           ; SOURCE LINE # 92
                                           ; SOURCE LINE # 93
                                           ; SOURCE LINE # 94
00C3 020000      R     LJMP    ?C0486
00C6         ?C0014:
                                           ; SOURCE LINE # 96
                                           ; SOURCE LINE # 97
00C6 900000      E     MOV     DPTR,#nFullChgCapH
00C9 E0                MOVX    A,@DPTR
00CA 900000      E     MOV     DPTR,#nFullChgCapL
00CD 120000      R     LCALL   L?0543
                                           ; SOURCE LINE # 100
00D0 120000      R     LCALL   L?0549
00D3 120000      E     LCALL   ?C?LADD
00D6 EC                MOV     A,R4
00D7 C0E0              PUSH    ACC
00D9 EE                MOV     A,R6
00DA C0E0              PUSH    ACC
00DC EF                MOV     A,R7
00DD C0E0              PUSH    ACC
00DF 120000      R     LCALL   L?0541
00E2 120000      R     LCALL   L?0578
00E5 D0E0              POP     ACC
00E7 FF                MOV     R7,A
00E8 D0E0              POP     ACC
00EA FE                MOV     R6,A
00EB D0E0              POP     ACC
00ED FC                MOV     R4,A
00EE D3                SETB    C
00EF 120000      E     LCALL   ?C?ULCMP
00F2 5003              JNC     $ + 5H
00F4 020000      R     LJMP    ?C0048
                                           ; SOURCE LINE # 101
                                           ; SOURCE LINE # 102
                                           ; SOURCE LINE # 103
                                           ; SOURCE LINE # 104
                                           ; SOURCE LINE # 105
                                           ; SOURCE LINE # 106
                                           ; SOURCE LINE # 107
                                           ; SOURCE LINE # 108
                                           ; SOURCE LINE # 111
00F7 020000      R     LJMP    ?C0487
00FA         ?C0009:
                                           ; SOURCE LINE # 112
00FA 120000      R     LCALL   L?0610
00FD 4003              JC      $ + 5H
00FF 020000      R     LJMP    ?C0048
                                           ; SOURCE LINE # 113
                                           ; SOURCE LINE # 114
                                           ; SOURCE LINE # 115
                                           ; SOURCE LINE # 117
                                           ; SOURCE LINE # 118
                                           ; SOURCE LINE # 120
                                           ; SOURCE LINE # 121
0102 020000      R     LJMP    ?C0488
0105         ?C0008:
                                           ; SOURCE LINE # 123
                                           ; SOURCE LINE # 125
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 56  

0105 900000      E     MOV     DPTR,#EC_BatteryStatusL
0108 E0                MOVX    A,@DPTR
0109 30E513            JNB     ACC.5,?C0020
010C 900000      E     MOV     DPTR,#SYS_STATUS
010F E0                MOVX    A,@DPTR
0110 30E70C            JNB     ACC.7,?C0020
0113 900000      E     MOV     DPTR,#nBattGasgauge
0116 E0                MOVX    A,@DPTR
0117 B46405            CJNE    A,#064H,?C0020
                                           ; SOURCE LINE # 126
                                           ; SOURCE LINE # 127
                                           ; SOURCE LINE # 128
011A 120000      R     LCALL   L?0612
                                           ; SOURCE LINE # 129
011D 800B              SJMP    ?C0489
011F         ?C0020:
                                           ; SOURCE LINE # 131
                                           ; SOURCE LINE # 133
011F 900000      E     MOV     DPTR,#ChkBattery_abnormal_status
0122 E0                MOVX    A,@DPTR
0123 6402              XRL     A,#02H
0125 6008              JZ      ?C0021
                                           ; SOURCE LINE # 134
                                           ; SOURCE LINE # 137
0127         ?C0022:
                                           ; SOURCE LINE # 139
                                           ; SOURCE LINE # 140
                                           ; SOURCE LINE # 141
0127 120000      R     LCALL   L?0559
012A         ?C0489:
012A E0                MOVX    A,@DPTR
012B 900000      E     MOV     DPTR,#nRemainingCapH
012E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 142
                                           ; SOURCE LINE # 143
012F         ?C0021:
                                           ; SOURCE LINE # 145
012F 900000      E     MOV     DPTR,#LENOVOPMFW_Temp
0132 E0                MOVX    A,@DPTR
0133 30E012            JNB     ACC.0,?C0024
                                           ; SOURCE LINE # 146
                                           ; SOURCE LINE # 147
0136 E0                MOVX    A,@DPTR
0137 54FE              ANL     A,#0FEH
0139 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 149
013A 900000      E     MOV     DPTR,#ACOFF_SOURCE
013D E0                MOVX    A,@DPTR
013E 30E207            JNB     ACC.2,?C0024
                                           ; SOURCE LINE # 150
                                           ; SOURCE LINE # 151
0141 E0                MOVX    A,@DPTR
0142 54FB              ANL     A,#0FBH
0144 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 152
0145 120000      R     LCALL   BATT_LEN_OFF
                                           ; SOURCE LINE # 154
                                           ; SOURCE LINE # 155
0148         ?C0024:
                                           ; SOURCE LINE # 158
                                           ; SOURCE LINE # 159
                                           ; SOURCE LINE # 160
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 57  

                                           ; SOURCE LINE # 161
0148 020000      R     LJMP    ?C0490
014B         ?C0007:
                                           ; SOURCE LINE # 162
014B 900000      E     MOV     DPTR,#testtoolflag
014E E0                MOVX    A,@DPTR
014F 6401              XRL     A,#01H
0151 6003              JZ      $ + 5H
0153 020000      R     LJMP    ?C0048
                                           ; SOURCE LINE # 163
                                           ; SOURCE LINE # 164
0156 900000      E     MOV     DPTR,#LENOVOPMFW
0159 E0                MOVX    A,@DPTR
015A 20E403            JB      ACC.4,$ + 6H
015D 020000      R     LJMP    ?C0028
0160 E0                MOVX    A,@DPTR
0161 30E203            JNB     ACC.2,$ + 6H
0164 020000      R     LJMP    ?C0028
                                           ; SOURCE LINE # 165
                                           ; SOURCE LINE # 180
                                           ; SOURCE LINE # 181
0167 120000      R     LCALL   L?0560
                                           ; SOURCE LINE # 183
                                           ; SOURCE LINE # 185
016A 120000      R     LCALL   L?0575
016D D3                SETB    C
016E 943C              SUBB    A,#03CH
0170 400A              JC      ?C0029
                                           ; SOURCE LINE # 186
                                           ; SOURCE LINE # 187
0172 900000      E     MOV     DPTR,#ACOFF_SOURCE
0175 E0                MOVX    A,@DPTR
0176 4404              ORL     A,#04H
0178 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 188
0179 020000      R     LJMP    BATT_LEN_ON
                                           ; SOURCE LINE # 198
017C         ?C0029:
                                           ; SOURCE LINE # 199
017C 120000      R     LCALL   L?0610
017F 5003              JNC     $ + 5H
0181 020000      R     LJMP    ?C0031
0184 E0                MOVX    A,@DPTR
0185 D3                SETB    C
0186 943C              SUBB    A,#03CH
0188 4003              JC      $ + 5H
018A 020000      R     LJMP    ?C0031
                                           ; SOURCE LINE # 200
                                           ; SOURCE LINE # 201
018D 900000      E     MOV     DPTR,#ACOFF_SOURCE
0190 E0                MOVX    A,@DPTR
0191 30E205            JNB     ACC.2,?C0032
                                           ; SOURCE LINE # 202
                                           ; SOURCE LINE # 203
0194 7F25              MOV     R7,#025H
0196 120000      E     LCALL   _ECSMI_SCIEvent
                                           ; SOURCE LINE # 204
0199         ?C0032:
                                           ; SOURCE LINE # 205
                                           ; SOURCE LINE # 206
0199 120000      R     LCALL   L?0561
                                           ; SOURCE LINE # 208
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 58  

019C 900000      E     MOV     DPTR,#StatusKeeper
019F E0                MOVX    A,@DPTR
01A0 20E108            JB      ACC.1,?C0033
                                           ; SOURCE LINE # 209
                                           ; SOURCE LINE # 210
01A3         ?C0485:
01A3 900000      E     MOV     DPTR,#nStopChgStat3H
01A6 E0                MOVX    A,@DPTR
01A7 4440              ORL     A,#040H
01A9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 211
01AA 22                RET     
01AB         ?C0033:
                                           ; SOURCE LINE # 213
                                           ; SOURCE LINE # 214
                                           ; SOURCE LINE # 215
01AB 120000      R     LCALL   L?0590
01AE 6003              JZ      $ + 5H
01B0 020000      R     LJMP    ?C0048
                                           ; SOURCE LINE # 216
                                           ; SOURCE LINE # 217
01B3 900000      E     MOV     DPTR,#KeepBattRemineCap
01B6 E0                MOVX    A,@DPTR
01B7 7002              JNZ     ?C0479
01B9 A3                INC     DPTR
01BA E0                MOVX    A,@DPTR
01BB         ?C0479:
01BB 700B              JNZ     ?C0036
                                           ; SOURCE LINE # 218
                                           ; SOURCE LINE # 219
01BD         ?C0486:
01BD 120000      R     LCALL   L?0541
01C0 900000      E     MOV     DPTR,#KeepBattRemineCap
01C3 F0                MOVX    @DPTR,A
01C4 A3                INC     DPTR
01C5 EF                MOV     A,R7
01C6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 220
01C7 22                RET     
01C8         ?C0036:
                                           ; SOURCE LINE # 222
                                           ; SOURCE LINE # 223
01C8 900000      E     MOV     DPTR,#nFullChgCapH
01CB E0                MOVX    A,@DPTR
01CC FE                MOV     R6,A
01CD 900000      E     MOV     DPTR,#nFullChgCapL
01D0 120000      R     LCALL   L?0544
                                           ; SOURCE LINE # 226
01D3 120000      R     LCALL   L?0549
01D6 120000      E     LCALL   ?C?LADD
01D9 EC                MOV     A,R4
01DA C0E0              PUSH    ACC
01DC EE                MOV     A,R6
01DD C0E0              PUSH    ACC
01DF EF                MOV     A,R7
01E0 C0E0              PUSH    ACC
01E2 120000      R     LCALL   L?0542
01E5 120000      R     LCALL   L?0578
01E8 D0E0              POP     ACC
01EA FF                MOV     R7,A
01EB D0E0              POP     ACC
01ED FE                MOV     R6,A
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 59  

01EE D0E0              POP     ACC
01F0 FC                MOV     R4,A
01F1 D3                SETB    C
01F2 120000      E     LCALL   ?C?ULCMP
01F5 4077              JC      ?C0048
                                           ; SOURCE LINE # 227
                                           ; SOURCE LINE # 228
01F7         ?C0487:
01F7 E4                CLR     A
01F8 900000      E     MOV     DPTR,#KeepBattRemineCap
01FB F0                MOVX    @DPTR,A
01FC A3                INC     DPTR
01FD F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 229
01FE 900000      E     MOV     DPTR,#StatusKeeper
0201 E0                MOVX    A,@DPTR
0202 54FD              ANL     A,#0FDH
0204 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 230
0205 7F25              MOV     R7,#025H
0207 020000      E     LJMP    _ECSMI_SCIEvent
                                           ; SOURCE LINE # 231
                                           ; SOURCE LINE # 232
                                           ; SOURCE LINE # 233
                                           ; SOURCE LINE # 234
                                           ; SOURCE LINE # 236
020A         ?C0031:
                                           ; SOURCE LINE # 237
020A 120000      R     LCALL   L?0611
020D 505F              JNC     ?C0048
                                           ; SOURCE LINE # 238
                                           ; SOURCE LINE # 239
020F         ?C0488:
020F 120000      R     LCALL   L?0613
                                           ; SOURCE LINE # 240
0212 120000      R     LCALL   BATT_LEN_OFF
                                           ; SOURCE LINE # 242
0215 900000      E     MOV     DPTR,#StatusKeeper
0218 E0                MOVX    A,@DPTR
0219 4402              ORL     A,#02H
                                           ; SOURCE LINE # 243
                                           ; SOURCE LINE # 245
                                           ; SOURCE LINE # 246
021B 8049              SJMP    ?C0491
021D         ?C0028:
                                           ; SOURCE LINE # 249
                                           ; SOURCE LINE # 251
021D 900000      E     MOV     DPTR,#EC_BatteryStatusL
0220 E0                MOVX    A,@DPTR
0221 30E513            JNB     ACC.5,?C0042
0224 900000      E     MOV     DPTR,#SYS_STATUS
0227 E0                MOVX    A,@DPTR
0228 30E70C            JNB     ACC.7,?C0042
022B 900000      E     MOV     DPTR,#nBattGasgauge
022E E0                MOVX    A,@DPTR
022F B46405            CJNE    A,#064H,?C0042
                                           ; SOURCE LINE # 252
                                           ; SOURCE LINE # 253
                                           ; SOURCE LINE # 254
0232 120000      R     LCALL   L?0612
                                           ; SOURCE LINE # 255
0235 800B              SJMP    ?C0492
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 60  

0237         ?C0042:
                                           ; SOURCE LINE # 257
                                           ; SOURCE LINE # 259
0237 900000      E     MOV     DPTR,#ChkBattery_abnormal_status
023A E0                MOVX    A,@DPTR
023B 6402              XRL     A,#02H
023D 6008              JZ      ?C0043
                                           ; SOURCE LINE # 260
                                           ; SOURCE LINE # 263
023F         ?C0044:
                                           ; SOURCE LINE # 265
                                           ; SOURCE LINE # 266
                                           ; SOURCE LINE # 267
023F 120000      R     LCALL   L?0560
0242         ?C0492:
0242 E0                MOVX    A,@DPTR
0243 900000      E     MOV     DPTR,#nRemainingCapH
0246 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 268
                                           ; SOURCE LINE # 269
0247         ?C0043:
                                           ; SOURCE LINE # 271
0247 900000      E     MOV     DPTR,#LENOVOPMFW_Temp
024A E0                MOVX    A,@DPTR
024B 30E012            JNB     ACC.0,?C0046
                                           ; SOURCE LINE # 272
                                           ; SOURCE LINE # 273
024E E0                MOVX    A,@DPTR
024F 54FE              ANL     A,#0FEH
0251 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 275
0252 900000      E     MOV     DPTR,#ACOFF_SOURCE
0255 E0                MOVX    A,@DPTR
0256 30E207            JNB     ACC.2,?C0046
                                           ; SOURCE LINE # 276
                                           ; SOURCE LINE # 277
0259 E0                MOVX    A,@DPTR
025A 54FB              ANL     A,#0FBH
025C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 278
025D 120000      R     LCALL   BATT_LEN_OFF
                                           ; SOURCE LINE # 280
                                           ; SOURCE LINE # 281
0260         ?C0046:
                                           ; SOURCE LINE # 284
0260         ?C0490:
0260 900000      E     MOV     DPTR,#StatusKeeper
0263 E0                MOVX    A,@DPTR
0264 54FD              ANL     A,#0FDH
0266         ?C0491:
0266 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 285
0267 900000      E     MOV     DPTR,#nStopChgStat3H
026A E0                MOVX    A,@DPTR
026B 54BF              ANL     A,#0BFH
026D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 286
                                           ; SOURCE LINE # 287
                                           ; SOURCE LINE # 409
026E         ?C0048:
026E 22                RET     
026F         L?0561:
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 61  

026F 900000      E     MOV     DPTR,#ACOFF_SOURCE
0272 E0                MOVX    A,@DPTR
0273 54FB              ANL     A,#0FBH
0275 F0                MOVX    @DPTR,A
0276 120000      R     LCALL   BATT_LEN_OFF
0279 22                RET     
             ; FUNCTION UpdateNameSpace (END)

             ; FUNCTION ChkLENOVOPMFW (BEGIN)
                                           ; SOURCE LINE # 411
                                           ; SOURCE LINE # 412
                                           ; SOURCE LINE # 413
0000 900000      E     MOV     DPTR,#LENOVOPMFW
0003 E0                MOVX    A,@DPTR
0004 30E220            JNB     ACC.2,?C0049
                                           ; SOURCE LINE # 414
                                           ; SOURCE LINE # 415
0007 900000      E     MOV     DPTR,#cBattFlag0
000A E0                MOVX    A,@DPTR
000B C3                CLR     C
000C 13                RRC     A
000D 20E031            JB      ACC.0,?C0054
                                           ; SOURCE LINE # 416
                                           ; SOURCE LINE # 417
0010 900000      E     MOV     DPTR,#LENOVOPMFW
0013 E0                MOVX    A,@DPTR
0014 20E02A            JB      ACC.0,?C0054
                                           ; SOURCE LINE # 418
                                           ; SOURCE LINE # 419
0017 900000      E     MOV     DPTR,#cBattFlag0
001A E0                MOVX    A,@DPTR
001B 4402              ORL     A,#02H
                                           ; SOURCE LINE # 420
                                           ; SOURCE LINE # 421
001D 120000      R     LCALL   L?0630
                                           ; SOURCE LINE # 422
0020 900000      E     MOV     DPTR,#cTargetGauge
0023 7401              MOV     A,#01H
0025 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 424
                                           ; SOURCE LINE # 425
                                           ; SOURCE LINE # 426
0026 22                RET     
0027         ?C0049:
                                           ; SOURCE LINE # 427
0027 900000      E     MOV     DPTR,#LENOVOPMFW
002A E0                MOVX    A,@DPTR
002B 30E013            JNB     ACC.0,?C0054
                                           ; SOURCE LINE # 428
                                           ; SOURCE LINE # 429
002E E0                MOVX    A,@DPTR
002F 54FE              ANL     A,#0FEH
0031 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 430
0032 900000      E     MOV     DPTR,#cBattFlag0
0035 E0                MOVX    A,@DPTR
0036 54FD              ANL     A,#0FDH
                                           ; SOURCE LINE # 431
                                           ; SOURCE LINE # 432
0038 120000      R     LCALL   L?0630
                                           ; SOURCE LINE # 434
003B 120000      R     LCALL   L?0613
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 62  

                                           ; SOURCE LINE # 435
003E 120000      R     LCALL   BATT_LEN_OFF
                                           ; SOURCE LINE # 437
                                           ; SOURCE LINE # 438
0041         ?C0054:
0041 22                RET     
             ; FUNCTION ChkLENOVOPMFW (END)

             ; FUNCTION ChkGoTarget (BEGIN)
                                           ; SOURCE LINE # 440
                                           ; SOURCE LINE # 441
                                           ; SOURCE LINE # 442
0000 120000      R     LCALL   L?0591
0003 30E063            JNB     ACC.0,?C0055
                                           ; SOURCE LINE # 443
                                           ; SOURCE LINE # 444
0006 120000      R     LCALL   L?0571
0009 6007              JZ      ?C0057
000B 120000      R     LCALL   L?0581
000E C3                CLR     C
000F 9F                SUBB    A,R7
0010 503B              JNC     ?C0056
0012         ?C0057:
                                           ; SOURCE LINE # 445
                                           ; SOURCE LINE # 446
0012 120000      R     LCALL   L?0614
                                           ; SOURCE LINE # 447
0015 120000      R     LCALL   BATT_LEN_OFF
                                           ; SOURCE LINE # 449
0018 900000      E     MOV     DPTR,#cBattFlag0
001B E0                MOVX    A,@DPTR
001C 547F              ANL     A,#07FH
001E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 450
001F 900000      E     MOV     DPTR,#LENOVOPMFW
0022 E0                MOVX    A,@DPTR
0023 30E262            JNB     ACC.2,?C0059
                                           ; SOURCE LINE # 451
                                           ; SOURCE LINE # 452
0026 E0                MOVX    A,@DPTR
0027 4401              ORL     A,#01H
0029 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 453
002A E0                MOVX    A,@DPTR
002B 54FB              ANL     A,#0FBH
002D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 454
002E E4                CLR     A
002F 900000      E     MOV     DPTR,#cTargetGauge
0032 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 455
0033 900000      E     MOV     DPTR,#LENOVOPMFW_Temp
0036 E0                MOVX    A,@DPTR
0037 4402              ORL     A,#02H
0039 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 456
003A 900000      E     MOV     DPTR,#uVPCeventSource
003D 7402              MOV     A,#02H
003F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 457
0040 E4                CLR     A
0041 900000      E     MOV     DPTR,#uVPCeventSource2
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 63  

0044 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 458
0045 7F44              MOV     R7,#044H
0047 120000      E     LCALL   _ECSMI_SCIEvent
                                           ; SOURCE LINE # 459
004A 020000      R     LJMP    ChkLENOVOPMFW
                                           ; SOURCE LINE # 460
                                           ; SOURCE LINE # 462
004D         ?C0056:
                                           ; SOURCE LINE # 463
004D 900000      E     MOV     DPTR,#cTargetGauge
0050 120000      R     LCALL   L?0581
0053 D3                SETB    C
0054 9F                SUBB    A,R7
0055 4031              JC      ?C0059
                                           ; SOURCE LINE # 464
                                           ; SOURCE LINE # 465
0057 900000      E     MOV     DPTR,#ACOFF_SOURCE
005A E0                MOVX    A,@DPTR
005B 4404              ORL     A,#04H
005D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 466
005E 120000      R     LCALL   BATT_LEN_ON
                                           ; SOURCE LINE # 468
0061 900000      E     MOV     DPTR,#cBattFlag0
0064 E0                MOVX    A,@DPTR
0065 4480              ORL     A,#080H
0067 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 469
                                           ; SOURCE LINE # 470
0068 22                RET     
0069         ?C0055:
                                           ; SOURCE LINE # 471
0069 900000      E     MOV     DPTR,#cBattFlag0
006C E0                MOVX    A,@DPTR
006D C3                CLR     C
006E 13                RRC     A
006F 30E016            JNB     ACC.0,?C0059
                                           ; SOURCE LINE # 472
                                           ; SOURCE LINE # 473
0072 E0                MOVX    A,@DPTR
0073 20E012            JB      ACC.0,?C0059
                                           ; SOURCE LINE # 474
                                           ; SOURCE LINE # 475
0076 900000      E     MOV     DPTR,#nBattery0x16L
0079 E0                MOVX    A,@DPTR
007A 30E50B            JNB     ACC.5,?C0059
                                           ; SOURCE LINE # 476
                                           ; SOURCE LINE # 477
007D 900000      E     MOV     DPTR,#cBattFlag0
0080 E0                MOVX    A,@DPTR
0081 4401              ORL     A,#01H
0083 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 478
0084 E0                MOVX    A,@DPTR
0085 4404              ORL     A,#04H
0087 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 479
                                           ; SOURCE LINE # 480
                                           ; SOURCE LINE # 481
                                           ; SOURCE LINE # 482
0088         ?C0059:
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 64  

0088 22                RET     
             ; FUNCTION ChkGoTarget (END)

             ; FUNCTION ChkS3ResumeRSOC (BEGIN)
                                           ; SOURCE LINE # 484
                                           ; SOURCE LINE # 485
                                           ; SOURCE LINE # 500
0000 900000      E     MOV     DPTR,#battery_critical
0003 E0                MOVX    A,@DPTR
0004 30E124            JNB     ACC.1,?C0066
                                           ; SOURCE LINE # 501
                                           ; SOURCE LINE # 502
0007 900000      E     MOV     DPTR,#PWSeqStep
000A 7401              MOV     A,#01H
000C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 503
000D 900000      E     MOV     DPTR,#PowSeqDelay
0010 E4                CLR     A
0011 F0                MOVX    @DPTR,A
0012 A3                INC     DPTR
0013 04                INC     A
0014 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 504
0015 7F37              MOV     R7,#037H
0017 120000      E     LCALL   _RamDebug
                                           ; SOURCE LINE # 505
001A 900000      E     MOV     DPTR,#SysPowState
001D 7430              MOV     A,#030H
001F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 506
0020 900000      E     MOV     DPTR,#battery_critical
0023 E0                MOVX    A,@DPTR
0024 54FE              ANL     A,#0FEH
0026 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 507
0027 E0                MOVX    A,@DPTR
0028 54FD              ANL     A,#0FDH
002A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 508
                                           ; SOURCE LINE # 510
002B         ?C0066:
002B 22                RET     
             ; FUNCTION ChkS3ResumeRSOC (END)

             ; FUNCTION ChkS3DCRSOC (BEGIN)
                                           ; SOURCE LINE # 512
                                           ; SOURCE LINE # 513
                                           ; SOURCE LINE # 514
0000 900000      E     MOV     DPTR,#SysPowState
0003 E0                MOVX    A,@DPTR
0004 6433              XRL     A,#033H
0006 702C              JNZ     ?C0067
                                           ; SOURCE LINE # 515
                                           ; SOURCE LINE # 516
0008 120000      R     LCALL   L?0580
000B 6F                XRL     A,R7
000C 6008              JZ      ?C0068
                                           ; SOURCE LINE # 517
                                           ; SOURCE LINE # 518
000E 900000      E     MOV     DPTR,#battery_critical
0011 E0                MOVX    A,@DPTR
0012 4401              ORL     A,#01H
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 65  

0014 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 519
0015 22                RET     
0016         ?C0068:
                                           ; SOURCE LINE # 521
                                           ; SOURCE LINE # 522
0016 900000      E     MOV     DPTR,#SYS_STATUS
0019 E0                MOVX    A,@DPTR
001A 20E712            JB      ACC.7,?C0070
001D 120000      R     LCALL   L?0580
0020 6F                XRL     A,R7
0021 700C              JNZ     ?C0070
0023 900000      E     MOV     DPTR,#battery_critical
0026 E0                MOVX    A,@DPTR
0027 30E005            JNB     ACC.0,?C0070
                                           ; SOURCE LINE # 523
                                           ; SOURCE LINE # 524
002A E0                MOVX    A,@DPTR
002B 4402              ORL     A,#02H
002D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 525
002E 22                RET     
002F         ?C0070:
                                           ; SOURCE LINE # 527
                                           ; SOURCE LINE # 528
002F 900000      E     MOV     DPTR,#battery_critical
                                           ; SOURCE LINE # 529
                                           ; SOURCE LINE # 531
                                           ; SOURCE LINE # 532
0032 8007              SJMP    ?C0493
0034         ?C0067:
                                           ; SOURCE LINE # 534
                                           ; SOURCE LINE # 535
0034 900000      E     MOV     DPTR,#battery_critical
0037 E0                MOVX    A,@DPTR
0038 54FE              ANL     A,#0FEH
003A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 536
003B         ?C0493:
003B E0                MOVX    A,@DPTR
003C 54FD              ANL     A,#0FDH
003E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 537
                                           ; SOURCE LINE # 538
003F         ?C0073:
003F 22                RET     
             ; FUNCTION ChkS3DCRSOC (END)

             ; FUNCTION RSOC1Pto0P_ShutdownCheck (BEGIN)
                                           ; SOURCE LINE # 541
                                           ; SOURCE LINE # 542
                                           ; SOURCE LINE # 543
0000 900000      E     MOV     DPTR,#SYS_STATUS
0003 E0                MOVX    A,@DPTR
0004 20E715            JB      ACC.7,?C0075
0007 900000      E     MOV     DPTR,#GPDRB
000A E0                MOVX    A,@DPTR
000B 20E00E            JB      ACC.0,?C0075
000E 900000      E     MOV     DPTR,#nBattGasgauge
0011 E0                MOVX    A,@DPTR
0012 D3                SETB    C
0013 9401              SUBB    A,#01H
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 66  

0015 5005              JNC     ?C0075
0017 120000      R     LCALL   L?0562
001A 6004              JZ      ?C0074
001C         ?C0075:
                                           ; SOURCE LINE # 544
                                           ; SOURCE LINE # 545
                                           ; SOURCE LINE # 546
001C 120000      R     LCALL   L?0631
                                           ; SOURCE LINE # 547
001F 22                RET     
0020         ?C0074:
                                           ; SOURCE LINE # 549
                                           ; SOURCE LINE # 550
0020 900000      E     MOV     DPTR,#nBattGasgauge
0023 E0                MOVX    A,@DPTR
0024 B40105            CJNE    A,#01H,?C0077
                                           ; SOURCE LINE # 551
                                           ; SOURCE LINE # 552
0027 900000      E     MOV     DPTR,#RSOC1PTO0PSaveSpace
                                           ; SOURCE LINE # 553
002A 802A              SJMP    ?C0494
002C         ?C0077:
                                           ; SOURCE LINE # 554
002C 900000      E     MOV     DPTR,#nBattGasgauge
002F E0                MOVX    A,@DPTR
0030 702F              JNZ     ?C0082
0032 900000      E     MOV     DPTR,#RSOC1PTO0PSaveSpace
0035 E0                MOVX    A,@DPTR
0036 30E028            JNB     ACC.0,?C0082
                                           ; SOURCE LINE # 555
                                           ; SOURCE LINE # 556
0039 900000      E     MOV     DPTR,#RSOC1PTO0PCount
003C E0                MOVX    A,@DPTR
003D C3                CLR     C
003E 941E              SUBB    A,#01EH
0040 4019              JC      ?C0080
                                           ; SOURCE LINE # 557
                                           ; SOURCE LINE # 558
0042 7F40              MOV     R7,#040H
0044 120000      E     LCALL   _ProcessSID
                                           ; SOURCE LINE # 560
0047 120000      R     LCALL   L?0615
                                           ; SOURCE LINE # 562
                                           ; SOURCE LINE # 563
004A 120000      R     LCALL   L?0631
                                           ; SOURCE LINE # 565
                                           ; SOURCE LINE # 566
004D 120000      R     LCALL   L?0632
0050 120000      E     LCALL   _Delay1MS
                                           ; SOURCE LINE # 567
0053 900000      E     MOV     DPTR,#GPDRC
0056         ?C0494:
0056 E0                MOVX    A,@DPTR
0057 4401              ORL     A,#01H
0059 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 568
005A 22                RET     
005B         ?C0080:
                                           ; SOURCE LINE # 570
                                           ; SOURCE LINE # 571
005B 900000      E     MOV     DPTR,#RSOC1PTO0PCount
005E E0                MOVX    A,@DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 67  

005F 04                INC     A
0060 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 572
                                           ; SOURCE LINE # 573
                                           ; SOURCE LINE # 574
                                           ; SOURCE LINE # 575
0061         ?C0082:
0061 22                RET     
             ; FUNCTION RSOC1Pto0P_ShutdownCheck (END)

             ; FUNCTION RSMRST_shutdown (BEGIN)
                                           ; SOURCE LINE # 577
                                           ; SOURCE LINE # 579
                                           ; SOURCE LINE # 580
                                           ; SOURCE LINE # 581
0000 120000      R     LCALL   L?0632
0003 120000      E     LCALL   _Delay1MS
                                           ; SOURCE LINE # 582
0006 900000      E     MOV     DPTR,#GPDRC
0009 E0                MOVX    A,@DPTR
000A 4401              ORL     A,#01H
000C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 583
000D 900000      E     MOV     DPTR,#RSMshutdownCnt
0010 E0                MOVX    A,@DPTR
0011 04                INC     A
0012 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 584
0013 22                RET     
             ; FUNCTION RSMRST_shutdown (END)

             ; FUNCTION DownBatteryPState (BEGIN)
                                           ; SOURCE LINE # 586
                                           ; SOURCE LINE # 587
                                           ; SOURCE LINE # 588
0000 900000      E     MOV     DPTR,#cBATTThrottling
0003 E0                MOVX    A,@DPTR
0004 6012              JZ      ?C0085
0006 900000      E     MOV     DPTR,#BatteryAlarm
0009 E0                MOVX    A,@DPTR
000A 700C              JNZ     ?C0085
000C 900000      E     MOV     DPTR,#ADPIDON10MS_NUM
000F E0                MOVX    A,@DPTR
0010 7006              JNZ     ?C0085
                                           ; SOURCE LINE # 589
0012 900000      E     MOV     DPTR,#cBATTThrottling
0015 E0                MOVX    A,@DPTR
0016 14                DEC     A
0017 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 590
0018         ?C0085:
0018 22                RET     
             ; FUNCTION DownBatteryPState (END)

             ; FUNCTION UpBatteryPState (BEGIN)
                                           ; SOURCE LINE # 592
                                           ; SOURCE LINE # 593
                                           ; SOURCE LINE # 595
0000 900000      E     MOV     DPTR,#cBATTThrottling
0003 E0                MOVX    A,@DPTR
0004 640B              XRL     A,#0BH
0006 6003              JZ      ?C0087
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 68  

                                           ; SOURCE LINE # 596
0008 E0                MOVX    A,@DPTR
0009 04                INC     A
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 597
000B         ?C0087:
000B 22                RET     
             ; FUNCTION UpBatteryPState (END)

             ; FUNCTION DownACtoBatteryGPUState (BEGIN)
                                           ; SOURCE LINE # 600
                                           ; SOURCE LINE # 601
                                           ; SOURCE LINE # 602
0000 900000      E     MOV     DPTR,#cGPUACtoBattThrottling
0003 E0                MOVX    A,@DPTR
0004 603F              JZ      ?C0094
0006 900000      E     MOV     DPTR,#cGPUACtoBattTime
0009 E0                MOVX    A,@DPTR
000A 7039              JNZ     ?C0094
                                           ; SOURCE LINE # 603
                                           ; SOURCE LINE # 604
000C 900000      E     MOV     DPTR,#SYS_STATUS
000F E0                MOVX    A,@DPTR
0010 30E706            JNB     ACC.7,?C0089
                                           ; SOURCE LINE # 605
                                           ; SOURCE LINE # 606
0013 E4                CLR     A
0014 900000      E     MOV     DPTR,#cGPUACtoBattThrottling
0017 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 607
0018 22                RET     
0019         ?C0089:
                                           ; SOURCE LINE # 609
                                           ; SOURCE LINE # 610
0019 900000      E     MOV     DPTR,#cGPUACtoBattThrottling
001C E0                MOVX    A,@DPTR
001D 14                DEC     A
001E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 611
001F 900000      E     MOV     DPTR,#cGPUACtoBattTime
0022 7404              MOV     A,#04H
0024 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 613
0025 120000      R     LCALL   L?0617
0028 4009              JC      ?C0091
002A 900000      E     MOV     DPTR,#cGPUACtoBattThrottling
002D E0                MOVX    A,@DPTR
002E B40102            CJNE    A,#01H,?C0091
                                           ; SOURCE LINE # 614
                                           ; SOURCE LINE # 615
                                           ; SOURCE LINE # 616
                                           ; SOURCE LINE # 617
0031 800C              SJMP    ?C0495
0033         ?C0091:
                                           ; SOURCE LINE # 618
0033 120000      R     LCALL   L?0617
0036 500D              JNC     ?C0094
0038 900000      E     MOV     DPTR,#cGPUACtoBattThrottling
003B E0                MOVX    A,@DPTR
003C B40206            CJNE    A,#02H,?C0094
                                           ; SOURCE LINE # 619
                                           ; SOURCE LINE # 620
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 69  

003F         ?C0495:
003F E4                CLR     A
0040 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 621
0041 900000      E     MOV     DPTR,#cGPUACtoBattTime
0044 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 622
                                           ; SOURCE LINE # 624
                                           ; SOURCE LINE # 625
                                           ; SOURCE LINE # 626
0045         ?C0094:
0045 22                RET     
             ; FUNCTION DownACtoBatteryGPUState (END)

             ; FUNCTION CPUProchotCtrl (BEGIN)
                                           ; SOURCE LINE # 630
                                           ; SOURCE LINE # 631
                                           ; SOURCE LINE # 632
0000 900000      E     MOV     DPTR,#Thro_Status
0003 E0                MOVX    A,@DPTR
0004 20E024            JB      ACC.0,?C0095
0007 900000      E     MOV     DPTR,#Thro_Status2
000A E0                MOVX    A,@DPTR
000B 5488              ANL     A,#088H
000D 701C              JNZ     ?C0095
000F 900000      E     MOV     DPTR,#CPUProchotONCnt
0012 E0                MOVX    A,@DPTR
0013 7016              JNZ     ?C0095
                                           ; SOURCE LINE # 637
                                           ; SOURCE LINE # 638
0015 900000      E     MOV     DPTR,#GPDRJ
0018 E0                MOVX    A,@DPTR
0019 54EF              ANL     A,#0EFH
001B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 639
001C 900000      E     MOV     DPTR,#REAL_THROTTLING_INDEX
001F E0                MOVX    A,@DPTR
0020 547F              ANL     A,#07FH
0022 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 640
0023 900000      E     MOV     DPTR,#pPROCHOT
0026 E0                MOVX    A,@DPTR
0027 54FE              ANL     A,#0FEH
0029 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 641
002A 22                RET     
002B         ?C0095:
                                           ; SOURCE LINE # 643
                                           ; SOURCE LINE # 644
002B 900000      E     MOV     DPTR,#GPDRJ
002E E0                MOVX    A,@DPTR
002F 4410              ORL     A,#010H
0031 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 645
0032 900000      E     MOV     DPTR,#REAL_THROTTLING_INDEX
0035 E0                MOVX    A,@DPTR
0036 4480              ORL     A,#080H
0038 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 646
0039 900000      E     MOV     DPTR,#pPROCHOT
003C E0                MOVX    A,@DPTR
003D 4401              ORL     A,#01H
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 70  

003F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 647
                                           ; SOURCE LINE # 648
0040         ?C0097:
0040 22                RET     
             ; FUNCTION CPUProchotCtrl (END)

             ; FUNCTION ChkBattery_OTP (BEGIN)
                                           ; SOURCE LINE # 651
                                           ; SOURCE LINE # 652
                                           ; SOURCE LINE # 653
0000 900000      E     MOV     DPTR,#EC_oCBTh
0003 E0                MOVX    A,@DPTR
0004 900000      E     MOV     DPTR,#EC_oCBTl
                                           ; SOURCE LINE # 654
0007 120000      R     LCALL   L?0593
000A E500        E     MOV     A,ITempW01+01H
000C 94AA              SUBB    A,#0AAH
000E E500        E     MOV     A,ITempW01
0010 940A              SUBB    A,#0AH
0012 5003              JNC     $ + 5H
0014 020000      R     LJMP    ?C0100
                                           ; SOURCE LINE # 655
                                           ; SOURCE LINE # 656
0017 E500        E     MOV     A,ITempW01+01H
0019 2456              ADD     A,#056H
001B FF                MOV     R7,A
001C E500        E     MOV     A,ITempW01
001E 34F5              ADDC    A,#0F5H
0020 FE                MOV     R6,A
0021 7D0A              MOV     R5,#0AH
0023 120000      E     LCALL   ?C?UIDIV
0026 900000      E     MOV     DPTR,#nBattAverTemp
0029 EF                MOV     A,R7
002A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 657
                                           ; SOURCE LINE # 659
                                           ; SOURCE LINE # 661
002B         ?C0099:
                                           ; SOURCE LINE # 664
002B 900000      E     MOV     DPTR,#SysPowState
002E E0                MOVX    A,@DPTR
002F B41013            CJNE    A,#010H,?C0101
0032 900000      E     MOV     DPTR,#BatteryOTPShutdown
0035 120000      R     LCALL   L?0594
0038 400B              JC      ?C0101
                                           ; SOURCE LINE # 665
                                           ; SOURCE LINE # 667
003A 120000      R     LCALL   L?0615
                                           ; SOURCE LINE # 668
003D 7F0A              MOV     R7,#0AH
003F 120000      E     LCALL   _ProcessSID
                                           ; SOURCE LINE # 669
0042 120000      R     LCALL   RSMRST_shutdown
                                           ; SOURCE LINE # 671
0045         ?C0101:
                                           ; SOURCE LINE # 675
0045 120000      R     LCALL   L?0562
0048 704A              JNZ     ?C0102
004A 900000      E     MOV     DPTR,#nBatteryStatH
004D E0                MOVX    A,@DPTR
004E 30E043            JNB     ACC.0,?C0102
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 71  

                                           ; SOURCE LINE # 676
                                           ; SOURCE LINE # 688
0051 900000      E     MOV     DPTR,#BatteryOTP
0054 120000      R     LCALL   L?0594
0057 4023              JC      ?C0103
                                           ; SOURCE LINE # 689
                                           ; SOURCE LINE # 690
0059 900000      E     MOV     DPTR,#nStopChgStat3L
005C E0                MOVX    A,@DPTR
005D 4480              ORL     A,#080H
005F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 691
0060 900000      E     MOV     DPTR,#BatteryAlarm
0063 E0                MOVX    A,@DPTR
0064 4402              ORL     A,#02H
0066 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 697
0067 900000      E     MOV     DPTR,#cGPUBattOTPThrottling
006A 7404              MOV     A,#04H
006C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 698
006D 900000      E     MOV     DPTR,#Thro_Status2
0070 E0                MOVX    A,@DPTR
0071 4408              ORL     A,#08H
0073 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 699
0074 900000      E     MOV     DPTR,#GPU_Prochot
0077 E0                MOVX    A,@DPTR
0078 4408              ORL     A,#08H
007A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 715
007B 22                RET     
007C         ?C0103:
                                           ; SOURCE LINE # 717
007C 900000      E     MOV     DPTR,#BatteryOTPRelease
007F 120000      R     LCALL   L?0595
0082 5026              JNC     ?C0100
                                           ; SOURCE LINE # 718
                                           ; SOURCE LINE # 719
                                           ; SOURCE LINE # 720
0084 120000      R     LCALL   L?0589
                                           ; SOURCE LINE # 724
0087 E4                CLR     A
0088 900000      E     MOV     DPTR,#cGPUBattOTPThrottling
008B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 725
008C 900000      E     MOV     DPTR,#Thro_Status2
008F E0                MOVX    A,@DPTR
0090 54F7              ANL     A,#0F7H
                                           ; SOURCE LINE # 726
                                           ; SOURCE LINE # 729
                                           ; SOURCE LINE # 730
0092 800E              SJMP    ?C0496
0094         ?C0102:
                                           ; SOURCE LINE # 732
                                           ; SOURCE LINE # 733
                                           ; SOURCE LINE # 734
0094 120000      R     LCALL   L?0589
                                           ; SOURCE LINE # 735
0097 900000      E     MOV     DPTR,#Thro_Status2
009A E0                MOVX    A,@DPTR
009B 54F7              ANL     A,#0F7H
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 72  

009D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 736
009E E4                CLR     A
009F 900000      E     MOV     DPTR,#cGPUBattOTPThrottling
00A2         ?C0496:
00A2 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 737
00A3 900000      E     MOV     DPTR,#GPU_Prochot
00A6 E0                MOVX    A,@DPTR
00A7 54F7              ANL     A,#0F7H
00A9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 739
                                           ; SOURCE LINE # 740
00AA         ?C0100:
00AA 22                RET     
             ; FUNCTION ChkBattery_OTP (END)

             ; FUNCTION ChkBattery_OverConsumption (BEGIN)
                                           ; SOURCE LINE # 746
                                           ; SOURCE LINE # 747
                                           ; SOURCE LINE # 752
0000 900000      E     MOV     DPTR,#GPDRB
0003 E0                MOVX    A,@DPTR
0004 30E003            JNB     ACC.0,?C0109
0007 D3                SETB    C
0008 8001              SJMP    ?C0110
000A         ?C0109:
000A C3                CLR     C
000B         ?C0110:
000B 500A              JNC     ?C0108
000D 900000      E     MOV     DPTR,#CHGIC_ReadCmd0x12L
0010 E0                MOVX    A,@DPTR
0011 20E503            JB      ACC.5,$ + 6H
0014 020000      R     LJMP    ?C0107
0017         ?C0108:
                                           ; SOURCE LINE # 753
                                           ; SOURCE LINE # 754
0017 900000      E     MOV     DPTR,#nNowCurrentH
001A E0                MOVX    A,@DPTR
001B 20E703            JB      ACC.7,$ + 6H
001E 020000      R     LJMP    ?C0124
                                           ; SOURCE LINE # 755
                                           ; SOURCE LINE # 756
0021 E0                MOVX    A,@DPTR
0022 FE                MOV     R6,A
0023 900000      E     MOV     DPTR,#nNowCurrentL
0026 120000      R     LCALL   L?0544
0029 900000      R     MOV     DPTR,#BattNowCurrent+01H
002C 120000      R     LCALL   L?0570
002F 900000      R     MOV     DPTR,#BattNowCurrent
0032 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 757
0033 900000      E     MOV     DPTR,#nPresentVoltH
0036 E0                MOVX    A,@DPTR
0037 FE                MOV     R6,A
0038 900000      E     MOV     DPTR,#nPresentVoltL
003B E0                MOVX    A,@DPTR
003C 900000      R     MOV     DPTR,#BattPresentVolt
003F 120000      R     LCALL   L?0564
                                           ; SOURCE LINE # 758
0042 900000      R     MOV     DPTR,#BattNowCurrent
0045 120000      R     LCALL   L?0558
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 73  

0048 EC                MOV     A,R4
0049 C0E0              PUSH    ACC
004B ED                MOV     A,R5
004C C0E0              PUSH    ACC
004E EE                MOV     A,R6
004F C0E0              PUSH    ACC
0051 EF                MOV     A,R7
0052 C0E0              PUSH    ACC
0054 900000      R     MOV     DPTR,#BattPresentVolt
0057 120000      R     LCALL   L?0558
005A D0E0              POP     ACC
005C FB                MOV     R3,A
005D D0E0              POP     ACC
005F FA                MOV     R2,A
0060 D0E0              POP     ACC
0062 F9                MOV     R1,A
0063 D0E0              POP     ACC
0065 F8                MOV     R0,A
0066 120000      E     LCALL   ?C?FPMUL
0069 120000      E     LCALL   ?C?CASTF
006C 900000      R     MOV     DPTR,#Power_Temp
006F EF                MOV     A,R7
0070 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 759
0071 E0                MOVX    A,@DPTR
0072 FF                MOV     R7,A
0073 E4                CLR     A
0074 FC                MOV     R4,A
0075 FD                MOV     R5,A
0076 FE                MOV     R6,A
0077 7B40              MOV     R3,#040H
0079 7A42              MOV     R2,#042H
007B 790F              MOV     R1,#0FH
007D F8                MOV     R0,A
007E 120000      E     LCALL   ?C?LMUL
0081 EC                MOV     A,R4
0082 120000      E     LCALL   ?C?FCASTL
0085 7B18              MOV     R3,#018H
0087 7A0D              MOV     R2,#0DH
0089 798F              MOV     R1,#08FH
008B 7848              MOV     R0,#048H
008D 120000      E     LCALL   ?C?FPDIV
0090 120000      E     LCALL   ?C?CASTF
0093 900000      E     MOV     DPTR,#Chk_Hybrid_STPP_Batt_Output_Power
0096 EE                MOV     A,R6
0097 F0                MOVX    @DPTR,A
0098 A3                INC     DPTR
0099 EF                MOV     A,R7
009A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 760
009B 900000      E     MOV     DPTR,#nNowCurrentH
009E E0                MOVX    A,@DPTR
009F FE                MOV     R6,A
00A0 900000      E     MOV     DPTR,#nNowCurrentL
00A3 120000      R     LCALL   L?0544
00A6 120000      R     LCALL   L?0569
00A9 900000      E     MOV     DPTR,#XWTemp1
00AC F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 763
00AD 900000      R     MOV     DPTR,#Power_Temp
00B0 E0                MOVX    A,@DPTR
00B1 FD                MOV     R5,A
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 74  

00B2 C3                CLR     C
00B3 9420              SUBB    A,#020H
00B5 400E              JC      ?C0112
                                           ; SOURCE LINE # 764
                                           ; SOURCE LINE # 765
00B7 900000      E     MOV     DPTR,#cGPUBattThrottling
00BA 7404              MOV     A,#04H
00BC F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 766
00BD 900000      E     MOV     DPTR,#Thro_Status
00C0 E0                MOVX    A,@DPTR
00C1 4480              ORL     A,#080H
00C3 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 767
00C4 22                RET     
00C5         ?C0112:
                                           ; SOURCE LINE # 769
00C5 ED                MOV     A,R5
00C6 C3                CLR     C
00C7 9420              SUBB    A,#020H
00C9 5029              JNC     ?C0114
00CB 900000      R     MOV     DPTR,#Power_Temp
00CE E0                MOVX    A,@DPTR
00CF C3                CLR     C
00D0 9419              SUBB    A,#019H
00D2 4020              JC      ?C0114
                                           ; SOURCE LINE # 770
                                           ; SOURCE LINE # 772
00D4 900000      E     MOV     DPTR,#pProject0
00D7 E0                MOVX    A,@DPTR
00D8 900000      E     MOV     DPTR,#cGPUBattThrottling
00DB 30E70B            JNB     ACC.7,?C0115
                                           ; SOURCE LINE # 773
                                           ; SOURCE LINE # 774
00DE 7402              MOV     A,#02H
00E0 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 775
00E1 900000      E     MOV     DPTR,#cBATTThrottling
00E4 7409              MOV     A,#09H
00E6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 776
00E7 8044              SJMP    ?C0500
00E9         ?C0115:
                                           ; SOURCE LINE # 778
                                           ; SOURCE LINE # 779
00E9 7403              MOV     A,#03H
00EB F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 780
00EC 900000      E     MOV     DPTR,#cBATTThrottling
00EF 7407              MOV     A,#07H
00F1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 781
00F2         ?C0116:
                                           ; SOURCE LINE # 782
                                           ; SOURCE LINE # 784
00F2 8039              SJMP    ?C0500
00F4         ?C0114:
                                           ; SOURCE LINE # 785
00F4 900000      R     MOV     DPTR,#Power_Temp
00F7 E0                MOVX    A,@DPTR
00F8 FF                MOV     R7,A
00F9 C3                CLR     C
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 75  

00FA 9419              SUBB    A,#019H
00FC 501E              JNC     ?C0118
00FE EF                MOV     A,R7
00FF C3                CLR     C
0100 9414              SUBB    A,#014H
0102 4018              JC      ?C0118
                                           ; SOURCE LINE # 786
                                           ; SOURCE LINE # 788
0104 900000      E     MOV     DPTR,#pProject0
0107 E0                MOVX    A,@DPTR
0108 900000      E     MOV     DPTR,#cGPUBattThrottling
010B 30E704            JNB     ACC.7,?C0119
                                           ; SOURCE LINE # 789
                                           ; SOURCE LINE # 790
010E 7401              MOV     A,#01H
                                           ; SOURCE LINE # 791
                                           ; SOURCE LINE # 792
0110 8002              SJMP    ?C0497
0112         ?C0119:
                                           ; SOURCE LINE # 794
                                           ; SOURCE LINE # 795
0112 7402              MOV     A,#02H
0114         ?C0497:
0114 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 796
0115 E4                CLR     A
0116 900000      E     MOV     DPTR,#cBATTThrottling
0119 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 797
011A         ?C0120:
                                           ; SOURCE LINE # 798
011A         ?C0498:
                                           ; SOURCE LINE # 800
011A 8011              SJMP    ?C0500
011C         ?C0118:
                                           ; SOURCE LINE # 802
011C 900000      R     MOV     DPTR,#Power_Temp
011F E0                MOVX    A,@DPTR
0120 C3                CLR     C
0121 9414              SUBB    A,#014H
0123 500F              JNC     ?C0124
                                           ; SOURCE LINE # 803
                                           ; SOURCE LINE # 804
                                           ; SOURCE LINE # 805
0125 120000      R     LCALL   L?0633
                                           ; SOURCE LINE # 806
0128         ?C0499:
                                           ; SOURCE LINE # 807
                                           ; SOURCE LINE # 808
                                           ; SOURCE LINE # 809
0128 8003              SJMP    ?C0500
012A         ?C0107:
                                           ; SOURCE LINE # 811
                                           ; SOURCE LINE # 812
                                           ; SOURCE LINE # 813
012A 120000      R     LCALL   L?0633
                                           ; SOURCE LINE # 814
012D         ?C0500:
012D 900000      E     MOV     DPTR,#Thro_Status
0130 E0                MOVX    A,@DPTR
0131 547F              ANL     A,#07FH
0133 F0                MOVX    @DPTR,A
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 76  

                                           ; SOURCE LINE # 815
                                           ; SOURCE LINE # 816
0134         ?C0124:
0134 22                RET     
             ; FUNCTION ChkBattery_OverConsumption (END)

             ; FUNCTION ChkBattery_OCP (BEGIN)
                                           ; SOURCE LINE # 819
                                           ; SOURCE LINE # 820
                                           ; SOURCE LINE # 845
0000 120000      R     LCALL   L?0563
0003 7030              JNZ     ?C0125
0005 900000      E     MOV     DPTR,#GPDRB
0008 E0                MOVX    A,@DPTR
0009 30E003            JNB     ACC.0,?C0126
000C D3                SETB    C
000D 8001              SJMP    ?C0127
000F         ?C0126:
000F C3                CLR     C
0010         ?C0127:
0010 4023              JC      ?C0125
                                           ; SOURCE LINE # 846
                                           ; SOURCE LINE # 847
0012 900000      E     MOV     DPTR,#Bat0x00TempL
0015 E0                MOVX    A,@DPTR
0016 30E514            JNB     ACC.5,?C0128
                                           ; SOURCE LINE # 848
                                           ; SOURCE LINE # 849
0019 900000      E     MOV     DPTR,#BatteryOCPDelay
001C 740A              MOV     A,#0AH
001E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 850
001F 900000      E     MOV     DPTR,#cGPUBattOCPThrottling
0022 7404              MOV     A,#04H
0024 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 851
0025 900000      E     MOV     DPTR,#LENOVOBATT2
0028 E0                MOVX    A,@DPTR
0029 4401              ORL     A,#01H
002B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 852
002C 22                RET     
002D         ?C0128:
                                           ; SOURCE LINE # 854
                                           ; SOURCE LINE # 855
002D 900000      E     MOV     DPTR,#BatteryOCPDelay
0030 E0                MOVX    A,@DPTR
0031 7013              JNZ     ?C0133
                                           ; SOURCE LINE # 856
                                           ; SOURCE LINE # 857
                                           ; SOURCE LINE # 858
                                           ; SOURCE LINE # 859
                                           ; SOURCE LINE # 860
                                           ; SOURCE LINE # 861
0033 8006              SJMP    ?C0501
0035         ?C0125:
                                           ; SOURCE LINE # 863
                                           ; SOURCE LINE # 864
0035 900000      E     MOV     DPTR,#BatteryOCPDelay
0038 E0                MOVX    A,@DPTR
0039 700B              JNZ     ?C0133
                                           ; SOURCE LINE # 865
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 77  

                                           ; SOURCE LINE # 866
003B         ?C0501:
003B 900000      E     MOV     DPTR,#cGPUBattOCPThrottling
003E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 867
003F 900000      E     MOV     DPTR,#LENOVOBATT2
0042 E0                MOVX    A,@DPTR
0043 54FE              ANL     A,#0FEH
0045 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 868
                                           ; SOURCE LINE # 869
                                           ; SOURCE LINE # 871
0046         ?C0133:
0046 22                RET     
             ; FUNCTION ChkBattery_OCP (END)

             ; FUNCTION ChkBattery_LowVoltage (BEGIN)
                                           ; SOURCE LINE # 874
                                           ; SOURCE LINE # 875
                                           ; SOURCE LINE # 878
0000 900000      E     MOV     DPTR,#GPDRB
0003 E0                MOVX    A,@DPTR
0004 30E003            JNB     ACC.0,?C0135
0007 D3                SETB    C
0008 8001              SJMP    ?C0136
000A         ?C0135:
000A C3                CLR     C
000B         ?C0136:
000B 5003              JNC     $ + 5H
000D 020000      R     LJMP    ?C0134
                                           ; SOURCE LINE # 879
                                           ; SOURCE LINE # 880
0010 900000      E     MOV     DPTR,#nNowCurrentH
0013 E0                MOVX    A,@DPTR
0014 20E703            JB      ACC.7,$ + 6H
0017 020000      R     LJMP    ?C0149
                                           ; SOURCE LINE # 881
                                           ; SOURCE LINE # 882
001A 900000      E     MOV     DPTR,#?_bRSMBusBlock?BYTE+03H
001D 7423              MOV     A,#023H
001F F0                MOVX    @DPTR,A
0020 7E00        E     MOV     R6,#HIGH BAT1_MD_1
0022 A3                INC     DPTR
0023 7400        E     MOV     A,#HIGH BAT1_MD_1
0025 F0                MOVX    @DPTR,A
0026 7400        E     MOV     A,#LOW BAT1_MD_1
0028 120000      R     LCALL   L?0601
002B 120000      E     LCALL   _bRSMBusBlock
002E EF                MOV     A,R7
002F 7003              JNZ     $ + 5H
0031 020000      R     LJMP    ?C0149
                                           ; SOURCE LINE # 883
                                           ; SOURCE LINE # 885
0034 900000      E     MOV     DPTR,#BAT1_MD_6
0037 E0                MOVX    A,@DPTR
0038 FE                MOV     R6,A
0039 900000      E     MOV     DPTR,#BAT1_MD_5
003C 120000      R     LCALL   L?0544
003F 900000      R     MOV     DPTR,#CV4
0042 F0                MOVX    @DPTR,A
0043 A3                INC     DPTR
0044 EF                MOV     A,R7
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 78  

0045 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 886
0046 900000      E     MOV     DPTR,#BAT1_MD_8
0049 E0                MOVX    A,@DPTR
004A FE                MOV     R6,A
004B 900000      E     MOV     DPTR,#BAT1_MD_7
004E E0                MOVX    A,@DPTR
004F 900000      R     MOV     DPTR,#CV3
0052 120000      R     LCALL   L?0564
                                           ; SOURCE LINE # 887
0055 900000      E     MOV     DPTR,#BAT1_MD_A
0058 E0                MOVX    A,@DPTR
0059 FE                MOV     R6,A
005A 900000      E     MOV     DPTR,#BAT1_MD_9
005D E0                MOVX    A,@DPTR
005E 900000      R     MOV     DPTR,#CV2
0061 120000      R     LCALL   L?0634
                                           ; SOURCE LINE # 888
0064 900000      E     MOV     DPTR,#BAT1_MD_C
0067 E0                MOVX    A,@DPTR
0068 FE                MOV     R6,A
0069 900000      E     MOV     DPTR,#BAT1_MD_B
006C E0                MOVX    A,@DPTR
006D 900000      R     MOV     DPTR,#CV1
0070 120000      R     LCALL   L?0634
                                           ; SOURCE LINE # 891
0073 120000      R     LCALL   L?0596
0076 401E              JC      ?C0140
0078 120000      R     LCALL   L?0603
007B 4019              JC      ?C0140
007D 900000      E     MOV     DPTR,#CellCount
0080 E0                MOVX    A,@DPTR
0081 9403              SUBB    A,#03H
0083 4005              JC      ?C0141
0085 120000      R     LCALL   L?0604
0088 400C              JC      ?C0140
008A         ?C0141:
008A 900000      E     MOV     DPTR,#CellCount
008D E0                MOVX    A,@DPTR
008E B4041A            CJNE    A,#04H,?C0139
0091 120000      R     LCALL   L?0597
0094 5015              JNC     ?C0139
0096         ?C0140:
                                           ; SOURCE LINE # 892
                                           ; SOURCE LINE # 893
0096 900000      E     MOV     DPTR,#SysPowState
0099 E0                MOVX    A,@DPTR
009A B41015            CJNE    A,#010H,?C0143
                                           ; SOURCE LINE # 894
                                           ; SOURCE LINE # 895
009D 7FB1              MOV     R7,#0B1H
009F 120000      E     LCALL   _RamDebug
                                           ; SOURCE LINE # 897
00A2 900000      E     MOV     DPTR,#nBatteryStatH
00A5 E0                MOVX    A,@DPTR
00A6 4404              ORL     A,#04H
00A8 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 898
                                           ; SOURCE LINE # 899
00A9 8007              SJMP    ?C0143
00AB         ?C0139:
                                           ; SOURCE LINE # 901
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 79  

                                           ; SOURCE LINE # 902
00AB 900000      E     MOV     DPTR,#nBatteryStatH
00AE E0                MOVX    A,@DPTR
00AF 54FB              ANL     A,#0FBH
00B1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 903
00B2         ?C0143:
                                           ; SOURCE LINE # 907
00B2 120000      R     LCALL   L?0596
00B5 401E              JC      ?C0145
00B7 120000      R     LCALL   L?0603
00BA 4019              JC      ?C0145
00BC 900000      E     MOV     DPTR,#CellCount
00BF E0                MOVX    A,@DPTR
00C0 9403              SUBB    A,#03H
00C2 4005              JC      ?C0146
00C4 120000      R     LCALL   L?0604
00C7 400C              JC      ?C0145
00C9         ?C0146:
00C9 900000      E     MOV     DPTR,#CellCount
00CC E0                MOVX    A,@DPTR
00CD B4040D            CJNE    A,#04H,?C0144
00D0 120000      R     LCALL   L?0597
00D3 5008              JNC     ?C0144
00D5         ?C0145:
                                           ; SOURCE LINE # 908
                                           ; SOURCE LINE # 909
00D5 900000      E     MOV     DPTR,#BatteryAlarm
00D8 E0                MOVX    A,@DPTR
00D9 4420              ORL     A,#020H
00DB F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 911
00DC 22                RET     
00DD         ?C0144:
                                           ; SOURCE LINE # 913
                                           ; SOURCE LINE # 914
00DD 900000      E     MOV     DPTR,#BatteryAlarm
00E0 E0                MOVX    A,@DPTR
00E1 54DF              ANL     A,#0DFH
00E3 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 915
                                           ; SOURCE LINE # 916
                                           ; SOURCE LINE # 917
                                           ; SOURCE LINE # 918
00E4 22                RET     
00E5         ?C0134:
                                           ; SOURCE LINE # 920
                                           ; SOURCE LINE # 921
00E5 900000      E     MOV     DPTR,#BatteryAlarm
00E8 E0                MOVX    A,@DPTR
00E9 54DF              ANL     A,#0DFH
00EB F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 922
00EC 900000      E     MOV     DPTR,#nBatteryStatH
00EF E0                MOVX    A,@DPTR
00F0 54FB              ANL     A,#0FBH
00F2 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 923
                                           ; SOURCE LINE # 924
00F3         ?C0149:
00F3 22                RET     
             ; FUNCTION ChkBattery_LowVoltage (END)
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 80  


             ; FUNCTION CkkBattery_RSOCLow (BEGIN)
                                           ; SOURCE LINE # 928
                                           ; SOURCE LINE # 929
                                           ; SOURCE LINE # 930
0000 900000      E     MOV     DPTR,#GPDRB
0003 E0                MOVX    A,@DPTR
0004 30E003            JNB     ACC.0,?C0152
0007 D3                SETB    C
0008 8001              SJMP    ?C0153
000A         ?C0152:
000A C3                CLR     C
000B         ?C0153:
000B 5007              JNC     ?C0151
000D 900000      E     MOV     DPTR,#CHGIC_ReadCmd0x12L
0010 E0                MOVX    A,@DPTR
0011 30E517            JNB     ACC.5,?C0150
0014         ?C0151:
                                           ; SOURCE LINE # 931
                                           ; SOURCE LINE # 932
0014 120000      R     LCALL   L?0621
0017 5007              JNC     ?C0154
                                           ; SOURCE LINE # 933
                                           ; SOURCE LINE # 934
0019 900000      E     MOV     DPTR,#cGPUBattLowThrottling
001C 7404              MOV     A,#04H
001E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 937
001F 22                RET     
0020         ?C0154:
                                           ; SOURCE LINE # 938
0020 120000      R     LCALL   L?0621
0023 400F              JC      ?C0158
                                           ; SOURCE LINE # 939
                                           ; SOURCE LINE # 940
0025 E4                CLR     A
0026 900000      E     MOV     DPTR,#cGPUBattLowThrottling
0029 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 942
                                           ; SOURCE LINE # 943
002A 22                RET     
002B         ?C0150:
                                           ; SOURCE LINE # 945
                                           ; SOURCE LINE # 946
002B E4                CLR     A
002C 900000      E     MOV     DPTR,#cGPUBattLowThrottling
002F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 947
0030 900000      E     MOV     DPTR,#cBATTLowThrottling
0033 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 949
                                           ; SOURCE LINE # 950
0034         ?C0158:
0034 22                RET     
             ; FUNCTION CkkBattery_RSOCLow (END)

             ; FUNCTION ChkBattery_FCCchg (BEGIN)
                                           ; SOURCE LINE # 953
                                           ; SOURCE LINE # 954
                                           ; SOURCE LINE # 955
0000 900000      E     MOV     DPTR,#ChkBattery_FCCchg_count
0003 E0                MOVX    A,@DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 81  

0004 04                INC     A
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 956
0006 E0                MOVX    A,@DPTR
0007 C3                CLR     C
0008 9464              SUBB    A,#064H
000A 4041              JC      ?C0161
                                           ; SOURCE LINE # 957
                                           ; SOURCE LINE # 958
000C E4                CLR     A
000D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 959
000E 900000      E     MOV     DPTR,#ChkBattery_FCCchg_count2
0011 E0                MOVX    A,@DPTR
0012 04                INC     A
0013 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 960
0014 E0                MOVX    A,@DPTR
0015 941E              SUBB    A,#01EH
0017 4034              JC      ?C0161
                                           ; SOURCE LINE # 961
                                           ; SOURCE LINE # 963
0019         ?C0160:
                                           ; SOURCE LINE # 964
0019 E4                CLR     A
001A 900000      E     MOV     DPTR,#ChkBattery_FCCchg_count2
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 966
001E 900000      E     MOV     DPTR,#ChkBattery_FCCchg_lastFCCL
0021 E0                MOVX    A,@DPTR
0022 7009              JNZ     ?C0162
0024 900000      E     MOV     DPTR,#ChkBattery_FCCchg_lastFCCH
0027 E0                MOVX    A,@DPTR
0028 7003              JNZ     ?C0162
                                           ; SOURCE LINE # 967
                                           ; SOURCE LINE # 968
                                           ; SOURCE LINE # 969
002A 120000      R     LCALL   L?0576
                                           ; SOURCE LINE # 970
002D         ?C0162:
                                           ; SOURCE LINE # 973
002D 900000      E     MOV     DPTR,#nFullChgCapL
0030 E0                MOVX    A,@DPTR
0031 FF                MOV     R7,A
0032 900000      E     MOV     DPTR,#ChkBattery_FCCchg_lastFCCL
0035 E0                MOVX    A,@DPTR
0036 6F                XRL     A,R7
0037 700C              JNZ     ?C0164
0039 900000      E     MOV     DPTR,#nFullChgCapH
003C E0                MOVX    A,@DPTR
003D FF                MOV     R7,A
003E 900000      E     MOV     DPTR,#ChkBattery_FCCchg_lastFCCH
0041 E0                MOVX    A,@DPTR
0042 6F                XRL     A,R7
0043 6008              JZ      ?C0161
0045         ?C0164:
                                           ; SOURCE LINE # 975
                                           ; SOURCE LINE # 976
0045 7F25              MOV     R7,#025H
0047 120000      E     LCALL   _ECSMI_SCIEvent
                                           ; SOURCE LINE # 977
                                           ; SOURCE LINE # 978
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 82  

004A 120000      R     LCALL   L?0576
                                           ; SOURCE LINE # 979
                                           ; SOURCE LINE # 980
                                           ; SOURCE LINE # 981
004D         ?C0161:
004D 22                RET     
             ; FUNCTION ChkBattery_FCCchg (END)

             ; FUNCTION ChkAvgCurrent (BEGIN)
                                           ; SOURCE LINE # 983
                                           ; SOURCE LINE # 984
                                           ; SOURCE LINE # 991
0000 900000      E     MOV     DPTR,#Bat0x0BTempH
0003 E0                MOVX    A,@DPTR
0004 30E71C            JNB     ACC.7,?C0165
                                           ; SOURCE LINE # 992
                                           ; SOURCE LINE # 993
0007 E0                MOVX    A,@DPTR
0008 FE                MOV     R6,A
0009 900000      E     MOV     DPTR,#Bat0x0BTempL
000C 120000      R     LCALL   L?0544
000F 120000      R     LCALL   L?0569
0012 900000      E     MOV     DPTR,#XWTemp1
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 994
0016 C3                CLR     C
0017 A3                INC     DPTR
0018 E0                MOVX    A,@DPTR
0019 9490              SUBB    A,#090H
001B 900000      E     MOV     DPTR,#XWTemp1
001E E0                MOVX    A,@DPTR
001F 9401              SUBB    A,#01H
0021 4058              JC      ?C0167
                                           ; SOURCE LINE # 995
                                           ; SOURCE LINE # 997
                                           ; SOURCE LINE # 998
0023         ?C0165:
                                           ; SOURCE LINE # 1000
0023 900000      E     MOV     DPTR,#SYS_STATUS
0026 E0                MOVX    A,@DPTR
0027 20E717            JB      ACC.7,?C0168
002A 900000      E     MOV     DPTR,#SysPowState
002D E0                MOVX    A,@DPTR
002E B41010            CJNE    A,#010H,?C0168
0031 900000      E     MOV     DPTR,#Bat0x0BTempH
0034 E0                MOVX    A,@DPTR
0035 20E709            JB      ACC.7,?C0168
                                           ; SOURCE LINE # 1001
                                           ; SOURCE LINE # 1003
0038 900000      E     MOV     DPTR,#nNowCurrentH
003B E0                MOVX    A,@DPTR
003C 30E73C            JNB     ACC.7,?C0167
                                           ; SOURCE LINE # 1004
                                           ; SOURCE LINE # 1005
                                           ; SOURCE LINE # 1006
                                           ; SOURCE LINE # 1007
003F 801C              SJMP    ?C0502
                                           ; SOURCE LINE # 1009
0041         ?C0168:
                                           ; SOURCE LINE # 1011
0041 900000      E     MOV     DPTR,#Bat0x0BFakeCnt
0044 E0                MOVX    A,@DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 83  

0045 700D              JNZ     ?C0170
                                           ; SOURCE LINE # 1012
                                           ; SOURCE LINE # 1013
0047 900000      E     MOV     DPTR,#Bat0x0BTempL
004A E0                MOVX    A,@DPTR
004B 900000      E     MOV     DPTR,#nAvgCurrentL
004E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1014
004F 900000      E     MOV     DPTR,#Bat0x0BTempH
                                           ; SOURCE LINE # 1015
0052 8014              SJMP    ?C0503
0054         ?C0170:
                                           ; SOURCE LINE # 1016
0054 900000      E     MOV     DPTR,#Bat0x0BFakeCnt
0057 E0                MOVX    A,@DPTR
0058 C3                CLR     C
0059 943C              SUBB    A,#03CH
005B 500E              JNC     ?C0172
                                           ; SOURCE LINE # 1017
                                           ; SOURCE LINE # 1018
005D         ?C0502:
005D 900000      E     MOV     DPTR,#nNowCurrentL
0060 E0                MOVX    A,@DPTR
0061 900000      E     MOV     DPTR,#nAvgCurrentL
0064 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1019
0065 900000      E     MOV     DPTR,#nNowCurrentH
0068         ?C0503:
0068 E0                MOVX    A,@DPTR
                                           ; SOURCE LINE # 1020
0069 800C              SJMP    ?C0504
006B         ?C0172:
                                           ; SOURCE LINE # 1021
006B 900000      E     MOV     DPTR,#Bat0x0BFakeCnt
006E E0                MOVX    A,@DPTR
006F B43C09            CJNE    A,#03CH,?C0167
                                           ; SOURCE LINE # 1022
                                           ; SOURCE LINE # 1023
0072 E4                CLR     A
0073 900000      E     MOV     DPTR,#nAvgCurrentL
0076 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1024
0077         ?C0504:
0077 900000      E     MOV     DPTR,#nAvgCurrentH
007A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1025
                                           ; SOURCE LINE # 1026
007B         ?C0167:
007B 22                RET     
             ; FUNCTION ChkAvgCurrent (END)

             ; FUNCTION RST_ChgTimeOutCnt (BEGIN)
                                           ; SOURCE LINE # 1028
                                           ; SOURCE LINE # 1029
                                           ; SOURCE LINE # 1030
                                           ; SOURCE LINE # 1031
0000 120000      R     LCALL   L?0623
0003 F0                MOVX    @DPTR,A
0004 A3                INC     DPTR
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1032
0006 900000      E     MOV     DPTR,#nStopChgStat3L
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 84  

0009 E0                MOVX    A,@DPTR
000A 54FE              ANL     A,#0FEH
000C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1033
000D 900000      E     MOV     DPTR,#nStopChgStat3H
0010 E0                MOVX    A,@DPTR
0011 54FE              ANL     A,#0FEH
0013 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1034
0014 22                RET     
             ; FUNCTION RST_ChgTimeOutCnt (END)

             ; FUNCTION Battery100ms (BEGIN)
                                           ; SOURCE LINE # 1036
                                           ; SOURCE LINE # 1037
                                           ; SOURCE LINE # 1038
0000 900000      E     MOV     DPTR,#inhibit2sec
0003 E0                MOVX    A,@DPTR
0004 6004              JZ      ?C0176
                                           ; SOURCE LINE # 1039
0006 E0                MOVX    A,@DPTR
0007 14                DEC     A
0008 F0                MOVX    @DPTR,A
0009 22                RET     
000A         ?C0176:
                                           ; SOURCE LINE # 1041
000A 900000      E     MOV     DPTR,#nStopChgStat3L
000D E0                MOVX    A,@DPTR
000E 54F7              ANL     A,#0F7H
0010 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1042
0011         ?C0178:
0011 22                RET     
             ; FUNCTION Battery100ms (END)

             ; FUNCTION ChkPsys (BEGIN)
                                           ; SOURCE LINE # 1043
                                           ; SOURCE LINE # 1044
                                           ; SOURCE LINE # 1045
0000 900000      E     MOV     DPTR,#GPDRB
0003 E0                MOVX    A,@DPTR
0004 30E016            JNB     ACC.0,?C0179
                                           ; SOURCE LINE # 1046
                                           ; SOURCE LINE # 1047
0007 900000      E     MOV     DPTR,#nBattGasgauge
000A E0                MOVX    A,@DPTR
000B C3                CLR     C
000C 9405              SUBB    A,#05H
000E 4006              JC      ?C0180
                                           ; SOURCE LINE # 1048
0010 E4                CLR     A
0011 900000      E     MOV     DPTR,#cGPUBattThrottling
0014 F0                MOVX    @DPTR,A
0015 22                RET     
0016         ?C0180:
                                           ; SOURCE LINE # 1050
0016 900000      E     MOV     DPTR,#cGPUBattThrottling
0019 7402              MOV     A,#02H
001B F0                MOVX    @DPTR,A
001C 22                RET     
                                           ; SOURCE LINE # 1052
001D         ?C0179:
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 85  

                                           ; SOURCE LINE # 1053
001D 900000      E     MOV     DPTR,#Proch_Delay1
0020 E0                MOVX    A,@DPTR
0021 D3                SETB    C
0022 9400              SUBB    A,#00H
0024 4003              JC      ?C0183
                                           ; SOURCE LINE # 1054
0026 E0                MOVX    A,@DPTR
0027 14                DEC     A
0028 F0                MOVX    @DPTR,A
0029         ?C0183:
                                           ; SOURCE LINE # 1055
0029 900000      E     MOV     DPTR,#Proch_Delay1
002C E0                MOVX    A,@DPTR
002D D3                SETB    C
002E 940A              SUBB    A,#0AH
0030 4003              JC      ?C0184
                                           ; SOURCE LINE # 1056
0032 740A              MOV     A,#0AH
0034 F0                MOVX    @DPTR,A
0035         ?C0184:
                                           ; SOURCE LINE # 1057
0035 120000      R     LCALL   L?0563
0038 6003              JZ      $ + 5H
003A 020000      R     LJMP    ?C0185
003D 900000      E     MOV     DPTR,#GPDRB
0040 E0                MOVX    A,@DPTR
0041 30E003            JNB     ACC.0,?C0186
0044 D3                SETB    C
0045 8001              SJMP    ?C0187
0047         ?C0186:
0047 C3                CLR     C
0048         ?C0187:
0048 5003              JNC     $ + 5H
004A 020000      R     LJMP    ?C0185
004D 900000      E     MOV     DPTR,#cGPUACtoBattTime
0050 E0                MOVX    A,@DPTR
0051 6003              JZ      $ + 5H
0053 020000      R     LJMP    ?C0185
                                           ; SOURCE LINE # 1058
                                           ; SOURCE LINE # 1060
0056 900000      E     MOV     DPTR,#CellCount
0059 E0                MOVX    A,@DPTR
005A 6402              XRL     A,#02H
005C 6003              JZ      $ + 5H
005E 020000      R     LJMP    ?C0188
                                           ; SOURCE LINE # 1061
                                           ; SOURCE LINE # 1062
0061 120000      R     LCALL   L?0618
0064 4053              JC      ?C0189
                                           ; SOURCE LINE # 1063
                                           ; SOURCE LINE # 1064
0066 120000      R     LCALL   L?0555
0069 4011              JC      ?C0190
                                           ; SOURCE LINE # 1065
                                           ; SOURCE LINE # 1066
006B 120000      R     LCALL   L?0619
                                           ; SOURCE LINE # 1067
006E 900000      E     MOV     DPTR,#Thro_Status2
0071 E0                MOVX    A,@DPTR
0072 4480              ORL     A,#080H
0074 F0                MOVX    @DPTR,A
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 86  

                                           ; SOURCE LINE # 1068
0075 900000      E     MOV     DPTR,#Proch_Delay1
0078 740A              MOV     A,#0AH
007A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1069
007B 22                RET     
007C         ?C0190:
                                           ; SOURCE LINE # 1070
007C C3                CLR     C
007D 900000      E     MOV     DPTR,#Psys_AvgData+01H
0080 E0                MOVX    A,@DPTR
0081 9463              SUBB    A,#063H
0083 120000      R     LCALL   L?0557
0086 4011              JC      ?C0192
0088 A3                INC     DPTR
0089 120000      R     LCALL   L?0556
008C 500B              JNC     ?C0192
                                           ; SOURCE LINE # 1071
                                           ; SOURCE LINE # 1072
008E 900000      E     MOV     DPTR,#Proch_Delay1
0091 E0                MOVX    A,@DPTR
0092 6003              JZ      $ + 5H
0094 020000      R     LJMP    ?C0182
                                           ; SOURCE LINE # 1073
                                           ; SOURCE LINE # 1074
                                           ; SOURCE LINE # 1075
                                           ; SOURCE LINE # 1076
                                           ; SOURCE LINE # 1077
                                           ; SOURCE LINE # 1078
0097 8039              SJMP    ?C0505
0099         ?C0192:
                                           ; SOURCE LINE # 1079
0099 C3                CLR     C
009A 900000      E     MOV     DPTR,#Psys_AvgData+01H
009D E0                MOVX    A,@DPTR
009E 9463              SUBB    A,#063H
00A0 120000      R     LCALL   L?0557
00A3 4003              JC      $ + 5H
00A5 020000      R     LJMP    ?C0182
                                           ; SOURCE LINE # 1080
                                           ; SOURCE LINE # 1081
00A8 900000      E     MOV     DPTR,#Proch_Delay1
00AB E0                MOVX    A,@DPTR
00AC 6003              JZ      $ + 5H
00AE 020000      R     LJMP    ?C0182
                                           ; SOURCE LINE # 1082
                                           ; SOURCE LINE # 1083
00B1 900000      E     MOV     DPTR,#cGPUBattThrottling
00B4 7402              MOV     A,#02H
                                           ; SOURCE LINE # 1084
                                           ; SOURCE LINE # 1085
                                           ; SOURCE LINE # 1086
                                           ; SOURCE LINE # 1087
                                           ; SOURCE LINE # 1088
00B6 020000      R     LJMP    ?C0508
00B9         ?C0189:
                                           ; SOURCE LINE # 1089
00B9 D3                SETB    C
00BA 120000      R     LCALL   L?0622
00BD 401A              JC      ?C0198
                                           ; SOURCE LINE # 1090
                                           ; SOURCE LINE # 1091
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 87  

00BF 900000      E     MOV     DPTR,#Psys_AvgData+01H
00C2 E0                MOVX    A,@DPTR
00C3 949A              SUBB    A,#09AH
00C5 120000      R     LCALL   L?0557
00C8 4002              JC      ?C0199
                                           ; SOURCE LINE # 1092
                                           ; SOURCE LINE # 1093
                                           ; SOURCE LINE # 1094
                                           ; SOURCE LINE # 1095
00CA 8038              SJMP    ?C0507
00CC         ?C0199:
                                           ; SOURCE LINE # 1096
00CC C3                CLR     C
00CD 120000      R     LCALL   L?0555
00D0 5065              JNC     ?C0182
                                           ; SOURCE LINE # 1097
                                           ; SOURCE LINE # 1098
00D2         ?C0505:
00D2 900000      E     MOV     DPTR,#cGPUBattThrottling
00D5 7403              MOV     A,#03H
00D7         ?C0506:
                                           ; SOURCE LINE # 1099
                                           ; SOURCE LINE # 1100
                                           ; SOURCE LINE # 1101
                                           ; SOURCE LINE # 1102
00D7 804F              SJMP    ?C0508
00D9         ?C0198:
                                           ; SOURCE LINE # 1104
                                           ; SOURCE LINE # 1105
00D9 900000      E     MOV     DPTR,#cGPUBattThrottling
00DC 7404              MOV     A,#04H
00DE F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1106
00DF 120000      R     LCALL   L?0619
                                           ; SOURCE LINE # 1107
00E2 120000      R     LCALL   L?0598
00E5 4002              JC      ?C0203
                                           ; SOURCE LINE # 1108
                                           ; SOURCE LINE # 1109
                                           ; SOURCE LINE # 1110
00E7 801E              SJMP    ?C0509
00E9         ?C0203:
                                           ; SOURCE LINE # 1111
00E9 120000      R     LCALL   L?0598
00EC 5049              JNC     ?C0182
                                           ; SOURCE LINE # 1112
                                           ; SOURCE LINE # 1113
                                           ; SOURCE LINE # 1114
                                           ; SOURCE LINE # 1115
                                           ; SOURCE LINE # 1116
00EE 8040              SJMP    ?C0511
00F0         ?C0188:
                                           ; SOURCE LINE # 1118
00F0 900000      E     MOV     DPTR,#CellCount
00F3 E0                MOVX    A,@DPTR
00F4 6403              XRL     A,#03H
00F6 703F              JNZ     ?C0182
                                           ; SOURCE LINE # 1119
                                           ; SOURCE LINE # 1120
00F8 C3                CLR     C
00F9 900000      E     MOV     DPTR,#Psys_AvgData+01H
00FC E0                MOVX    A,@DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 88  

00FD 943A              SUBB    A,#03AH
00FF 120000      R     LCALL   L?0557
0102 400B              JC      ?C0208
                                           ; SOURCE LINE # 1121
                                           ; SOURCE LINE # 1122
0104         ?C0507:
0104 120000      R     LCALL   L?0620
                                           ; SOURCE LINE # 1123
0107         ?C0509:
0107 900000      E     MOV     DPTR,#Thro_Status2
010A E0                MOVX    A,@DPTR
010B 4480              ORL     A,#080H
010D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1124
010E 22                RET     
010F         ?C0208:
                                           ; SOURCE LINE # 1125
010F C3                CLR     C
0110 900000      E     MOV     DPTR,#Psys_AvgData+01H
0113 E0                MOVX    A,@DPTR
0114 9411              SUBB    A,#011H
0116 120000      R     LCALL   L?0557
0119 501C              JNC     ?C0182
                                           ; SOURCE LINE # 1126
                                           ; SOURCE LINE # 1127
011B 900000      E     MOV     DPTR,#GPU_Prochot
011E E0                MOVX    A,@DPTR
011F 54FD              ANL     A,#0FDH
0121 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1128
0122         ?C0510:
                                           ; SOURCE LINE # 1129
                                           ; SOURCE LINE # 1130
                                           ; SOURCE LINE # 1131
0122 800C              SJMP    ?C0511
0124         ?C0185:
                                           ; SOURCE LINE # 1133
                                           ; SOURCE LINE # 1134
0124 E4                CLR     A
0125 900000      E     MOV     DPTR,#cGPUBattThrottling
0128         ?C0508:
0128 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1135
0129 900000      E     MOV     DPTR,#GPU_Prochot
012C E0                MOVX    A,@DPTR
012D 54FD              ANL     A,#0FDH
012F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1136
0130         ?C0511:
0130 900000      E     MOV     DPTR,#Thro_Status2
0133 E0                MOVX    A,@DPTR
0134 547F              ANL     A,#07FH
0136 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1137
                                           ; SOURCE LINE # 1139
0137         ?C0182:
0137 22                RET     
             ; FUNCTION ChkPsys (END)

             ; FUNCTION TurboDCOnly (BEGIN)
                                           ; SOURCE LINE # 1140
                                           ; SOURCE LINE # 1141
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 89  

                                           ; SOURCE LINE # 1142
0000 120000      R     LCALL   L?0563
0003 7059              JNZ     ?C0212
0005 900000      E     MOV     DPTR,#GPDRB
0008 E0                MOVX    A,@DPTR
0009 30E003            JNB     ACC.0,?C0213
000C D3                SETB    C
000D 8001              SJMP    ?C0214
000F         ?C0213:
000F C3                CLR     C
0010         ?C0214:
0010 404C              JC      ?C0212
                                           ; SOURCE LINE # 1143
                                           ; SOURCE LINE # 1144
0012 900000      E     MOV     DPTR,#nBattGasgauge
0015 E0                MOVX    A,@DPTR
0016 9446              SUBB    A,#046H
0018 4015              JC      ?C0215
                                           ; SOURCE LINE # 1145
                                           ; SOURCE LINE # 1146
001A 900000      E     MOV     DPTR,#VGA_TBuff3
001D E0                MOVX    A,@DPTR
001E 9433              SUBB    A,#033H
0020 4002              JC      ?C0216
                                           ; SOURCE LINE # 1147
                                           ; SOURCE LINE # 1148
                                           ; SOURCE LINE # 1149
0022 801D              SJMP    ?C0512
0024         ?C0216:
                                           ; SOURCE LINE # 1150
0024 900000      E     MOV     DPTR,#VGA_TBuff3
0027 E0                MOVX    A,@DPTR
0028 C3                CLR     C
0029 942F              SUBB    A,#02FH
002B 5038              JNC     ?C0224
                                           ; SOURCE LINE # 1151
                                           ; SOURCE LINE # 1152
                                           ; SOURCE LINE # 1153
                                           ; SOURCE LINE # 1154
002D 802F              SJMP    ?C0514
002F         ?C0215:
                                           ; SOURCE LINE # 1156
                                           ; SOURCE LINE # 1157
002F 900000      E     MOV     DPTR,#VGA_TBuff3
0032 E0                MOVX    A,@DPTR
0033 C3                CLR     C
0034 9433              SUBB    A,#033H
0036 5009              JNC     ?C0221
0038 900000      E     MOV     DPTR,#TEMP_Buff_3
003B E0                MOVX    A,@DPTR
003C C3                CLR     C
003D 9441              SUBB    A,#041H
003F 4009              JC      ?C0220
0041         ?C0221:
                                           ; SOURCE LINE # 1158
                                           ; SOURCE LINE # 1159
0041         ?C0512:
0041 900000      E     MOV     DPTR,#Thro_Status
0044 E0                MOVX    A,@DPTR
0045 4440              ORL     A,#040H
0047 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1160
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 90  

0048 801B              SJMP    ?C0224
004A         ?C0220:
                                           ; SOURCE LINE # 1161
004A 900000      E     MOV     DPTR,#VGA_TBuff3
004D E0                MOVX    A,@DPTR
004E C3                CLR     C
004F 942F              SUBB    A,#02FH
0051 5012              JNC     ?C0224
0053 900000      E     MOV     DPTR,#TEMP_Buff_3
0056 E0                MOVX    A,@DPTR
0057 C3                CLR     C
0058 943C              SUBB    A,#03CH
005A 5009              JNC     ?C0224
                                           ; SOURCE LINE # 1162
                                           ; SOURCE LINE # 1163
005C         ?C0513:
                                           ; SOURCE LINE # 1164
                                           ; SOURCE LINE # 1165
                                           ; SOURCE LINE # 1166
005C 8000              SJMP    ?C0514
005E         ?C0212:
                                           ; SOURCE LINE # 1168
                                           ; SOURCE LINE # 1169
005E         ?C0514:
005E 900000      E     MOV     DPTR,#Thro_Status
0061 E0                MOVX    A,@DPTR
0062 54BF              ANL     A,#0BFH
0064 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1170
0065         ?C0224:
                                           ; SOURCE LINE # 1171
0065 900000      E     MOV     DPTR,#Thro_Status
0068 E0                MOVX    A,@DPTR
0069 5448              ANL     A,#048H
006B 700F              JNZ     ?C0225
                                           ; SOURCE LINE # 1172
                                           ; SOURCE LINE # 1173
006D 900000      E     MOV     DPTR,#uVGATurboFun
0070 E0                MOVX    A,@DPTR
0071 30E318            JNB     ACC.3,?C0229
                                           ; SOURCE LINE # 1174
                                           ; SOURCE LINE # 1175
0074 E0                MOVX    A,@DPTR
0075 54F7              ANL     A,#0F7H
0077 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1176
0078 7F67              MOV     R7,#067H
                                           ; SOURCE LINE # 1177
                                           ; SOURCE LINE # 1178
007A 800D              SJMP    ?C0515
007C         ?C0225:
                                           ; SOURCE LINE # 1180
                                           ; SOURCE LINE # 1181
007C 900000      E     MOV     DPTR,#uVGATurboFun
007F E0                MOVX    A,@DPTR
0080 20E309            JB      ACC.3,?C0229
                                           ; SOURCE LINE # 1182
                                           ; SOURCE LINE # 1183
0083 E0                MOVX    A,@DPTR
0084 4408              ORL     A,#08H
0086 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1184
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 91  

0087 7F66              MOV     R7,#066H
0089         ?C0515:
0089 120000      E     LCALL   _ECQEvent
                                           ; SOURCE LINE # 1185
                                           ; SOURCE LINE # 1186
                                           ; SOURCE LINE # 1187
008C         ?C0229:
008C 22                RET     
             ; FUNCTION TurboDCOnly (END)

             ; FUNCTION Battery1Sec (BEGIN)
                                           ; SOURCE LINE # 1188
                                           ; SOURCE LINE # 1189
                                           ; SOURCE LINE # 1191
0000 900000      E     MOV     DPTR,#Bat0x0BFakeCnt
0003 E0                MOVX    A,@DPTR
0004 6003              JZ      ?C0230
                                           ; SOURCE LINE # 1192
0006 E0                MOVX    A,@DPTR
0007 14                DEC     A
0008 F0                MOVX    @DPTR,A
0009         ?C0230:
                                           ; SOURCE LINE # 1194
0009 900000      E     MOV     DPTR,#BatSMbusFailCount
000C E0                MOVX    A,@DPTR
000D 6023              JZ      ?C0231
                                           ; SOURCE LINE # 1195
                                           ; SOURCE LINE # 1196
000F 900000      E     MOV     DPTR,#Bat1_FPChgFlag
0012 E0                MOVX    A,@DPTR
0013 4401              ORL     A,#01H
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1197
0016 900000      E     MOV     DPTR,#nBattErrorCnt
0019 E0                MOVX    A,@DPTR
001A 04                INC     A
001B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1198
001C E0                MOVX    A,@DPTR
001D D3                SETB    C
001E 94FA              SUBB    A,#0FAH
0020 4003              JC      ?C0232
                                           ; SOURCE LINE # 1199
0022 74FB              MOV     A,#0FBH
0024 F0                MOVX    @DPTR,A
0025         ?C0232:
                                           ; SOURCE LINE # 1200
0025 900000      E     MOV     DPTR,#BatSMbusFailCount
0028 E0                MOVX    A,@DPTR
0029 D3                SETB    C
002A 94DC              SUBB    A,#0DCH
002C 4039              JC      ?C0240
                                           ; SOURCE LINE # 1201
002E 74DD              MOV     A,#0DDH
0030 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1202
0031 22                RET     
0032         ?C0231:
                                           ; SOURCE LINE # 1204
                                           ; SOURCE LINE # 1205
0032 E4                CLR     A
0033 900000      E     MOV     DPTR,#nBattErrorCnt
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 92  

0036 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1206
0037 900000      E     MOV     DPTR,#nNowCurrentH
003A E0                MOVX    A,@DPTR
003B FF                MOV     R7,A
003C 900000      E     MOV     DPTR,#nNowCurrentL
003F E0                MOVX    A,@DPTR
0040 4F                ORL     A,R7
0041 601F              JZ      ?C0235
                                           ; SOURCE LINE # 1207
                                           ; SOURCE LINE # 1208
0043 900000      E     MOV     DPTR,#nNowCurrentH
0046 E0                MOVX    A,@DPTR
0047 20E710            JB      ACC.7,?C0236
                                           ; SOURCE LINE # 1209
                                           ; SOURCE LINE # 1210
004A 900000      E     MOV     DPTR,#nBattTempCnt
004D E0                MOVX    A,@DPTR
004E 04                INC     A
004F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1211
0050 E0                MOVX    A,@DPTR
0051 C3                CLR     C
0052 940A              SUBB    A,#0AH
0054 4011              JC      ?C0240
                                           ; SOURCE LINE # 1212
0056 740B              MOV     A,#0BH
0058 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1213
0059 22                RET     
005A         ?C0236:
                                           ; SOURCE LINE # 1215
                                           ; SOURCE LINE # 1216
005A E4                CLR     A
005B 900000      E     MOV     DPTR,#nBattTempCnt
005E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1217
005F 020000      R     LJMP    RST_ChgTimeOutCnt
                                           ; SOURCE LINE # 1218
                                           ; SOURCE LINE # 1219
0062         ?C0235:
                                           ; SOURCE LINE # 1221
                                           ; SOURCE LINE # 1222
0062 E4                CLR     A
0063 900000      E     MOV     DPTR,#nBattTempCnt
0066 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1223
                                           ; SOURCE LINE # 1224
                                           ; SOURCE LINE # 1225
0067         ?C0240:
0067 22                RET     
             ; FUNCTION Battery1Sec (END)

             ; FUNCTION _GetBatData (BEGIN)
                                           ; SOURCE LINE # 1264
0000 900000      R     MOV     DPTR,#_STEP
0003 EF                MOV     A,R7
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1265
                                           ; SOURCE LINE # 1266
0005 14                DEC     A
0006 24FC              ADD     A,#0FCH
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 93  

0008 5002              JNC     ?C0245
000A 801E              SJMP    ?C0248
                                           ; SOURCE LINE # 1267
                                           ; SOURCE LINE # 1268
                                           ; SOURCE LINE # 1272
                                           ; SOURCE LINE # 1273
                                           ; SOURCE LINE # 1274
000C         ?C0245:
                                           ; SOURCE LINE # 1275
000C 120000      R     LCALL   L?0547
000F FD                MOV     R5,A
0010 7401              MOV     A,#01H
0012 93                MOVC    A,@A+DPTR
0013 900000      E     MOV     DPTR,#?_bRSMBusBlock?BYTE+04H
0016 CD                XCH     A,R5
0017 F0                MOVX    @DPTR,A
0018 A3                INC     DPTR
0019 ED                MOV     A,R5
001A F0                MOVX    @DPTR,A
001B 900000      E     MOV     DPTR,#?_bRSMBusBlock?BYTE+03H
001E EE                MOV     A,R6
001F 120000      R     LCALL   L?0602
0022 120000      E     LCALL   _bRSMBusBlock
0025 EF                MOV     A,R7
0026 702A              JNZ     ?C0517
                                           ; SOURCE LINE # 1278
                                           ; SOURCE LINE # 1279
                                           ; SOURCE LINE # 1281
0028 8021              SJMP    ?C0516
                                           ; SOURCE LINE # 1288
002A         ?C0248:
                                           ; SOURCE LINE # 1289
002A 120000      R     LCALL   L?0547
002D FD                MOV     R5,A
002E 7401              MOV     A,#01H
0030 93                MOVC    A,@A+DPTR
0031 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+04H
0034 CD                XCH     A,R5
0035 F0                MOVX    @DPTR,A
0036 A3                INC     DPTR
0037 ED                MOV     A,R5
0038 F0                MOVX    @DPTR,A
0039 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+03H
003C EE                MOV     A,R6
003D F0                MOVX    @DPTR,A
003E E4                CLR     A
003F 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+06H
0042 120000      R     LCALL   L?0583
0045 120000      E     LCALL   _bRWSMBus
0048 EF                MOV     A,R7
0049 7007              JNZ     ?C0249
                                           ; SOURCE LINE # 1293
                                           ; SOURCE LINE # 1294
004B         ?C0516:
004B 900000      E     MOV     DPTR,#BatSMbusFailCount
004E E0                MOVX    A,@DPTR
004F 04                INC     A
0050 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1296
0051 22                RET     
0052         ?C0249:
                                           ; SOURCE LINE # 1298
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 94  

                                           ; SOURCE LINE # 1299
0052         ?C0517:
0052 E4                CLR     A
0053 900000      E     MOV     DPTR,#BatSMbusFailCount
0056 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1300
                                           ; SOURCE LINE # 1302
                                           ; SOURCE LINE # 1303
                                           ; SOURCE LINE # 1304
0057         ?C0251:
0057 22                RET     
             ; FUNCTION _GetBatData (END)

             ; FUNCTION ChkBattery_Percl (BEGIN)
                                           ; SOURCE LINE # 1307
                                           ; SOURCE LINE # 1308
                                           ; SOURCE LINE # 1309
0000 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+03H
0003 740D              MOV     A,#0DH
0005 F0                MOVX    @DPTR,A
0006 7E00        E     MOV     R6,#HIGH BAT1PERCL
0008 A3                INC     DPTR
0009 7400        E     MOV     A,#HIGH BAT1PERCL
000B F0                MOVX    @DPTR,A
000C 7400        E     MOV     A,#LOW BAT1PERCL
000E 120000      R     LCALL   L?0582
0011 020000      E     LJMP    _bRWSMBus
             ; FUNCTION ChkBattery_Percl (END)

             ; FUNCTION FirstGetBatData (BEGIN)
                                           ; SOURCE LINE # 1315
                                           ; SOURCE LINE # 1316
                                           ; SOURCE LINE # 1320
0000 E4                CLR     A
0001 900000      E     MOV     DPTR,#Batpollstep1
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1321
0005 900000      E     MOV     DPTR,#nBatteryStatL
0008 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1322
0009 900000      R     MOV     DPTR,#i
000C F0                MOVX    @DPTR,A
000D         ?C0253:
                                           ; SOURCE LINE # 1323
                                           ; SOURCE LINE # 1324
000D 900000      E     MOV     DPTR,#Batpollstep1
0010 E0                MOVX    A,@DPTR
0011 FF                MOV     R7,A
0012 120000      R     LCALL   _GetBatData
                                           ; SOURCE LINE # 1325
0015 900000      E     MOV     DPTR,#Batpollstep1
0018 E0                MOVX    A,@DPTR
0019 04                INC     A
001A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1326
001B 900000      R     MOV     DPTR,#i
001E E0                MOVX    A,@DPTR
001F 04                INC     A
0020 F0                MOVX    @DPTR,A
0021 E0                MOVX    A,@DPTR
0022 C3                CLR     C
0023 941B              SUBB    A,#01BH
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 95  

0025 40E6              JC      ?C0253
0027         ?C0254:
                                           ; SOURCE LINE # 1327
0027 900000      E     MOV     DPTR,#Batpollstep1
002A 7408              MOV     A,#08H
002C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1328
002D 900000      E     MOV     DPTR,#Bat0x0FTempL
0030 E0                MOVX    A,@DPTR
0031 AD8A              MOV     R5,TL0
0033 2D                ADD     A,R5
0034 FF                MOV     R7,A
0035 EF                MOV     A,R7
0036 900000      E     MOV     DPTR,#SHA1_SEED
0039 F0                MOVX    @DPTR,A
003A A3                INC     DPTR
003B E4                CLR     A
003C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1347
003D 900000      E     MOV     DPTR,#batteryChemistry
0040 E0                MOVX    A,@DPTR
0041 B44C18            CJNE    A,#04CH,?C0256
0044 A3                INC     DPTR
0045 E0                MOVX    A,@DPTR
0046 B44913            CJNE    A,#049H,?C0256
0049 A3                INC     DPTR
004A E0                MOVX    A,@DPTR
004B B44F0E            CJNE    A,#04FH,?C0256
004E A3                INC     DPTR
004F E0                MOVX    A,@DPTR
0050 B44E09            CJNE    A,#04EH,?C0256
                                           ; SOURCE LINE # 1348
0053 900000      E     MOV     DPTR,#nBatteryStatL
0056 E0                MOVX    A,@DPTR
0057 4401              ORL     A,#01H
0059 F0                MOVX    @DPTR,A
005A 8007              SJMP    ?C0257
005C         ?C0256:
                                           ; SOURCE LINE # 1350
005C 900000      E     MOV     DPTR,#nBatteryStatL
005F E0                MOVX    A,@DPTR
0060 54FE              ANL     A,#0FEH
0062 F0                MOVX    @DPTR,A
0063         ?C0257:
                                           ; SOURCE LINE # 1353
0063 900000      E     MOV     DPTR,#nDesignCapH
0066 E0                MOVX    A,@DPTR
0067 FE                MOV     R6,A
0068 900000      E     MOV     DPTR,#nDesignCapL
006B 120000      R     LCALL   L?0544
006E 900000      E     MOV     DPTR,#OCPCapacity
0071 F0                MOVX    @DPTR,A
0072 A3                INC     DPTR
0073 EF                MOV     A,R7
0074 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1354
0075 900000      E     MOV     DPTR,#OCPCapacity
0078 E0                MOVX    A,@DPTR
0079 FE                MOV     R6,A
007A A3                INC     DPTR
007B E0                MOVX    A,@DPTR
007C 7803              MOV     R0,#03H
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 96  

007E         ?C0480:
007E C3                CLR     C
007F 33                RLC     A
0080 CE                XCH     A,R6
0081 33                RLC     A
0082 CE                XCH     A,R6
0083 D8F9              DJNZ    R0,?C0480
0085 F0                MOVX    @DPTR,A
0086 EE                MOV     A,R6
0087 900000      E     MOV     DPTR,#OCPCapacity
008A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1360
008B 120000      R     LCALL   L?0550
008E 120000      R     LCALL   L?0624
0091 C0E0              PUSH    ACC
0093 EE                MOV     A,R6
0094 C0E0              PUSH    ACC
0096 EF                MOV     A,R7
0097 C0E0              PUSH    ACC
0099 120000      R     LCALL   L?0599
009C 120000      R     LCALL   L?0544
009F 120000      R     LCALL   L?0579
00A2 D0E0              POP     ACC
00A4 FF                MOV     R7,A
00A5 D0E0              POP     ACC
00A7 FE                MOV     R6,A
00A8 D0E0              POP     ACC
00AA FC                MOV     R4,A
00AB 120000      E     LCALL   ?C?ULDIV
00AE 900000      E     MOV     DPTR,#OCPCapacity
00B1 EE                MOV     A,R6
00B2 F0                MOVX    @DPTR,A
00B3 A3                INC     DPTR
00B4 EF                MOV     A,R7
00B5 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1362
00B6 900000      E     MOV     DPTR,#nDesignCapH
00B9 E0                MOVX    A,@DPTR
00BA FE                MOV     R6,A
00BB 900000      E     MOV     DPTR,#nDesignCapL
00BE 120000      R     LCALL   L?0544
00C1 900000      E     MOV     DPTR,#OCPCapacityRelease
                                           ; SOURCE LINE # 1363
00C4 120000      R     LCALL   L?0605
00C7 7D07              MOV     R5,#07H
00C9 120000      E     LCALL   ?C?IMUL
00CC 900000      E     MOV     DPTR,#OCPCapacityRelease
00CF EE                MOV     A,R6
                                           ; SOURCE LINE # 1365
00D0 120000      R     LCALL   L?0605
00D3 E4                CLR     A
00D4 FD                MOV     R5,A
00D5 120000      R     LCALL   L?0624
00D8 C0E0              PUSH    ACC
00DA EE                MOV     A,R6
00DB C0E0              PUSH    ACC
00DD EF                MOV     A,R7
00DE C0E0              PUSH    ACC
00E0 120000      R     LCALL   L?0599
00E3 120000      R     LCALL   L?0544
00E6 120000      R     LCALL   L?0579
00E9 D0E0              POP     ACC
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 97  

00EB FF                MOV     R7,A
00EC D0E0              POP     ACC
00EE FE                MOV     R6,A
00EF D0E0              POP     ACC
00F1 FC                MOV     R4,A
00F2 120000      E     LCALL   ?C?ULDIV
00F5 900000      E     MOV     DPTR,#OCPCapacityRelease
00F8 EE                MOV     A,R6
00F9 F0                MOVX    @DPTR,A
00FA A3                INC     DPTR
00FB EF                MOV     A,R7
00FC F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1368
00FD 120000      R     LCALL   L?0600
0100 120000      R     LCALL   L?0544
0103 900000      R     MOV     DPTR,#DesignVoltage
0106 F0                MOVX    @DPTR,A
0107 A3                INC     DPTR
0108 EF                MOV     A,R7
0109 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1369
010A C3                CLR     C
010B 900000      R     MOV     DPTR,#DesignVoltage+01H
010E E0                MOVX    A,@DPTR
010F 94B0              SUBB    A,#0B0H
0111 900000      R     MOV     DPTR,#DesignVoltage
0114 E0                MOVX    A,@DPTR
0115 9436              SUBB    A,#036H
0117 400F              JC      ?C0258
0119 120000      R     LCALL   L?0635
011C 943B              SUBB    A,#03BH
011E 5008              JNC     ?C0258
                                           ; SOURCE LINE # 1370
0120 900000      E     MOV     DPTR,#CellCount
0123 7404              MOV     A,#04H
0125 F0                MOVX    @DPTR,A
0126 8040              SJMP    ?C0259
0128         ?C0258:
                                           ; SOURCE LINE # 1371
0128 C3                CLR     C
0129 900000      R     MOV     DPTR,#DesignVoltage+01H
012C E0                MOVX    A,@DPTR
012D 9428              SUBB    A,#028H
012F 900000      R     MOV     DPTR,#DesignVoltage
0132 E0                MOVX    A,@DPTR
0133 9423              SUBB    A,#023H
0135 4015              JC      ?C0260
0137 D3                SETB    C
0138 A3                INC     DPTR
0139 E0                MOVX    A,@DPTR
013A 9490              SUBB    A,#090H
013C 900000      R     MOV     DPTR,#DesignVoltage
013F E0                MOVX    A,@DPTR
0140 9433              SUBB    A,#033H
0142 5008              JNC     ?C0260
                                           ; SOURCE LINE # 1372
0144 900000      E     MOV     DPTR,#CellCount
0147 7403              MOV     A,#03H
0149 F0                MOVX    @DPTR,A
014A 801C              SJMP    ?C0259
014C         ?C0260:
                                           ; SOURCE LINE # 1373
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 98  

014C C3                CLR     C
014D 900000      R     MOV     DPTR,#DesignVoltage+01H
0150 E0                MOVX    A,@DPTR
0151 9470              SUBB    A,#070H
0153 900000      R     MOV     DPTR,#DesignVoltage
0156 E0                MOVX    A,@DPTR
0157 9417              SUBB    A,#017H
0159 400D              JC      ?C0259
015B 120000      R     LCALL   L?0635
015E 9422              SUBB    A,#022H
0160 5006              JNC     ?C0259
                                           ; SOURCE LINE # 1374
0162 900000      E     MOV     DPTR,#CellCount
0165 7402              MOV     A,#02H
0167 F0                MOVX    @DPTR,A
0168         ?C0259:
                                           ; SOURCE LINE # 1377
0168 900000      E     MOV     DPTR,#S3ResumeRSOC
016B 7405              MOV     A,#05H
016D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1378
016E 900000      E     MOV     DPTR,#BatteryOTP
0171 743C              MOV     A,#03CH
0173 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1379
0174 900000      E     MOV     DPTR,#BatteryOTPRelease
0177 743A              MOV     A,#03AH
0179 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1380
017A 900000      E     MOV     DPTR,#BatteryOTPShutdown
017D 7441              MOV     A,#041H
017F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1383
0180 120000      R     LCALL   UpdateNameSpace
                                           ; SOURCE LINE # 1384
0183 120000      R     LCALL   Chk_Battery_Full
                                           ; SOURCE LINE # 1385
0186 E4                CLR     A
0187 900000      E     MOV     DPTR,#nBattErrorCnt
018A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1386
018B AF8A              MOV     R7,TL0
018D 900000      E     MOV     DPTR,#SHA1_SEED
0190 8FF0              MOV     B,R7
0192 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 1387
0195 900000      E     MOV     DPTR,#SHA1_SEED
0198 E0                MOVX    A,@DPTR
0199 FE                MOV     R6,A
019A A3                INC     DPTR
019B E0                MOVX    A,@DPTR
019C FF                MOV     R7,A
019D 120000      E     LCALL   _srand
                                           ; SOURCE LINE # 1389
01A0 900000      E     MOV     DPTR,#BatSMbusFailCount
01A3 E0                MOVX    A,@DPTR
01A4 704D              JNZ     ?C0266
                                           ; SOURCE LINE # 1390
                                           ; SOURCE LINE # 1391
01A6 900000      E     MOV     DPTR,#Battdata_ready
01A9 04                INC     A
01AA F0                MOVX    @DPTR,A
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 99  

                                           ; SOURCE LINE # 1392
01AB 900000      E     MOV     DPTR,#EC_C_modeH
01AE E0                MOVX    A,@DPTR
01AF 900000      E     MOV     DPTR,#WSMbusTemp01
01B2 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1393
01B3 E0                MOVX    A,@DPTR
01B4 64E0              XRL     A,#0E0H
01B6 54E0              ANL     A,#0E0H
01B8 6039              JZ      ?C0266
                                           ; SOURCE LINE # 1394
                                           ; SOURCE LINE # 1395
01BA 900000      E     MOV     DPTR,#EC_C_modeL
01BD E0                MOVX    A,@DPTR
01BE 900000      E     MOV     DPTR,#WSMbusTemp01
01C1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1396
01C2 900000      E     MOV     DPTR,#EC_C_modeH
01C5 E0                MOVX    A,@DPTR
01C6 900000      E     MOV     DPTR,#WSMbusTemp02
01C9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1397
01CA E0                MOVX    A,@DPTR
01CB 44E0              ORL     A,#0E0H
01CD F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1398
01CE 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+03H
01D1 7403              MOV     A,#03H
01D3 F0                MOVX    @DPTR,A
01D4 7E00        E     MOV     R6,#HIGH WSMbusTemp01
01D6 A3                INC     DPTR
01D7 7400        E     MOV     A,#HIGH WSMbusTemp01
01D9 F0                MOVX    @DPTR,A
01DA A3                INC     DPTR
01DB 7400        E     MOV     A,#LOW WSMbusTemp01
01DD F0                MOVX    @DPTR,A
01DE E4                CLR     A
01DF A3                INC     DPTR
01E0 F0                MOVX    @DPTR,A
01E1 7B16              MOV     R3,#016H
01E3 7D8C              MOV     R5,#08CH
01E5 7F01              MOV     R7,#01H
01E7 120000      E     LCALL   _bRWSMBus
01EA EF                MOV     A,R7
01EB 7006              JNZ     ?C0266
                                           ; SOURCE LINE # 1399
                                           ; SOURCE LINE # 1400
01ED 900000      E     MOV     DPTR,#BatSMbusFailCount
01F0 E0                MOVX    A,@DPTR
01F1 04                INC     A
01F2 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1401
                                           ; SOURCE LINE # 1402
                                           ; SOURCE LINE # 1403
                                           ; SOURCE LINE # 1404
01F3         ?C0266:
01F3 22                RET     
             ; FUNCTION FirstGetBatData (END)

             ; FUNCTION Chk_Battery_Full (BEGIN)
                                           ; SOURCE LINE # 1406
                                           ; SOURCE LINE # 1407
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 100 

                                           ; SOURCE LINE # 1408
0000 900000      E     MOV     DPTR,#SYS_STATUS
0003 E0                MOVX    A,@DPTR
0004 30E70B            JNB     ACC.7,?C0268
0007 E0                MOVX    A,@DPTR
0008 30E70C            JNB     ACC.7,?C0267
000B 900000      E     MOV     DPTR,#ACOFF_SOURCE
000E E0                MOVX    A,@DPTR
000F 30E205            JNB     ACC.2,?C0267
0012         ?C0268:
                                           ; SOURCE LINE # 1409
                                           ; SOURCE LINE # 1410
0012 900000      E     MOV     DPTR,#SEL_STATE0
                                           ; SOURCE LINE # 1411
                                           ; SOURCE LINE # 1412
0015 8038              SJMP    ?C0518
                                           ; SOURCE LINE # 1414
0017         ?C0267:
                                           ; SOURCE LINE # 1417
0017 120000      R     LCALL   L?0625
001A 20E019            JB      ACC.0,?C0519
001D 900000      E     MOV     DPTR,#EC_BatteryStatusL
0020 E0                MOVX    A,@DPTR
0021 20E512            JB      ACC.5,?C0519
0024 120000      R     LCALL   L?0626
0027 6002              JZ      ?C0270
0029         ?C0271:
                                           ; SOURCE LINE # 1418
                                           ; SOURCE LINE # 1419
                                           ; SOURCE LINE # 1420
                                           ; SOURCE LINE # 1421
0029 800B              SJMP    ?C0519
                                           ; SOURCE LINE # 1423
002B         ?C0270:
                                           ; SOURCE LINE # 1425
                                           ; SOURCE LINE # 1426
002B 120000      R     LCALL   L?0591
002E 30E00D            JNB     ACC.0,?C0272
0031 120000      R     LCALL   L?0571
0034 7008              JNZ     ?C0272
                                           ; SOURCE LINE # 1427
                                           ; SOURCE LINE # 1428
0036         ?C0519:
0036 900000      E     MOV     DPTR,#SEL_STATE0
                                           ; SOURCE LINE # 1429
0039 120000      R     LCALL   L?0573
                                           ; SOURCE LINE # 1430
003C 8031              SJMP    ?C0521
                                           ; SOURCE LINE # 1432
                                           ; SOURCE LINE # 1433
003E         ?C0272:
                                           ; SOURCE LINE # 1435
003E 900000      E     MOV     DPTR,#LENOVOPMFW
0041 E0                MOVX    A,@DPTR
0042 20E418            JB      ACC.4,?C0274
                                           ; SOURCE LINE # 1436
                                           ; SOURCE LINE # 1437
0045 900000      E     MOV     DPTR,#nBattery0x16L
0048 E0                MOVX    A,@DPTR
0049 900000      E     MOV     DPTR,#SEL_STATE0
004C 30E509            JNB     ACC.5,?C0275
                                           ; SOURCE LINE # 1438
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 101 

                                           ; SOURCE LINE # 1439
004F         ?C0518:
                                           ; SOURCE LINE # 1440
004F 120000      R     LCALL   L?0573
0052 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1441
0053 E0                MOVX    A,@DPTR
0054 4401              ORL     A,#01H
0056 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1442
0057 22                RET     
0058         ?C0275:
                                           ; SOURCE LINE # 1444
                                           ; SOURCE LINE # 1445
                                           ; SOURCE LINE # 1446
0058 120000      R     LCALL   L?0627
005B         ?C0520:
                                           ; SOURCE LINE # 1447
                                           ; SOURCE LINE # 1448
                                           ; SOURCE LINE # 1449
005B 8012              SJMP    ?C0521
005D         ?C0274:
                                           ; SOURCE LINE # 1451
                                           ; SOURCE LINE # 1452
005D 900000      E     MOV     DPTR,#EC_BatteryStatusL
0060 E0                MOVX    A,@DPTR
0061 900000      E     MOV     DPTR,#SEL_STATE0
0064 30E505            JNB     ACC.5,?C0278
                                           ; SOURCE LINE # 1453
                                           ; SOURCE LINE # 1454
                                           ; SOURCE LINE # 1455
0067 120000      R     LCALL   L?0574
006A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1456
006B 22                RET     
006C         ?C0278:
                                           ; SOURCE LINE # 1458
                                           ; SOURCE LINE # 1459
                                           ; SOURCE LINE # 1460
006C 120000      R     LCALL   L?0627
006F         ?C0521:
006F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1461
0070 E0                MOVX    A,@DPTR
0071 54FE              ANL     A,#0FEH
0073 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1462
                                           ; SOURCE LINE # 1463
                                           ; SOURCE LINE # 1464
0074         ?C0269:
0074 22                RET     
             ; FUNCTION Chk_Battery_Full (END)

             ; FUNCTION Unlock_ShipMode (BEGIN)
                                           ; SOURCE LINE # 1466
                                           ; SOURCE LINE # 1467
                                           ; SOURCE LINE # 1487
0000 900000      E     MOV     DPTR,#BATTUPDATEFW
0003 E0                MOVX    A,@DPTR
0004 20E064            JB      ACC.0,?C0281
0007         ?C0280:
                                           ; SOURCE LINE # 1489
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 102 

0007 E4                CLR     A
0008 900000      E     MOV     DPTR,#ShipModeEn
000B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1490
000C 900000      E     MOV     DPTR,#EMStatusBit2
000F E0                MOVX    A,@DPTR
0010 54FE              ANL     A,#0FEH
0012 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1491
0013 E4                CLR     A
0014 900000      E     MOV     DPTR,#WSMbusTemp01
0017 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1492
0018 7420              MOV     A,#020H
                                           ; SOURCE LINE # 1494
001A 120000      R     LCALL   L?0537
001D 120000      E     LCALL   _bRWSMBus
0020 EF                MOV     A,R7
0021 7003              JNZ     ?C0282
                                           ; SOURCE LINE # 1495
                                           ; SOURCE LINE # 1496
0023 120000      R     LCALL   L?0584
                                           ; SOURCE LINE # 1497
0026         ?C0282:
                                           ; SOURCE LINE # 1499
0026 E4                CLR     A
0027 900000      E     MOV     DPTR,#WSMbusTemp01
002A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1500
002B 900000      E     MOV     DPTR,#WSMbusTemp02
002E 7440              MOV     A,#040H
                                           ; SOURCE LINE # 1502
0030 120000      R     LCALL   L?0538
0033 120000      E     LCALL   _bRWSMBus
0036 EF                MOV     A,R7
0037 7003              JNZ     ?C0283
                                           ; SOURCE LINE # 1503
                                           ; SOURCE LINE # 1504
0039 120000      R     LCALL   L?0586
                                           ; SOURCE LINE # 1505
003C         ?C0283:
                                           ; SOURCE LINE # 1507
003C 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+03H
003F 7434              MOV     A,#034H
0041 F0                MOVX    @DPTR,A
0042 7E00        E     MOV     R6,#HIGH ShipModeACK
0044 A3                INC     DPTR
0045 7400        E     MOV     A,#HIGH ShipModeACK
0047 F0                MOVX    @DPTR,A
0048 7400        E     MOV     A,#LOW ShipModeACK
004A 120000      R     LCALL   L?0582
004D 120000      E     LCALL   _bRWSMBus
0050 EF                MOV     A,R7
0051 600C              JZ      ?C0284
                                           ; SOURCE LINE # 1508
                                           ; SOURCE LINE # 1509
0053 900000      E     MOV     DPTR,#ShipModeACK
0056 E0                MOVX    A,@DPTR
0057 7002              JNZ     ?C0481
0059 A3                INC     DPTR
005A E0                MOVX    A,@DPTR
005B         ?C0481:
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 103 

005B 600E              JZ      ?C0281
                                           ; SOURCE LINE # 1510
                                           ; SOURCE LINE # 1511
                                           ; SOURCE LINE # 1512
                                           ; SOURCE LINE # 1513
005D 8006              SJMP    ?C0522
005F         ?C0284:
                                           ; SOURCE LINE # 1515
                                           ; SOURCE LINE # 1516
005F 900000      E     MOV     DPTR,#SMbusFailCnt4
0062 E0                MOVX    A,@DPTR
0063 04                INC     A
0064 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1517
0065         ?C0522:
0065 900000      E     MOV     DPTR,#ShipModeCnt
0068 7401              MOV     A,#01H
006A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1518
                                           ; SOURCE LINE # 1520
006B         ?C0281:
006B 22                RET     
             ; FUNCTION Unlock_ShipMode (END)

             ; FUNCTION Lock_ShipMode (BEGIN)
                                           ; SOURCE LINE # 1522
                                           ; SOURCE LINE # 1523
                                           ; SOURCE LINE # 1546
0000 E4                CLR     A
0001 900000      R     MOV     DPTR,#retryNum
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1547
0005 900000      E     MOV     DPTR,#SMbusFailCnt3
0008 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1548
0009 900000      E     MOV     DPTR,#SMbusFailCnt2
000C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1550
000D 900000      E     MOV     DPTR,#WSMbusTemp01
0010 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1551
                                           ; SOURCE LINE # 1552
0011 120000      R     LCALL   L?0537
0014 120000      E     LCALL   _bRWSMBus
0017 EF                MOV     A,R7
0018 7003              JNZ     ?C0287
                                           ; SOURCE LINE # 1553
                                           ; SOURCE LINE # 1554
001A 120000      R     LCALL   L?0584
                                           ; SOURCE LINE # 1555
001D         ?C0287:
                                           ; SOURCE LINE # 1557
001D 7FFA              MOV     R7,#0FAH
001F 120000      E     LCALL   _Delay1MS
                                           ; SOURCE LINE # 1559
                                           ; SOURCE LINE # 1560
                                           ; SOURCE LINE # 1561
0022 120000      R     LCALL   L?0536
0025 120000      E     LCALL   _bRWSMBus
0028 EF                MOV     A,R7
0029 7003              JNZ     ?C0288
                                           ; SOURCE LINE # 1562
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 104 

                                           ; SOURCE LINE # 1563
002B 120000      R     LCALL   L?0586
                                           ; SOURCE LINE # 1564
002E         ?C0288:
                                           ; SOURCE LINE # 1566
002E E4                CLR     A
002F 900000      R     MOV     DPTR,#retryNum
0032 F0                MOVX    @DPTR,A
0033         ?C0289:
                                           ; SOURCE LINE # 1567
                                           ; SOURCE LINE # 1568
0033 900000      E     MOV     DPTR,#SMbusFailCnt3
0036 E0                MOVX    A,@DPTR
0037 7006              JNZ     ?C0292
0039 900000      E     MOV     DPTR,#SMbusFailCnt2
003C E0                MOVX    A,@DPTR
003D 6046              JZ      ?C0295
                                           ; SOURCE LINE # 1569
003F         ?C0292:
                                           ; SOURCE LINE # 1571
003F 7FA5              MOV     R7,#0A5H
0041 120000      E     LCALL   _ProcessSID
                                           ; SOURCE LINE # 1572
0044 E4                CLR     A
0045 900000      E     MOV     DPTR,#SMbusFailCnt3
0048 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1573
0049 900000      E     MOV     DPTR,#SMbusFailCnt2
004C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1575
004D 7F0A              MOV     R7,#0AH
004F 120000      E     LCALL   _Delay1MS
                                           ; SOURCE LINE # 1576
0052 7FFA              MOV     R7,#0FAH
0054 120000      E     LCALL   _Delay1MS
                                           ; SOURCE LINE # 1578
0057 E4                CLR     A
0058 900000      E     MOV     DPTR,#WSMbusTemp01
005B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1579
                                           ; SOURCE LINE # 1580
005C 120000      R     LCALL   L?0537
005F 120000      E     LCALL   _bRWSMBus
0062 EF                MOV     A,R7
0063 7003              JNZ     ?C0293
                                           ; SOURCE LINE # 1581
                                           ; SOURCE LINE # 1582
0065 120000      R     LCALL   L?0585
                                           ; SOURCE LINE # 1583
0068         ?C0293:
                                           ; SOURCE LINE # 1585
0068 7FFA              MOV     R7,#0FAH
006A 120000      E     LCALL   _Delay1MS
                                           ; SOURCE LINE # 1587
                                           ; SOURCE LINE # 1588
                                           ; SOURCE LINE # 1589
006D 120000      R     LCALL   L?0536
0070 120000      E     LCALL   _bRWSMBus
0073 EF                MOV     A,R7
0074 7003              JNZ     ?C0291
                                           ; SOURCE LINE # 1590
                                           ; SOURCE LINE # 1591
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 105 

0076 120000      R     LCALL   L?0587
                                           ; SOURCE LINE # 1592
                                           ; SOURCE LINE # 1593
0079         ?C0291:
0079 900000      R     MOV     DPTR,#retryNum
007C E0                MOVX    A,@DPTR
007D 04                INC     A
007E F0                MOVX    @DPTR,A
007F E0                MOVX    A,@DPTR
0080 C3                CLR     C
0081 9406              SUBB    A,#06H
0083 40AE              JC      ?C0289
                                           ; SOURCE LINE # 1596
0085         ?C0295:
0085 22                RET     
             ; FUNCTION Lock_ShipMode (END)

             ; FUNCTION OEM_PollingBatData_TASK (BEGIN)
                                           ; SOURCE LINE # 1603
                                           ; SOURCE LINE # 1604
                                           ; SOURCE LINE # 1608
0000 900000      E     MOV     DPTR,#BATTUPDATEFW
0003 E0                MOVX    A,@DPTR
0004 30E003            JNB     ACC.0,$ + 6H
0007 020000      R     LJMP    ?C0328
                                           ; SOURCE LINE # 1609
                                           ; SOURCE LINE # 1610
000A 900000      E     MOV     DPTR,#Batpollstep1
000D E0                MOVX    A,@DPTR
000E FF                MOV     R7,A
000F 120000      R     LCALL   _GetBatData
                                           ; SOURCE LINE # 1612
0012 900000      E     MOV     DPTR,#Batpollstep1
0015 E0                MOVX    A,@DPTR
0016 04                INC     A
0017 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1614
0018 E0                MOVX    A,@DPTR
0019 C3                CLR     C
001A 941B              SUBB    A,#01BH
001C 5003              JNC     $ + 5H
001E 020000      R     LJMP    ?C0297
                                           ; SOURCE LINE # 1615
                                           ; SOURCE LINE # 1622
0021 900000      E     MOV     DPTR,#Get_Batt_debounce_count
0024 E0                MOVX    A,@DPTR
0025 9403              SUBB    A,#03H
0027 4003              JC      $ + 5H
0029 020000      R     LJMP    ?C0298
                                           ; SOURCE LINE # 1623
                                           ; SOURCE LINE # 1624
002C 900000      E     MOV     DPTR,#Get_Batt_debounce_hash1
002F E0                MOVX    A,@DPTR
0030 900000      E     MOV     DPTR,#Get_Batt_debounce_hash2
0033 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1625
0034 E4                CLR     A
0035 900000      E     MOV     DPTR,#Get_Batt_debounce_hash1
0038 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1626
0039 900000      R     MOV     DPTR,#i
003C F0                MOVX    @DPTR,A
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 106 

003D         ?C0299:
                                           ; SOURCE LINE # 1627
                                           ; SOURCE LINE # 1628
003D 120000      R     LCALL   L?0568
0040 701E              JNZ     ?C0302
                                           ; SOURCE LINE # 1629
0042 900000      E     MOV     DPTR,#Get_Batt_debounce_hash1
0045 E0                MOVX    A,@DPTR
0046 FF                MOV     R7,A
0047 900000      R     MOV     DPTR,#i
004A E0                MOVX    A,@DPTR
004B 120000      R     LCALL   L?0548
004E FC                MOV     R4,A
004F 7401              MOV     A,#01H
0051 93                MOVC    A,@A+DPTR
0052 F582              MOV     DPL,A
0054 8C83              MOV     DPH,R4
0056 E0                MOVX    A,@DPTR
0057 FE                MOV     R6,A
0058 EF                MOV     A,R7
0059 6E                XRL     A,R6
005A 900000      E     MOV     DPTR,#Get_Batt_debounce_hash1
005D F0                MOVX    @DPTR,A
005E 803E              SJMP    ?C0301
0060         ?C0302:
                                           ; SOURCE LINE # 1631
                                           ; SOURCE LINE # 1632
0060 900000      R     MOV     DPTR,#i
0063 E0                MOVX    A,@DPTR
0064 120000      R     LCALL   L?0548
0067 FE                MOV     R6,A
0068 7401              MOV     A,#01H
006A 93                MOVC    A,@A+DPTR
;---- Variable 'ptr' assigned to Register 'R4/R5' ----
006B FD                MOV     R5,A
006C CC                XCH     A,R4
006D EE                MOV     A,R6
006E CC                XCH     A,R4
                                           ; SOURCE LINE # 1633
006F E4                CLR     A
0070 900000      R     MOV     DPTR,#j
0073 F0                MOVX    @DPTR,A
0074         ?C0304:
0074 120000      R     LCALL   L?0568
0077 FF                MOV     R7,A
0078 900000      R     MOV     DPTR,#j
007B E0                MOVX    A,@DPTR
007C C3                CLR     C
007D 9F                SUBB    A,R7
007E 501E              JNC     ?C0301
                                           ; SOURCE LINE # 1634
                                           ; SOURCE LINE # 1635
0080 900000      E     MOV     DPTR,#Get_Batt_debounce_hash1
0083 E0                MOVX    A,@DPTR
0084 FF                MOV     R7,A
0085 8D82              MOV     DPL,R5
0087 8C83              MOV     DPH,R4
0089 E0                MOVX    A,@DPTR
008A FE                MOV     R6,A
008B EF                MOV     A,R7
008C 6E                XRL     A,R6
008D 900000      E     MOV     DPTR,#Get_Batt_debounce_hash1
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 107 

0090 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1636
0091 0D                INC     R5
0092 BD0001            CJNE    R5,#00H,?C0482
0095 0C                INC     R4
0096         ?C0482:
                                           ; SOURCE LINE # 1637
0096 900000      R     MOV     DPTR,#j
0099 E0                MOVX    A,@DPTR
009A 04                INC     A
009B F0                MOVX    @DPTR,A
009C 80D6              SJMP    ?C0304
                                           ; SOURCE LINE # 1638
                                           ; SOURCE LINE # 1639
009E         ?C0301:
009E 900000      R     MOV     DPTR,#i
00A1 E0                MOVX    A,@DPTR
00A2 04                INC     A
00A3 F0                MOVX    @DPTR,A
00A4 E0                MOVX    A,@DPTR
00A5 6409              XRL     A,#09H
00A7 7094              JNZ     ?C0299
00A9         ?C0300:
                                           ; SOURCE LINE # 1641
00A9 900000      E     MOV     DPTR,#Get_Batt_debounce_hash1
00AC E0                MOVX    A,@DPTR
00AD FF                MOV     R7,A
00AE 900000      E     MOV     DPTR,#Get_Batt_debounce_hash2
00B1 E0                MOVX    A,@DPTR
00B2 6F                XRL     A,R7
00B3 7008              JNZ     ?C0307
                                           ; SOURCE LINE # 1642
00B5 900000      E     MOV     DPTR,#Get_Batt_debounce_count
00B8 E0                MOVX    A,@DPTR
00B9 04                INC     A
00BA F0                MOVX    @DPTR,A
00BB 8005              SJMP    ?C0308
00BD         ?C0307:
                                           ; SOURCE LINE # 1644
00BD E4                CLR     A
00BE 900000      E     MOV     DPTR,#Get_Batt_debounce_count
00C1 F0                MOVX    @DPTR,A
00C2         ?C0308:
                                           ; SOURCE LINE # 1646
00C2 E4                CLR     A
00C3 900000      E     MOV     DPTR,#Batpollstep1
00C6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1648
00C7 900000      E     MOV     DPTR,#Get_Batt_debounce_count
00CA E0                MOVX    A,@DPTR
00CB C3                CLR     C
00CC 9403              SUBB    A,#03H
00CE 5003              JNC     $ + 5H
00D0 020000      R     LJMP    ?C0297
                                           ; SOURCE LINE # 1649
                                           ; SOURCE LINE # 1650
00D3 900000      E     MOV     DPTR,#BATTMANUFACTURE
00D6 E0                MOVX    A,@DPTR
00D7 B45314            CJNE    A,#053H,?C0310
00DA A3                INC     DPTR
00DB E0                MOVX    A,@DPTR
00DC 6441              XRL     A,#041H
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 108 

00DE 6004              JZ      ?C0311
00E0 E0                MOVX    A,@DPTR
00E1 B4610A            CJNE    A,#061H,?C0310
00E4         ?C0311:
                                           ; SOURCE LINE # 1651
00E4 900000      E     MOV     DPTR,#nBatteryStatL
00E7 E0                MOVX    A,@DPTR
00E8 4410              ORL     A,#010H
00EA F0                MOVX    @DPTR,A
00EB 020000      R     LJMP    ?C0297
00EE         ?C0310:
                                           ; SOURCE LINE # 1652
00EE 900000      E     MOV     DPTR,#BATTMANUFACTURE
00F1 E0                MOVX    A,@DPTR
00F2 B4530E            CJNE    A,#053H,?C0313
00F5 A3                INC     DPTR
00F6 E0                MOVX    A,@DPTR
00F7 B44F09            CJNE    A,#04FH,?C0313
                                           ; SOURCE LINE # 1653
00FA 900000      E     MOV     DPTR,#nBatteryStatL
00FD E0                MOVX    A,@DPTR
00FE 4420              ORL     A,#020H
0100 F0                MOVX    @DPTR,A
0101 8079              SJMP    ?C0297
0103         ?C0313:
                                           ; SOURCE LINE # 1654
0103 900000      E     MOV     DPTR,#BATTMANUFACTURE
0106 E0                MOVX    A,@DPTR
0107 B45013            CJNE    A,#050H,?C0315
010A A3                INC     DPTR
010B E0                MOVX    A,@DPTR
010C 6441              XRL     A,#041H
010E 6004              JZ      ?C0316
0110 E0                MOVX    A,@DPTR
0111 B46109            CJNE    A,#061H,?C0315
0114         ?C0316:
                                           ; SOURCE LINE # 1655
0114 900000      E     MOV     DPTR,#nBatteryStatL
0117 E0                MOVX    A,@DPTR
0118 4440              ORL     A,#040H
011A F0                MOVX    @DPTR,A
011B 805F              SJMP    ?C0297
011D         ?C0315:
                                           ; SOURCE LINE # 1656
011D 900000      E     MOV     DPTR,#BATTMANUFACTURE
0120 E0                MOVX    A,@DPTR
0121 B4530E            CJNE    A,#053H,?C0318
0124 A3                INC     DPTR
0125 E0                MOVX    A,@DPTR
0126 B45509            CJNE    A,#055H,?C0318
                                           ; SOURCE LINE # 1657
0129 900000      E     MOV     DPTR,#nBatteryStatL
012C E0                MOVX    A,@DPTR
012D 4450              ORL     A,#050H
012F F0                MOVX    @DPTR,A
0130 804A              SJMP    ?C0297
0132         ?C0318:
                                           ; SOURCE LINE # 1658
0132 900000      E     MOV     DPTR,#BATTMANUFACTURE
0135 E0                MOVX    A,@DPTR
0136 B44C0E            CJNE    A,#04CH,?C0320
0139 A3                INC     DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 109 

013A E0                MOVX    A,@DPTR
013B B44709            CJNE    A,#047H,?C0320
                                           ; SOURCE LINE # 1659
013E 900000      E     MOV     DPTR,#nBatteryStatL
0141 E0                MOVX    A,@DPTR
0142 4430              ORL     A,#030H
0144 F0                MOVX    @DPTR,A
0145 8035              SJMP    ?C0297
0147         ?C0320:
                                           ; SOURCE LINE # 1660
0147 900000      E     MOV     DPTR,#BATTMANUFACTURE
014A E0                MOVX    A,@DPTR
014B B44313            CJNE    A,#043H,?C0322
014E A3                INC     DPTR
014F E0                MOVX    A,@DPTR
0150 6450              XRL     A,#050H
0152 6004              JZ      ?C0323
0154 E0                MOVX    A,@DPTR
0155 B47009            CJNE    A,#070H,?C0322
0158         ?C0323:
                                           ; SOURCE LINE # 1661
0158 900000      E     MOV     DPTR,#nBatteryStatL
015B E0                MOVX    A,@DPTR
015C 4460              ORL     A,#060H
015E F0                MOVX    @DPTR,A
015F 801B              SJMP    ?C0297
0161         ?C0322:
                                           ; SOURCE LINE # 1662
0161 900000      E     MOV     DPTR,#BATTMANUFACTURE
0164 E0                MOVX    A,@DPTR
0165 B45314            CJNE    A,#053H,?C0297
0168 A3                INC     DPTR
0169 E0                MOVX    A,@DPTR
016A B44D0F            CJNE    A,#04DH,?C0297
                                           ; SOURCE LINE # 1663
016D 900000      E     MOV     DPTR,#nBatteryStatL
0170 E0                MOVX    A,@DPTR
0171 4470              ORL     A,#070H
0173 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1664
                                           ; SOURCE LINE # 1665
0174 8006              SJMP    ?C0297
0176         ?C0298:
                                           ; SOURCE LINE # 1667
                                           ; SOURCE LINE # 1668
0176 900000      E     MOV     DPTR,#Batpollstep1
0179 7409              MOV     A,#09H
017B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1669
                                           ; SOURCE LINE # 1670
017C         ?C0297:
                                           ; SOURCE LINE # 1671
017C 120000      R     LCALL   UpdateNameSpace
                                           ; SOURCE LINE # 1672
017F 120000      R     LCALL   ChkLENOVOPMFW
                                           ; SOURCE LINE # 1673
0182 120000      R     LCALL   ChkGoTarget
                                           ; SOURCE LINE # 1674
0185 120000      R     LCALL   Chk_Battery_Full
                                           ; SOURCE LINE # 1675
0188 900000      E     MOV     DPTR,#GPUProchotONCnt
018B E0                MOVX    A,@DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 110 

018C 7009              JNZ     ?C0327
                                           ; SOURCE LINE # 1676
                                           ; SOURCE LINE # 1677
018E 120000      R     LCALL   ChkBattery_OTP
                                           ; SOURCE LINE # 1679
0191 120000      R     LCALL   ChkBattery_OCP
                                           ; SOURCE LINE # 1681
0194 120000      R     LCALL   CkkBattery_RSOCLow
                                           ; SOURCE LINE # 1682
0197         ?C0327:
                                           ; SOURCE LINE # 1683
0197 120000      R     LCALL   ChkBattery_LowVoltage
                                           ; SOURCE LINE # 1684
019A 120000      R     LCALL   ChkBattery_FCCchg
                                           ; SOURCE LINE # 1685
019D 120000      R     LCALL   ChkAvgCurrent
                                           ; SOURCE LINE # 1686
01A0 120000      R     LCALL   ChkS3DCRSOC
                                           ; SOURCE LINE # 1687
01A3 120000      R     LCALL   ChkS3ResumeRSOC
                                           ; SOURCE LINE # 1688
01A6 120000      R     LCALL   RSOC1Pto0P_ShutdownCheck
                                           ; SOURCE LINE # 1689
                                           ; SOURCE LINE # 1690
01A9         ?C0328:
01A9 22                RET     
             ; FUNCTION OEM_PollingBatData_TASK (END)

             ; FUNCTION WriteSmartChgIC (BEGIN)
                                           ; SOURCE LINE # 1696
                                           ; SOURCE LINE # 1697
                                           ; SOURCE LINE # 1701
0000 900000      E     MOV     DPTR,#GPDRB
0003 E0                MOVX    A,@DPTR
0004 30E003            JNB     ACC.0,?C0330
0007 D3                SETB    C
0008 8001              SJMP    ?C0331
000A         ?C0330:
000A C3                CLR     C
000B         ?C0331:
000B 4003              JC      $ + 5H
000D 020000      R     LJMP    ?C0332
                                           ; SOURCE LINE # 1702
                                           ; SOURCE LINE # 1704
0010         ?C0329:
                                           ; SOURCE LINE # 1705
0010 900000      E     MOV     DPTR,#CHGIC_ptr
0013 E0                MOVX    A,@DPTR
0014 C3                CLR     C
0015 9404              SUBB    A,#04H
0017 4004              JC      ?C0333
                                           ; SOURCE LINE # 1706
                                           ; SOURCE LINE # 1707
0019 E4                CLR     A
001A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1708
001B 8006              SJMP    ?C0334
001D         ?C0333:
                                           ; SOURCE LINE # 1710
                                           ; SOURCE LINE # 1711
001D 900000      E     MOV     DPTR,#CHGIC_ptr
0020 E0                MOVX    A,@DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 111 

0021 04                INC     A
0022 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1712
0023         ?C0334:
                                           ; SOURCE LINE # 1713
0023 900000      E     MOV     DPTR,#CHGIC_ptr
0026 E0                MOVX    A,@DPTR
0027 14                DEC     A
0028 601F              JZ      ?C0337
002A 14                DEC     A
002B 6028              JZ      ?C0338
002D 14                DEC     A
002E 6059              JZ      ?C0343
0030 14                DEC     A
0031 7003              JNZ     $ + 5H
0033 020000      R     LJMP    ?C0353
0036 2404              ADD     A,#04H
0038 6003              JZ      $ + 5H
003A 020000      R     LJMP    ?C0332
                                           ; SOURCE LINE # 1714
                                           ; SOURCE LINE # 1715
003D         ?C0336:
                                           ; SOURCE LINE # 1716
003D 7414              MOV     A,#014H
                                           ; SOURCE LINE # 1717
003F 120000      R     LCALL   L?0588
0042 7A00        E     MOV     R2,#HIGH nBattCharCurrentL
0044 7900        E     MOV     R1,#LOW nBattCharCurrentL
                                           ; SOURCE LINE # 1718
0046 020000      R     LJMP    ?C0529
                                           ; SOURCE LINE # 1719
0049         ?C0337:
                                           ; SOURCE LINE # 1720
0049 7415              MOV     A,#015H
                                           ; SOURCE LINE # 1721
004B 120000      R     LCALL   L?0588
004E 7A00        E     MOV     R2,#HIGH nChargingVoltL
0050 7900        E     MOV     R1,#LOW nChargingVoltL
0052         ?C0524:
                                           ; SOURCE LINE # 1722
0052 020000      R     LJMP    ?C0529
                                           ; SOURCE LINE # 1723
0055         ?C0338:
                                           ; SOURCE LINE # 1724
0055 900000      E     MOV     DPTR,#SEL_STATE0
0058 E0                MOVX    A,@DPTR
0059 20E006            JB      ACC.0,?C0339
                                           ; SOURCE LINE # 1725
                                           ; SOURCE LINE # 1726
005C E4                CLR     A
005D 900000      E     MOV     DPTR,#CHGIC_InputCurrentL
                                           ; SOURCE LINE # 1727
                                           ; SOURCE LINE # 1728
0060 8014              SJMP    ?C0526
0062         ?C0339:
                                           ; SOURCE LINE # 1730
                                           ; SOURCE LINE # 1731
0062 900000      E     MOV     DPTR,#nBattGasgauge
0065 E0                MOVX    A,@DPTR
0066 C3                CLR     C
0067 940A              SUBB    A,#0AH
0069 4007              JC      ?C0341
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 112 

                                           ; SOURCE LINE # 1732
                                           ; SOURCE LINE # 1733
006B 900000      E     MOV     DPTR,#CHGIC_InputCurrentL
006E 7480              MOV     A,#080H
                                           ; SOURCE LINE # 1734
                                           ; SOURCE LINE # 1735
0070 8004              SJMP    ?C0523
0072         ?C0341:
                                           ; SOURCE LINE # 1737
                                           ; SOURCE LINE # 1738
0072 E4                CLR     A
0073 900000      E     MOV     DPTR,#CHGIC_InputCurrentL
0076         ?C0523:
0076         ?C0526:
0076 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1739
0077 900000      E     MOV     DPTR,#CHGIC_InputCurrentH
007A 740B              MOV     A,#0BH
007C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1740
                                           ; SOURCE LINE # 1741
007D         ?C0340:
                                           ; SOURCE LINE # 1742
007D 743F              MOV     A,#03FH
                                           ; SOURCE LINE # 1743
007F 120000      R     LCALL   L?0636
0082 7A00        E     MOV     R2,#HIGH CHGIC_InputCurrentL
0084 7900        E     MOV     R1,#LOW CHGIC_InputCurrentL
0086         ?C0525:
                                           ; SOURCE LINE # 1744
0086 020000      R     LJMP    ?C0529
                                           ; SOURCE LINE # 1745
0089         ?C0343:
                                           ; SOURCE LINE # 1746
0089 900000      E     MOV     DPTR,#CHGIC_ReadCmd0x12L
008C E0                MOVX    A,@DPTR
008D 7009              JNZ     ?C0345
008F 900000      E     MOV     DPTR,#CHGIC_ReadCmd0x12H
0092 E0                MOVX    A,@DPTR
0093 7003              JNZ     $ + 5H
0095 020000      R     LJMP    ?C0332
0098         ?C0345:
                                           ; SOURCE LINE # 1747
                                           ; SOURCE LINE # 1748
0098 120000      R     LCALL   L?0625
009B 20E014            JB      ACC.0,?C0528
009E 900000      E     MOV     DPTR,#EC_BatteryStatusL
00A1 E0                MOVX    A,@DPTR
00A2 30E502            JNB     ACC.5,?C0346
00A5         ?C0347:
                                           ; SOURCE LINE # 1749
                                           ; SOURCE LINE # 1750
                                           ; SOURCE LINE # 1751
00A5 800B              SJMP    ?C0528
00A7         ?C0346:
                                           ; SOURCE LINE # 1753
                                           ; SOURCE LINE # 1754
00A7 120000      R     LCALL   L?0592
00AA 30E00E            JNB     ACC.0,?C0349
00AD 120000      R     LCALL   L?0572
00B0 7009              JNZ     ?C0349
                                           ; SOURCE LINE # 1755
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 113 

                                           ; SOURCE LINE # 1756
00B2         ?C0528:
00B2 900000      E     MOV     DPTR,#CHGIC_WriteCmd0x12L
00B5 E0                MOVX    A,@DPTR
00B6 4401              ORL     A,#01H
00B8 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1757
00B9 8007              SJMP    ?C0348
00BB         ?C0349:
                                           ; SOURCE LINE # 1759
                                           ; SOURCE LINE # 1760
00BB 900000      E     MOV     DPTR,#CHGIC_WriteCmd0x12L
00BE E0                MOVX    A,@DPTR
00BF 54FE              ANL     A,#0FEH
00C1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1761
                                           ; SOURCE LINE # 1762
00C2         ?C0348:
                                           ; SOURCE LINE # 1764
00C2 120000      R     LCALL   L?0626
00C5 FF                MOV     R7,A
00C6 900000      E     MOV     DPTR,#inhibit2sec
00C9 E0                MOVX    A,@DPTR
00CA 4F                ORL     A,R7
00CB FF                MOV     R7,A
00CC 900000      E     MOV     DPTR,#ACOFF_SOURCE
00CF E0                MOVX    A,@DPTR
00D0 4F                ORL     A,R7
00D1 6007              JZ      ?C0351
                                           ; SOURCE LINE # 1765
                                           ; SOURCE LINE # 1766
00D3 900000      E     MOV     DPTR,#CHGIC_WriteCmd0x12L
00D6 E0                MOVX    A,@DPTR
00D7 4401              ORL     A,#01H
00D9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1767
00DA         ?C0351:
                                           ; SOURCE LINE # 1768
00DA 7412              MOV     A,#012H
                                           ; SOURCE LINE # 1769
00DC 120000      R     LCALL   L?0636
00DF 7A00        E     MOV     R2,#HIGH CHGIC_WriteCmd0x12L
00E1 7900        E     MOV     R1,#LOW CHGIC_WriteCmd0x12L
00E3         ?C0527:
                                           ; SOURCE LINE # 1770
00E3 800C              SJMP    ?C0529
                                           ; SOURCE LINE # 1772
                                           ; SOURCE LINE # 1774
                                           ; SOURCE LINE # 1775
                                           ; SOURCE LINE # 1776
00E5         ?C0353:
                                           ; SOURCE LINE # 1777
00E5 900000      R     MOV     DPTR,#sCmd
00E8 7437              MOV     A,#037H
00EA F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1778
00EB 7B01              MOV     R3,#01H
00ED 7A00        E     MOV     R2,#HIGH CHGIC_WriteCmd0x37L
00EF 7900        E     MOV     R1,#LOW CHGIC_WriteCmd0x37L
00F1         ?C0529:
00F1 A3                INC     DPTR
00F2 120000      E     LCALL   ?C?PSTXDATA
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 114 

                                           ; SOURCE LINE # 1779
                                           ; SOURCE LINE # 1780
                                           ; SOURCE LINE # 1782
00F5         ?C0335:
                                           ; SOURCE LINE # 1783
00F5 900000      R     MOV     DPTR,#sCmd
00F8 E0                MOVX    A,@DPTR
00F9 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+03H
00FC F0                MOVX    @DPTR,A
00FD 900000      R     MOV     DPTR,#sData
0100 120000      E     LCALL   ?C?PLDXDATA
0103 CF                XCH     A,R7
0104 E9                MOV     A,R1
0105 CF                XCH     A,R7
0106 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+04H
0109 EA                MOV     A,R2
010A F0                MOVX    @DPTR,A
010B EF                MOV     A,R7
010C 120000      R     LCALL   L?0554
010F 120000      E     LCALL   _bRWSMBus
0112 EF                MOV     A,R7
0113 7003              JNZ     ?C0332
                                           ; SOURCE LINE # 1784
                                           ; SOURCE LINE # 1785
0115 120000      R     LCALL   L?0606
                                           ; SOURCE LINE # 1786
                                           ; SOURCE LINE # 1787
0118         ?C0332:
0118 22                RET     
             ; FUNCTION WriteSmartChgIC (END)

             ; FUNCTION ReadSmartChgIC (BEGIN)
                                           ; SOURCE LINE # 1798
                                           ; SOURCE LINE # 1799
                                           ; SOURCE LINE # 1801
                                           ; SOURCE LINE # 1802
0000 900000      E     MOV     DPTR,#CHGIC_ptr
0003 E0                MOVX    A,@DPTR
0004 25E0              ADD     A,ACC
0006 25E0              ADD     A,ACC
0008 2400        R     ADD     A,#LOW ReadChgIcCmdTable
000A F582              MOV     DPL,A
000C E4                CLR     A
000D 3400        R     ADDC    A,#HIGH ReadChgIcCmdTable
000F F583              MOV     DPH,A
0011 E4                CLR     A
0012 93                MOVC    A,@A+DPTR
0013 FF                MOV     R7,A
0014 900000      E     MOV     DPTR,#CHGIC_ptr
0017 E0                MOVX    A,@DPTR
0018 25E0              ADD     A,ACC
001A 25E0              ADD     A,ACC
001C 2400        R     ADD     A,#LOW ReadChgIcCmdTable+01H
001E F582              MOV     DPL,A
0020 E4                CLR     A
0021 3400        R     ADDC    A,#HIGH ReadChgIcCmdTable+01H
0023 F583              MOV     DPH,A
0025 E4                CLR     A
0026 93                MOVC    A,@A+DPTR
0027 FD                MOV     R5,A
0028 7401              MOV     A,#01H
002A 93                MOVC    A,@A+DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 115 

002B 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+04H
002E CD                XCH     A,R5
002F F0                MOVX    @DPTR,A
0030 A3                INC     DPTR
0031 ED                MOV     A,R5
0032 F0                MOVX    @DPTR,A
0033 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+03H
0036 EF                MOV     A,R7
0037 F0                MOVX    @DPTR,A
0038 E4                CLR     A
0039 900000      E     MOV     DPTR,#?_bRWSMBus?BYTE+06H
003C F0                MOVX    @DPTR,A
003D 7B12              MOV     R3,#012H
003F 7D0C              MOV     R5,#0CH
0041 7F01              MOV     R7,#01H
0043 120000      E     LCALL   _bRWSMBus
0046 EF                MOV     A,R7
0047 7003              JNZ     ?C0357
                                           ; SOURCE LINE # 1806
                                           ; SOURCE LINE # 1807
0049 120000      R     LCALL   L?0606
                                           ; SOURCE LINE # 1808
                                           ; SOURCE LINE # 1809
                                           ; SOURCE LINE # 1810
004C         ?C0357:
004C 22                RET     
             ; FUNCTION ReadSmartChgIC (END)

             ; FUNCTION Chk_Shutdown_Volt (BEGIN)
                                           ; SOURCE LINE # 1812
                                           ; SOURCE LINE # 1813
                                           ; SOURCE LINE # 1819
0000 900000      E     MOV     DPTR,#BATTMANUFACTURE
0003 E0                MOVX    A,@DPTR
0004 B44C11            CJNE    A,#04CH,?C0358
0007 A3                INC     DPTR
0008 E0                MOVX    A,@DPTR
0009 B4470C            CJNE    A,#047H,?C0358
                                           ; SOURCE LINE # 1820
                                           ; SOURCE LINE # 1821
000C 900000      R     MOV     DPTR,#cutoff_volt
000F 7420              MOV     A,#020H
0011 F0                MOVX    @DPTR,A
0012 A3                INC     DPTR
0013 743A              MOV     A,#03AH
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1822
0016 800A              SJMP    ?C0359
0018         ?C0358:
                                           ; SOURCE LINE # 1824
                                           ; SOURCE LINE # 1825
0018 900000      R     MOV     DPTR,#cutoff_volt
001B 7421              MOV     A,#021H
001D F0                MOVX    @DPTR,A
001E A3                INC     DPTR
001F 7434              MOV     A,#034H
0021 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1826
0022         ?C0359:
                                           ; SOURCE LINE # 1829
0022 900000      E     MOV     DPTR,#nPresentVoltH
0025 E0                MOVX    A,@DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 116 

0026 900000      E     MOV     DPTR,#nPresentVoltL
                                           ; SOURCE LINE # 1831
0029 120000      R     LCALL   L?0593
002C 900000      R     MOV     DPTR,#cutoff_volt+01H
002F E0                MOVX    A,@DPTR
0030 9500        E     SUBB    A,ITempW01+01H
0032 900000      R     MOV     DPTR,#cutoff_volt
0035 E0                MOVX    A,@DPTR
0036 9500        E     SUBB    A,ITempW01
0038 4015              JC      ?C0360
                                           ; SOURCE LINE # 1832
                                           ; SOURCE LINE # 1833
003A 900000      E     MOV     DPTR,#BatLowCnt
003D E0                MOVX    A,@DPTR
003E 04                INC     A
003F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1834
0040 E0                MOVX    A,@DPTR
0041 9406              SUBB    A,#06H
0043 400F              JC      ?C0364
0045 120000      R     LCALL   L?0563
0048 600A              JZ      ?C0364
004A E0                MOVX    A,@DPTR
004B B43306            CJNE    A,#033H,?C0364
                                           ; SOURCE LINE # 1835
                                           ; SOURCE LINE # 1839
                                           ; SOURCE LINE # 1840
004E 22                RET     
004F         ?C0360:
                                           ; SOURCE LINE # 1842
                                           ; SOURCE LINE # 1843
004F E4                CLR     A
0050 900000      E     MOV     DPTR,#BatLowCnt
0053 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1844
                                           ; SOURCE LINE # 1845
0054         ?C0364:
0054 22                RET     
             ; FUNCTION Chk_Shutdown_Volt (END)

             ; FUNCTION Chk_BAT1PERCL_5 (BEGIN)
                                           ; SOURCE LINE # 1849
                                           ; SOURCE LINE # 1850
                                           ; SOURCE LINE # 1851
0000 900000      E     MOV     DPTR,#BAT1PERCL
0003 E0                MOVX    A,@DPTR
0004 D3                SETB    C
0005 9400              SUBB    A,#00H
0007 500F              JNC     ?C0365
0009 900000      E     MOV     DPTR,#nBattery0x16L
000C E0                MOVX    A,@DPTR
000D 30E608            JNB     ACC.6,?C0365
                                           ; SOURCE LINE # 1852
                                           ; SOURCE LINE # 1855
0010 900000      E     MOV     DPTR,#BatteryAlarm
0013 E0                MOVX    A,@DPTR
0014 4408              ORL     A,#08H
0016 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1856
0017 22                RET     
0018         ?C0365:
                                           ; SOURCE LINE # 1858
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 117 

                                           ; SOURCE LINE # 1859
0018 900000      E     MOV     DPTR,#BatteryAlarm
001B E0                MOVX    A,@DPTR
001C 30E305            JNB     ACC.3,?C0369
                                           ; SOURCE LINE # 1860
                                           ; SOURCE LINE # 1861
001F E0                MOVX    A,@DPTR
0020 54F7              ANL     A,#0F7H
0022 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1862
0023 E0                MOVX    A,@DPTR
                                           ; SOURCE LINE # 1863
                                           ; SOURCE LINE # 1865
                                           ; SOURCE LINE # 1866
                                           ; SOURCE LINE # 1867
                                           ; SOURCE LINE # 1868
0024         ?C0369:
0024 22                RET     
             ; FUNCTION Chk_BAT1PERCL_5 (END)

             ; FUNCTION Chk_BatSMbusFailCount (BEGIN)
                                           ; SOURCE LINE # 1872
                                           ; SOURCE LINE # 1873
                                           ; SOURCE LINE # 1876
0000 900000      E     MOV     DPTR,#nBattErrorCnt
0003 E0                MOVX    A,@DPTR
0004 701E              JNZ     ?C0370
                                           ; SOURCE LINE # 1877
                                           ; SOURCE LINE # 1878
0006 900000      E     MOV     DPTR,#nStopChgStat3L
0009 E0                MOVX    A,@DPTR
000A 54FB              ANL     A,#0FBH
000C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1879
000D 900000      E     MOV     DPTR,#Bat1_FPChgFlag
0010 E0                MOVX    A,@DPTR
0011 54FE              ANL     A,#0FEH
0013 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1880
0014 120000      R     LCALL   Chk_BAT1PERCL_5
                                           ; SOURCE LINE # 1881
0017 900000      E     MOV     DPTR,#nBattery0x16L
001A E0                MOVX    A,@DPTR
001B 20E603            JB      ACC.6,$ + 6H
001E 020000      R     LJMP    ?C0372
                                           ; SOURCE LINE # 1882
                                           ; SOURCE LINE # 1883
0021 020000      R     LJMP    Chk_Shutdown_Volt
                                           ; SOURCE LINE # 1884
                                           ; SOURCE LINE # 1886
0024         ?C0370:
                                           ; SOURCE LINE # 1889
0024 900000      E     MOV     DPTR,#SYS_STATUS
0027 E0                MOVX    A,@DPTR
0028 20E734            JB      ACC.7,?C0373
                                           ; SOURCE LINE # 1890
                                           ; SOURCE LINE # 1892
002B 120000      R     LCALL   RST_ChgTimeOutCnt
                                           ; SOURCE LINE # 1894
002E 900000      E     MOV     DPTR,#nBattErrorCnt
0031 E0                MOVX    A,@DPTR
0032 B41E03            CJNE    A,#01EH,?C0374
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 118 

                                           ; SOURCE LINE # 1895
                                           ; SOURCE LINE # 1901
0035 120000      R     LCALL   L?0587
                                           ; SOURCE LINE # 1902
0038         ?C0374:
                                           ; SOURCE LINE # 1903
0038 900000      E     MOV     DPTR,#nBattErrorCnt
003B E0                MOVX    A,@DPTR
003C C3                CLR     C
003D 9496              SUBB    A,#096H
003F 4060              JC      ?C0372
                                           ; SOURCE LINE # 1904
                                           ; SOURCE LINE # 1908
0041 120000      R     LCALL   L?0585
                                           ; SOURCE LINE # 1909
0044 900000      E     MOV     DPTR,#nBattErrorCnt
0047 7497              MOV     A,#097H
0049 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1910
004A 120000      R     LCALL   L?0563
004D 6005              JZ      ?C0377
004F E0                MOVX    A,@DPTR
0050 6433              XRL     A,#033H
0052 704D              JNZ     ?C0372
0054         ?C0377:
                                           ; SOURCE LINE # 1911
                                           ; SOURCE LINE # 1912
0054 120000      R     LCALL   L?0616
                                           ; SOURCE LINE # 1913
0057 7F0E              MOV     R7,#0EH
0059 120000      E     LCALL   _ProcessSID
                                           ; SOURCE LINE # 1914
005C 020000      R     LJMP    RSMRST_shutdown
                                           ; SOURCE LINE # 1915
                                           ; SOURCE LINE # 1917
                                           ; SOURCE LINE # 1918
005F         ?C0373:
                                           ; SOURCE LINE # 1920
                                           ; SOURCE LINE # 1922
005F 900000      E     MOV     DPTR,#SYS_STATUS
0062 E0                MOVX    A,@DPTR
0063 30E73B            JNB     ACC.7,?C0372
                                           ; SOURCE LINE # 1923
                                           ; SOURCE LINE # 1924
0066 900000      E     MOV     DPTR,#nBattErrorCnt
0069 E0                MOVX    A,@DPTR
006A 601F              JZ      ?C0380
006C E0                MOVX    A,@DPTR
006D C3                CLR     C
006E 941E              SUBB    A,#01EH
0070 5019              JNC     ?C0380
                                           ; SOURCE LINE # 1925
                                           ; SOURCE LINE # 1926
0072 E4                CLR     A
0073 900000      E     MOV     DPTR,#nBattCharCurrentL
0076 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1927
0077 900000      E     MOV     DPTR,#nBattCharCurrentH
007A 04                INC     A
007B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1928
007C 900000      E     MOV     DPTR,#nChargingVoltL
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 119 

007F 74D0              MOV     A,#0D0H
0081 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1929
0082 900000      E     MOV     DPTR,#nChargingVoltH
0085 7420              MOV     A,#020H
0087 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1932
0088 120000      R     LCALL   L?0585
                                           ; SOURCE LINE # 1933
008B         ?C0380:
                                           ; SOURCE LINE # 1934
008B 900000      E     MOV     DPTR,#nBattErrorCnt
008E E0                MOVX    A,@DPTR
008F C3                CLR     C
0090 941E              SUBB    A,#01EH
0092 400D              JC      ?C0372
                                           ; SOURCE LINE # 1935
                                           ; SOURCE LINE # 1942
0094 120000      R     LCALL   RST_ChgTimeOutCnt
                                           ; SOURCE LINE # 1943
0097 900000      E     MOV     DPTR,#nStopChgStat3L
009A E0                MOVX    A,@DPTR
009B 4404              ORL     A,#04H
009D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1945
009E 120000      R     LCALL   L?0587
                                           ; SOURCE LINE # 1946
                                           ; SOURCE LINE # 1947
                                           ; SOURCE LINE # 1948
                                           ; SOURCE LINE # 1949
00A1         ?C0372:
00A1 22                RET     
             ; FUNCTION Chk_BatSMbusFailCount (END)

             ; FUNCTION Chk_CHG_TimeOut (BEGIN)
                                           ; SOURCE LINE # 1953
                                           ; SOURCE LINE # 1954
                                           ; SOURCE LINE # 1955
0000 900000      E     MOV     DPTR,#nBattTempCnt
0003 E0                MOVX    A,@DPTR
0004 C3                CLR     C
0005 940A              SUBB    A,#0AH
0007 4068              JC      ?C0383
0009         ?C0382:
                                           ; SOURCE LINE # 1957
0009 900000      E     MOV     DPTR,#CHGIC_ReadCmd0x12L
000C E0                MOVX    A,@DPTR
000D 20E061            JB      ACC.0,?C0383
0010         ?C0384:
                                           ; SOURCE LINE # 1960
0010 900000      E     MOV     DPTR,#nBattCharCurrentH
0013 E0                MOVX    A,@DPTR
0014 D3                SETB    C
0015 9401              SUBB    A,#01H
0017 500D              JNC     ?C0386
0019 E0                MOVX    A,@DPTR
001A B4012A            CJNE    A,#01H,?C0385
001D 900000      E     MOV     DPTR,#nBattCharCurrentL
0020 E0                MOVX    A,@DPTR
0021 C3                CLR     C
0022 94F4              SUBB    A,#0F4H
0024 4021              JC      ?C0385
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 120 

0026         ?C0386:
                                           ; SOURCE LINE # 1961
                                           ; SOURCE LINE # 1962
                                           ; SOURCE LINE # 1963
0026 120000      R     LCALL   L?0623
0029 120000      R     LCALL   L?0567
                                           ; SOURCE LINE # 1964
002C C3                CLR     C
002D 900000      E     MOV     DPTR,#FastChgTimeOutCnt+01H
0030 E0                MOVX    A,@DPTR
0031 94D0              SUBB    A,#0D0H
0033 900000      E     MOV     DPTR,#FastChgTimeOutCnt
0036 E0                MOVX    A,@DPTR
0037 9402              SUBB    A,#02H
0039 4036              JC      ?C0383
                                           ; SOURCE LINE # 1965
                                           ; SOURCE LINE # 1966
003B 7402              MOV     A,#02H
003D F0                MOVX    @DPTR,A
003E A3                INC     DPTR
003F 74D1              MOV     A,#0D1H
0041 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1967
0042 900000      E     MOV     DPTR,#nStopChgStat3L
                                           ; SOURCE LINE # 1968
                                           ; SOURCE LINE # 1969
0045 8026              SJMP    ?C0530
0047         ?C0385:
                                           ; SOURCE LINE # 1971
                                           ; SOURCE LINE # 1972
0047 E4                CLR     A
0048 900000      E     MOV     DPTR,#FastChgTimeOutCnt
004B F0                MOVX    @DPTR,A
004C A3                INC     DPTR
004D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1973
004E 900000      E     MOV     DPTR,#TrickleChgTimeOutCnt
0051 120000      R     LCALL   L?0567
                                           ; SOURCE LINE # 1974
0054 C3                CLR     C
0055 900000      E     MOV     DPTR,#TrickleChgTimeOutCnt+01H
0058 E0                MOVX    A,@DPTR
0059 9468              SUBB    A,#068H
005B 900000      E     MOV     DPTR,#TrickleChgTimeOutCnt
005E E0                MOVX    A,@DPTR
005F 9401              SUBB    A,#01H
0061 400E              JC      ?C0383
                                           ; SOURCE LINE # 1975
                                           ; SOURCE LINE # 1976
0063 7401              MOV     A,#01H
0065 F0                MOVX    @DPTR,A
0066 A3                INC     DPTR
0067 7469              MOV     A,#069H
0069 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1977
006A 900000      E     MOV     DPTR,#nStopChgStat3H
006D         ?C0530:
006D E0                MOVX    A,@DPTR
006E 4401              ORL     A,#01H
0070 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1978
                                           ; SOURCE LINE # 1979
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 121 

                                           ; SOURCE LINE # 1980
0071         ?C0383:
0071 22                RET     
             ; FUNCTION Chk_CHG_TimeOut (END)

             ; FUNCTION ChkBattery_abnormal (BEGIN)
                                           ; SOURCE LINE # 1982
                                           ; SOURCE LINE # 1983
                                           ; SOURCE LINE # 1984
0000 900000      E     MOV     DPTR,#BATTUPDATEFW
0003 E0                MOVX    A,@DPTR
0004 20E049            JB      ACC.0,?C0391
0007         ?C0390:
                                           ; SOURCE LINE # 1987
0007 900000      E     MOV     DPTR,#ChkBattery_abnormal_status
000A E0                MOVX    A,@DPTR
000B 24FE              ADD     A,#0FEH
000D 602E              JZ      ?C0397
000F 2402              ADD     A,#02H
0011 7034              JNZ     ?C0398
                                           ; SOURCE LINE # 1988
                                           ; SOURCE LINE # 1989
0013         ?C0393:
                                           ; SOURCE LINE # 1990
0013 900000      E     MOV     DPTR,#CHGIC_ReadCmd0x12L
0016 E0                MOVX    A,@DPTR
0017 30E02D            JNB     ACC.0,?C0531
001A 900000      E     MOV     DPTR,#nNowCurrentH
001D E0                MOVX    A,@DPTR
001E 20E726            JB      ACC.7,?C0531
0021 900000      E     MOV     DPTR,#nNowCurrentL
0024 E0                MOVX    A,@DPTR
0025 D3                SETB    C
0026 9464              SUBB    A,#064H
0028 401D              JC      ?C0531
                                           ; SOURCE LINE # 1992
                                           ; SOURCE LINE # 1993
002A 900000      E     MOV     DPTR,#ChkBattery_abnormal_count
002D E0                MOVX    A,@DPTR
002E 04                INC     A
002F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1994
0030 E0                MOVX    A,@DPTR
0031 D3                SETB    C
0032 9405              SUBB    A,#05H
0034 401A              JC      ?C0391
                                           ; SOURCE LINE # 1995
                                           ; SOURCE LINE # 1996
0036 900000      E     MOV     DPTR,#ChkBattery_abnormal_status
0039 7402              MOV     A,#02H
003B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 1997
                                           ; SOURCE LINE # 1998
003C 22                RET     
                                           ; SOURCE LINE # 2005
003D         ?C0397:
                                           ; SOURCE LINE # 2007
003D 900000      E     MOV     DPTR,#ACOFF_SOURCE
0040 E0                MOVX    A,@DPTR
0041 4401              ORL     A,#01H
0043 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2008
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 122 

0044 020000      R     LJMP    BATT_LEN_ON
                                           ; SOURCE LINE # 2010
                                           ; SOURCE LINE # 2011
0047         ?C0398:
                                           ; SOURCE LINE # 2012
0047         ?C0531:
0047 E4                CLR     A
0048 900000      E     MOV     DPTR,#ChkBattery_abnormal_status
004B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2013
004C 900000      E     MOV     DPTR,#ChkBattery_abnormal_count
004F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2014
                                           ; SOURCE LINE # 2015
                                           ; SOURCE LINE # 2016
0050         ?C0391:
0050 22                RET     
             ; FUNCTION ChkBattery_abnormal (END)

             ; FUNCTION _Compare_data (BEGIN)
                                           ; SOURCE LINE # 2019
0000 900000      R     MOV     DPTR,#buf1
0003 EE                MOV     A,R6
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EF                MOV     A,R7
0007 F0                MOVX    @DPTR,A
0008 A3                INC     DPTR
0009 EC                MOV     A,R4
000A F0                MOVX    @DPTR,A
000B A3                INC     DPTR
000C ED                MOV     A,R5
000D F0                MOVX    @DPTR,A
;---- Variable 'count' assigned to Register 'R3' ----
                                           ; SOURCE LINE # 2020
000E         ?C0401:
                                           ; SOURCE LINE # 2022
                                           ; SOURCE LINE # 2023
000E 900000      R     MOV     DPTR,#buf2
0011 E0                MOVX    A,@DPTR
0012 FE                MOV     R6,A
0013 A3                INC     DPTR
0014 E0                MOVX    A,@DPTR
0015 F582              MOV     DPL,A
0017 8E83              MOV     DPH,R6
0019 E0                MOVX    A,@DPTR
001A FF                MOV     R7,A
001B 900000      R     MOV     DPTR,#buf1
001E E0                MOVX    A,@DPTR
001F FC                MOV     R4,A
0020 A3                INC     DPTR
0021 E0                MOVX    A,@DPTR
0022 F582              MOV     DPL,A
0024 8C83              MOV     DPH,R4
0026 E0                MOVX    A,@DPTR
0027 6F                XRL     A,R7
0028 6003              JZ      ?C0402
002A 7F00              MOV     R7,#00H
002C 22                RET     
002D         ?C0402:
                                           ; SOURCE LINE # 2024
002D 900000      R     MOV     DPTR,#buf1
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 123 

0030 120000      R     LCALL   L?0565
                                           ; SOURCE LINE # 2025
0033 900000      R     MOV     DPTR,#buf2
0036 120000      R     LCALL   L?0565
                                           ; SOURCE LINE # 2026
0039 DBD3              DJNZ    R3,?C0401
                                           ; SOURCE LINE # 2027
                                           ; SOURCE LINE # 2028
003B 7F01              MOV     R7,#01H
                                           ; SOURCE LINE # 2029
003D         ?C0403:
003D 22                RET     
             ; FUNCTION _Compare_data (END)

             ; FUNCTION Compare_Auth_Result (BEGIN)
                                           ; SOURCE LINE # 2031
                                           ; SOURCE LINE # 2032
                                           ; SOURCE LINE # 2035
0000 7E00        E     MOV     R6,#HIGH K
0002 7F00        E     MOV     R7,#LOW K
0004 7C00        E     MOV     R4,#HIGH RBATH0
0006 7D00        E     MOV     R5,#LOW RBATH0
0008 7B14              MOV     R3,#014H
000A 120000      R     LCALL   _Compare_data
000D EF                MOV     A,R7
000E 601F              JZ      ?C0404
                                           ; SOURCE LINE # 2036
                                           ; SOURCE LINE # 2037
0010 900000      E     MOV     DPTR,#nStopChgStat3H
0013 E0                MOVX    A,@DPTR
0014 54DF              ANL     A,#0DFH
0016 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2038
0017 900000      E     MOV     DPTR,#LENOVOBATT
001A E0                MOVX    A,@DPTR
001B 54FD              ANL     A,#0FDH
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2039
001E 900000      E     MOV     DPTR,#LV_Authen_Step_CNT
0021 E0                MOVX    A,@DPTR
0022 54BF              ANL     A,#0BFH
0024 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2040
0025 E4                CLR     A
0026 900000      E     MOV     DPTR,#SHA1failCnt
0029 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2041
002A 900000      E     MOV     DPTR,#SHA1FailRetry
002D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2042
002E 22                RET     
002F         ?C0404:
                                           ; SOURCE LINE # 2044
                                           ; SOURCE LINE # 2045
002F 900000      E     MOV     DPTR,#SHA1failCnt
0032 E0                MOVX    A,@DPTR
0033 04                INC     A
0034 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2046
0035 E0                MOVX    A,@DPTR
0036 C3                CLR     C
0037 9404              SUBB    A,#04H
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 124 

0039 5007              JNC     ?C0406
                                           ; SOURCE LINE # 2047
                                           ; SOURCE LINE # 2048
003B 900000      E     MOV     DPTR,#Service_Auth_Step
003E 7417              MOV     A,#017H
0040 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2049
0041 22                RET     
0042         ?C0406:
                                           ; SOURCE LINE # 2051
                                           ; SOURCE LINE # 2052
0042 900000      E     MOV     DPTR,#SHA1FailRetry
0045 E0                MOVX    A,@DPTR
0046 04                INC     A
0047 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2054
0048 E0                MOVX    A,@DPTR
0049 6403              XRL     A,#03H
004B 6008              JZ      ?C0408
004D E0                MOVX    A,@DPTR
004E C3                CLR     C
004F 940B              SUBB    A,#0BH
0051 5002              JNC     ?C0408
                                           ; SOURCE LINE # 2055
                                           ; SOURCE LINE # 2056
                                           ; SOURCE LINE # 2057
0053 801C              SJMP    ?C0532
0055         ?C0408:
                                           ; SOURCE LINE # 2058
0055 900000      E     MOV     DPTR,#SHA1FailRetry
0058 E0                MOVX    A,@DPTR
0059 B4031B            CJNE    A,#03H,?C0411
                                           ; SOURCE LINE # 2059
                                           ; SOURCE LINE # 2060
005C 900000      E     MOV     DPTR,#nStopChgStat3H
005F E0                MOVX    A,@DPTR
0060 4420              ORL     A,#020H
0062 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2061
0063 900000      E     MOV     DPTR,#LENOVOBATT
0066 E0                MOVX    A,@DPTR
0067 4402              ORL     A,#02H
0069 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2062
006A 900000      E     MOV     DPTR,#LV_Authen_Step_CNT
006D E0                MOVX    A,@DPTR
006E 4440              ORL     A,#040H
0070 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2063
0071         ?C0532:
0071 900000      E     MOV     DPTR,#Service_Auth_Step
0074 7401              MOV     A,#01H
0076 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2064
                                           ; SOURCE LINE # 2065
                                           ; SOURCE LINE # 2066
                                           ; SOURCE LINE # 2067
0077         ?C0411:
0077 22                RET     
             ; FUNCTION Compare_Auth_Result (END)

             ; FUNCTION SendChallengeToBat (BEGIN)
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 125 

                                           ; SOURCE LINE # 2069
                                           ; SOURCE LINE # 2070
                                           ; SOURCE LINE # 2072
0000 900000      E     MOV     DPTR,#?_bWSMBusBlock?BYTE+03H
0003 7427              MOV     A,#027H
0005 F0                MOVX    @DPTR,A
0006 7E00        E     MOV     R6,#HIGH BATchallenger
0008 A3                INC     DPTR
0009 7400        E     MOV     A,#HIGH BATchallenger
000B F0                MOVX    @DPTR,A
000C A3                INC     DPTR
000D 7400        E     MOV     A,#LOW BATchallenger
000F F0                MOVX    @DPTR,A
0010 A3                INC     DPTR
0011 7414              MOV     A,#014H
0013 F0                MOVX    @DPTR,A
0014 A3                INC     DPTR
0015 7401              MOV     A,#01H
0017 F0                MOVX    @DPTR,A
0018 7B16              MOV     R3,#016H
001A 7D94              MOV     R5,#094H
001C FF                MOV     R7,A
001D 120000      E     LCALL   _bWSMBusBlock
;---- Variable 'SMBus_work' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 2073
0020 EF                MOV     A,R7
0021 6003              JZ      ?C0412
                                           ; SOURCE LINE # 2074
0023 7F01              MOV     R7,#01H
0025 22                RET     
0026         ?C0412:
                                           ; SOURCE LINE # 2076
0026 7F00              MOV     R7,#00H
                                           ; SOURCE LINE # 2077
0028         ?C0413:
0028 22                RET     
             ; FUNCTION SendChallengeToBat (END)

             ; FUNCTION GetChallengeFromBat (BEGIN)
                                           ; SOURCE LINE # 2079
                                           ; SOURCE LINE # 2080
                                           ; SOURCE LINE # 2081
0000 900000      E     MOV     DPTR,#?_bRSMBusBlock?BYTE+03H
0003 7428              MOV     A,#028H
0005 F0                MOVX    @DPTR,A
0006 7E00        E     MOV     R6,#HIGH RBATH0
0008 A3                INC     DPTR
0009 7400        E     MOV     A,#HIGH RBATH0
000B F0                MOVX    @DPTR,A
000C 7400        E     MOV     A,#LOW RBATH0
000E 120000      R     LCALL   L?0601
0011 120000      E     LCALL   _bRSMBusBlock
0014 EF                MOV     A,R7
0015 6003              JZ      ?C0414
                                           ; SOURCE LINE # 2082
0017 7F01              MOV     R7,#01H
0019 22                RET     
001A         ?C0414:
                                           ; SOURCE LINE # 2084
001A 7F00              MOV     R7,#00H
                                           ; SOURCE LINE # 2085
001C         ?C0415:
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 126 

001C 22                RET     
             ; FUNCTION GetChallengeFromBat (END)

             ; FUNCTION _SetRandomKey (BEGIN)
                                           ; SOURCE LINE # 2087
;---- Variable 'N' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 2088
                                           ; SOURCE LINE # 2092
0000 EF                MOV     A,R7
0001 6401              XRL     A,#01H
0003 7031              JNZ     ?C0416
                                           ; SOURCE LINE # 2093
                                           ; SOURCE LINE # 2094
0005 7B01              MOV     R3,#01H
0007 7A00        E     MOV     R2,#HIGH BATchallenger
0009 7900        E     MOV     R1,#LOW BATchallenger
000B 900000      R     MOV     DPTR,#ptr
000E 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 2095
0011 E4                CLR     A
0012 900000      R     MOV     DPTR,#i
0015 F0                MOVX    @DPTR,A
0016         ?C0417:
                                           ; SOURCE LINE # 2096
                                           ; SOURCE LINE # 2097
0016 120000      E     LCALL   rand
0019 900000      R     MOV     DPTR,#ptr
001C 120000      E     LCALL   ?C?PLDXDATA
001F EF                MOV     A,R7
0020 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 2098
0023 900000      R     MOV     DPTR,#ptr+01H
0026 120000      R     LCALL   L?0566
                                           ; SOURCE LINE # 2099
0029 900000      R     MOV     DPTR,#i
002C E0                MOVX    A,@DPTR
002D 04                INC     A
002E F0                MOVX    @DPTR,A
002F E0                MOVX    A,@DPTR
0030 C3                CLR     C
0031 9414              SUBB    A,#014H
0033 40E1              JC      ?C0417
0035 22                RET     
                                           ; SOURCE LINE # 2122
0036         ?C0416:
                                           ; SOURCE LINE # 2124
                                           ; SOURCE LINE # 2127
0036 E4                CLR     A
0037 900000      E     MOV     DPTR,#N_Bit_Shift
003A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2128
003B 750000      E     MOV     ITempW01,#HIGH Hn0
003E 750000      E     MOV     ITempW01+01H,#LOW Hn0
                                           ; SOURCE LINE # 2129
0041 E500        E     MOV     A,ITempW01
0043 900000      E     MOV     DPTR,#AddrX_High
0046 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2130
0047 AF00        E     MOV     R7,ITempW01+01H
0049 EF                MOV     A,R7
004A 900000      E     MOV     DPTR,#AddrX_Low
004D F0                MOVX    @DPTR,A
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 127 

                                           ; SOURCE LINE # 2131
004E 750000      E     MOV     ITempW01,#HIGH SHA1_W+010H
0051 750000      E     MOV     ITempW01+01H,#LOW SHA1_W+010H
                                           ; SOURCE LINE # 2132
0054 E500        E     MOV     A,ITempW01
0056 900000      E     MOV     DPTR,#AddrZ_High
0059 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2133
005A AF00        E     MOV     R7,ITempW01+01H
005C EF                MOV     A,R7
005D 900000      E     MOV     DPTR,#AddrZ_Low
                                           ; SOURCE LINE # 2134
0060 120000      R     LCALL   L?0546
                                           ; SOURCE LINE # 2137
                                           ; SOURCE LINE # 2138
                                           ; SOURCE LINE # 2139
                                           ; SOURCE LINE # 2142
                                           ; SOURCE LINE # 2143
                                           ; SOURCE LINE # 2144
0063 120000      R     LCALL   L?0545
                                           ; SOURCE LINE # 2147
                                           ; SOURCE LINE # 2148
                                           ; SOURCE LINE # 2149
                                           ; SOURCE LINE # 2152
                                           ; SOURCE LINE # 2153
                                           ; SOURCE LINE # 2154
0066 120000      R     LCALL   L?0545
                                           ; SOURCE LINE # 2155
                                           ; SOURCE LINE # 2156
0069         ?C0421:
0069 22                RET     
             ; FUNCTION _SetRandomKey (END)

             ; FUNCTION LV_BAT_Authentication (BEGIN)
                                           ; SOURCE LINE # 2160
                                           ; SOURCE LINE # 2161
                                           ; SOURCE LINE # 2168
0000 900000      E     MOV     DPTR,#Service_Auth_Step
0003 E0                MOVX    A,@DPTR
0004 120000      E     LCALL   ?C?CCASE
0007 0000        R     DW      ?C0432
0009 00                DB      00H
000A 0000        R     DW      ?C0423
000C 01                DB      01H
000D 0000        R     DW      ?C0424
000F 15                DB      015H
0010 0000        R     DW      ?C0425
0012 16                DB      016H
0013 0000        R     DW      ?C0429
0015 17                DB      017H
0016 0000        R     DW      ?C0430
0018 18                DB      018H
0019 0000        R     DW      ?C0431
001B 19                DB      019H
001C 0000              DW      00H
001E 0000        R     DW      ?C0433
                                           ; SOURCE LINE # 2169
                                           ; SOURCE LINE # 2170
0020         ?C0423:
                                           ; SOURCE LINE # 2172
0020 7F01              MOV     R7,#01H
0022 120000      R     LCALL   _SetRandomKey
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 128 

                                           ; SOURCE LINE # 2173
0025 900000      E     MOV     DPTR,#Service_Auth_Step
0028 7402              MOV     A,#02H
002A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2174
002B 22                RET     
                                           ; SOURCE LINE # 2175
002C         ?C0424:
                                           ; SOURCE LINE # 2176
002C 120000      R     LCALL   SendChallengeToBat
                                           ; SOURCE LINE # 2177
002F 900000      E     MOV     DPTR,#Service_Auth_Step
0032 7416              MOV     A,#016H
0034 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2178
0035 22                RET     
                                           ; SOURCE LINE # 2179
0036         ?C0425:
                                           ; SOURCE LINE # 2180
0036 7E00        E     MOV     R6,#HIGH BATchallenger
0038 7F00        E     MOV     R7,#LOW BATchallenger
003A 120000      E     LCALL   _sha1_auth
003D 900000      R     MOV     DPTR,#byte_sha1_pntr
0040 EE                MOV     A,R6
0041 F0                MOVX    @DPTR,A
0042 A3                INC     DPTR
0043 EF                MOV     A,R7
0044 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2181
0045 E4                CLR     A
0046 A3                INC     DPTR
0047 F0                MOVX    @DPTR,A
0048 A3                INC     DPTR
0049 F0                MOVX    @DPTR,A
004A         ?C0426:
                                           ; SOURCE LINE # 2182
                                           ; SOURCE LINE # 2183
004A 900000      R     MOV     DPTR,#byte_sha1_pntr
004D E0                MOVX    A,@DPTR
004E FE                MOV     R6,A
004F A3                INC     DPTR
0050 E0                MOVX    A,@DPTR
0051 F582              MOV     DPL,A
0053 8E83              MOV     DPH,R6
0055 120000      E     LCALL   ?C?LLDXDATA
0058 EC                MOV     A,R4
0059 C0E0              PUSH    ACC
005B ED                MOV     A,R5
005C C0E0              PUSH    ACC
005E EE                MOV     A,R6
005F C0E0              PUSH    ACC
0061 EF                MOV     A,R7
0062 C0E0              PUSH    ACC
0064 900000      R     MOV     DPTR,#j
0067 E0                MOVX    A,@DPTR
0068 FE                MOV     R6,A
0069 A3                INC     DPTR
006A E0                MOVX    A,@DPTR
006B 7802              MOV     R0,#02H
006D         ?C0483:
006D C3                CLR     C
006E 33                RLC     A
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 129 

006F CE                XCH     A,R6
0070 33                RLC     A
0071 CE                XCH     A,R6
0072 D8F9              DJNZ    R0,?C0483
0074 2400        E     ADD     A,#LOW K
0076 F582              MOV     DPL,A
0078 7400        E     MOV     A,#HIGH K
007A 3E                ADDC    A,R6
007B F583              MOV     DPH,A
007D D0E0              POP     ACC
007F FF                MOV     R7,A
0080 D0E0              POP     ACC
0082 FE                MOV     R6,A
0083 D0E0              POP     ACC
0085 FD                MOV     R5,A
0086 D0E0              POP     ACC
0088 FC                MOV     R4,A
0089 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 2184
008C 900000      R     MOV     DPTR,#byte_sha1_pntr
008F E4                CLR     A
0090 75F004            MOV     B,#04H
0093 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 2185
0096 900000      R     MOV     DPTR,#j
0099 120000      R     LCALL   L?0566
009C 900000      R     MOV     DPTR,#j
009F E0                MOVX    A,@DPTR
00A0 7004              JNZ     ?C0484
00A2 A3                INC     DPTR
00A3 E0                MOVX    A,@DPTR
00A4 6405              XRL     A,#05H
00A6         ?C0484:
00A6 70A2              JNZ     ?C0426
00A8         ?C0427:
                                           ; SOURCE LINE # 2186
00A8 900000      E     MOV     DPTR,#Service_Auth_Step
00AB 7417              MOV     A,#017H
00AD F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2187
00AE 22                RET     
                                           ; SOURCE LINE # 2188
00AF         ?C0429:
                                           ; SOURCE LINE # 2189
00AF 900000      E     MOV     DPTR,#Service_Auth_Step
00B2 7418              MOV     A,#018H
00B4 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2190
00B5 22                RET     
                                           ; SOURCE LINE # 2191
00B6         ?C0430:
                                           ; SOURCE LINE # 2192
00B6 900000      E     MOV     DPTR,#Service_Auth_Step
00B9 7419              MOV     A,#019H
00BB F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2193
00BC 22                RET     
                                           ; SOURCE LINE # 2194
00BD         ?C0431:
                                           ; SOURCE LINE # 2195
00BD 120000      R     LCALL   GetChallengeFromBat
                                           ; SOURCE LINE # 2196
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 130 

00C0 E4                CLR     A
00C1 900000      E     MOV     DPTR,#Service_Auth_Step
00C4 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2197
00C5 020000      R     LJMP    Compare_Auth_Result
                                           ; SOURCE LINE # 2198
                                           ; SOURCE LINE # 2199
00C8         ?C0432:
                                           ; SOURCE LINE # 2200
00C8 E4                CLR     A
00C9 900000      E     MOV     DPTR,#Service_Auth_Step
00CC F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2201
00CD 22                RET     
                                           ; SOURCE LINE # 2202
00CE         ?C0433:
                                           ; SOURCE LINE # 2203
00CE 900000      E     MOV     DPTR,#Service_Auth_Step
00D1 E0                MOVX    A,@DPTR
00D2 04                INC     A
00D3 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2204
                                           ; SOURCE LINE # 2205
                                           ; SOURCE LINE # 2206
00D4         ?C0434:
00D4 22                RET     
             ; FUNCTION LV_BAT_Authentication (END)

             ; FUNCTION Lenovo_Battery_EM80 (BEGIN)
                                           ; SOURCE LINE # 2209
                                           ; SOURCE LINE # 2210
                                           ; SOURCE LINE # 2211
0000 900000      E     MOV     DPTR,#EM8_TEST
0003 E0                MOVX    A,@DPTR
0004 704E              JNZ     ?C0435
                                           ; SOURCE LINE # 2212
                                           ; SOURCE LINE # 2213
0006 900000      E     MOV     DPTR,#Bat0x3ETempH
0009 E0                MOVX    A,@DPTR
000A 30E017            JNB     ACC.0,?C0436
000D 900000      E     MOV     DPTR,#SYS_STATUS
0010 E0                MOVX    A,@DPTR
0011 30E710            JNB     ACC.7,?C0436
0014 900000      E     MOV     DPTR,#LENOVOPMFW
0017 E0                MOVX    A,@DPTR
0018 20E409            JB      ACC.4,?C0436
                                           ; SOURCE LINE # 2214
                                           ; SOURCE LINE # 2215
001B 900000      E     MOV     DPTR,#LENOVOBATT
001E E0                MOVX    A,@DPTR
001F 4401              ORL     A,#01H
0021 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2216
0022 8007              SJMP    ?C0437
0024         ?C0436:
                                           ; SOURCE LINE # 2218
                                           ; SOURCE LINE # 2219
0024 900000      E     MOV     DPTR,#LENOVOBATT
0027 E0                MOVX    A,@DPTR
0028 54FE              ANL     A,#0FEH
002A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2220
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 131 

002B         ?C0437:
                                           ; SOURCE LINE # 2222
002B 900000      E     MOV     DPTR,#Bat0x00TempL
002E E0                MOVX    A,@DPTR
002F 5403              ANL     A,#03H
0031 900000      E     MOV     DPTR,#LENOVOBATT
0034 6006              JZ      ?C0438
                                           ; SOURCE LINE # 2223
                                           ; SOURCE LINE # 2224
0036 E0                MOVX    A,@DPTR
0037 4420              ORL     A,#020H
0039 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2225
003A 8004              SJMP    ?C0439
003C         ?C0438:
                                           ; SOURCE LINE # 2227
                                           ; SOURCE LINE # 2228
003C E0                MOVX    A,@DPTR
003D 54DF              ANL     A,#0DFH
003F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2229
0040         ?C0439:
                                           ; SOURCE LINE # 2231
0040 900000      E     MOV     DPTR,#Bat0x3ETempH
0043 E0                MOVX    A,@DPTR
0044 900000      E     MOV     DPTR,#LENOVOBATT
0047 30E105            JNB     ACC.1,?C0440
                                           ; SOURCE LINE # 2232
                                           ; SOURCE LINE # 2233
004A E0                MOVX    A,@DPTR
004B 4404              ORL     A,#04H
004D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2234
004E 22                RET     
004F         ?C0440:
                                           ; SOURCE LINE # 2236
                                           ; SOURCE LINE # 2237
004F E0                MOVX    A,@DPTR
0050 54FB              ANL     A,#0FBH
0052 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2238
                                           ; SOURCE LINE # 2239
0053 22                RET     
0054         ?C0435:
                                           ; SOURCE LINE # 2241
                                           ; SOURCE LINE # 2242
0054 900000      E     MOV     DPTR,#EM8_TEST
0057 E0                MOVX    A,@DPTR
0058 900000      E     MOV     DPTR,#LENOVOBATT
005B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2243
                                           ; SOURCE LINE # 2244
005C         ?C0443:
005C 22                RET     
             ; FUNCTION Lenovo_Battery_EM80 (END)

             ; FUNCTION BATT_LEN_OFF (BEGIN)
                                           ; SOURCE LINE # 2247
                                           ; SOURCE LINE # 2248
                                           ; SOURCE LINE # 2249
0000 900000      E     MOV     DPTR,#CHGIC_WriteCmd0x12L
0003 E0                MOVX    A,@DPTR
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 132 

0004 54DF              ANL     A,#0DFH
                                           ; SOURCE LINE # 2250
0006 120000      R     LCALL   L?0553
0009 120000      E     LCALL   _bRWSMBus
000C EF                MOV     A,R7
000D 7008              JNZ     ?C0445
                                           ; SOURCE LINE # 2251
                                           ; SOURCE LINE # 2252
000F 120000      R     LCALL   L?0607
                                           ; SOURCE LINE # 2253
0012 7F13              MOV     R7,#013H
0014 120000      E     LCALL   _RamDebug
                                           ; SOURCE LINE # 2254
                                           ; SOURCE LINE # 2255
0017         ?C0445:
0017 22                RET     
             ; FUNCTION BATT_LEN_OFF (END)

             ; FUNCTION BATT_LEN_ON (BEGIN)
                                           ; SOURCE LINE # 2256
                                           ; SOURCE LINE # 2257
                                           ; SOURCE LINE # 2258
0000 900000      E     MOV     DPTR,#CHGIC_WriteCmd0x12L
0003 E0                MOVX    A,@DPTR
0004 4420              ORL     A,#020H
                                           ; SOURCE LINE # 2259
0006 120000      R     LCALL   L?0553
0009 120000      E     LCALL   _bRWSMBus
000C EF                MOV     A,R7
000D 7008              JNZ     ?C0447
                                           ; SOURCE LINE # 2260
                                           ; SOURCE LINE # 2261
000F 120000      R     LCALL   L?0607
                                           ; SOURCE LINE # 2262
0012 7F12              MOV     R7,#012H
0014 120000      E     LCALL   _RamDebug
                                           ; SOURCE LINE # 2263
                                           ; SOURCE LINE # 2264
0017         ?C0447:
0017 22                RET     
             ; FUNCTION BATT_LEN_ON (END)

             ; FUNCTION PollingCPURT (BEGIN)
                                           ; SOURCE LINE # 2359
                                           ; SOURCE LINE # 2360
                                           ; SOURCE LINE # 2362
;---- Variable 'j' assigned to Register 'R7' ----
0000 E4                CLR     A
0001 FF                MOV     R7,A
                                           ; SOURCE LINE # 2364
;---- Variable 'i' assigned to Register 'R6' ----
0002 FE                MOV     R6,A
0003         ?C0448:
                                           ; SOURCE LINE # 2365
                                           ; SOURCE LINE # 2366
0003 120000      R     LCALL   L?0551
0006 120000      R     LCALL   L?0628
0009 5003              JNC     ?C0451
                                           ; SOURCE LINE # 2367
                                           ; SOURCE LINE # 2368
000B 0F                INC     R7
                                           ; SOURCE LINE # 2369
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 133 

000C 8010              SJMP    ?C0450
000E         ?C0451:
                                           ; SOURCE LINE # 2370
000E 120000      R     LCALL   L?0551
0011 120000      R     LCALL   L?0628
0014 4008              JC      ?C0450
                                           ; SOURCE LINE # 2371
                                           ; SOURCE LINE # 2372
0016 120000      R     LCALL   L?0608
0019 900000      E     MOV     DPTR,#ThermistorCPU_TEMP
001C F0                MOVX    @DPTR,A
001D 22                RET     
                                           ; SOURCE LINE # 2374
                                           ; SOURCE LINE # 2375
001E         ?C0450:
001E 0E                INC     R6
001F EE                MOV     A,R6
0020 B457E0            CJNE    A,#057H,?C0448
                                           ; SOURCE LINE # 2376
0023         ?C0454:
0023 22                RET     
             ; FUNCTION PollingCPURT (END)

             ; FUNCTION PollingGPURT (BEGIN)
                                           ; SOURCE LINE # 2379
                                           ; SOURCE LINE # 2380
                                           ; SOURCE LINE # 2382
;---- Variable 'j' assigned to Register 'R7' ----
0000 E4                CLR     A
0001 FF                MOV     R7,A
                                           ; SOURCE LINE # 2384
;---- Variable 'i' assigned to Register 'R6' ----
0002 FE                MOV     R6,A
0003         ?C0455:
                                           ; SOURCE LINE # 2385
                                           ; SOURCE LINE # 2386
0003 120000      R     LCALL   L?0552
0006 120000      R     LCALL   L?0629
0009 5003              JNC     ?C0458
                                           ; SOURCE LINE # 2387
                                           ; SOURCE LINE # 2388
000B 0F                INC     R7
                                           ; SOURCE LINE # 2389
000C 8010              SJMP    ?C0457
000E         ?C0458:
                                           ; SOURCE LINE # 2390
000E 120000      R     LCALL   L?0552
0011 120000      R     LCALL   L?0629
0014 4008              JC      ?C0457
                                           ; SOURCE LINE # 2391
                                           ; SOURCE LINE # 2392
0016 120000      R     LCALL   L?0608
0019 900000      E     MOV     DPTR,#EXTVGA_TEMP
001C F0                MOVX    @DPTR,A
001D 22                RET     
                                           ; SOURCE LINE # 2394
                                           ; SOURCE LINE # 2395
001E         ?C0457:
001E 0E                INC     R6
001F EE                MOV     A,R6
0020 B457E0            CJNE    A,#057H,?C0455
                                           ; SOURCE LINE # 2396
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 134 

0023         ?C0461:
0023 22                RET     
             ; FUNCTION PollingGPURT (END)

             ; FUNCTION Clear_Batt_First_Used_Date (BEGIN)
                                           ; SOURCE LINE # 2400
                                           ; SOURCE LINE # 2401
                                           ; SOURCE LINE # 2402
0000 900000      E     MOV     DPTR,#SEL_STATE0
0003 E0                MOVX    A,@DPTR
0004 30E050            JNB     ACC.0,?C0465
                                           ; SOURCE LINE # 2403
                                           ; SOURCE LINE # 2404
0007 900000      E     MOV     DPTR,#pProject0
000A E0                MOVX    A,@DPTR
000B 30E149            JNB     ACC.1,?C0465
                                           ; SOURCE LINE # 2405
                                           ; SOURCE LINE # 2406
000E 120000      R     LCALL   L?0609
0011 A3                INC     DPTR
0012 7400        E     MOV     A,#LOW batteryFirstUsedDateL
0014 F0                MOVX    @DPTR,A
0015 A3                INC     DPTR
0016 7401              MOV     A,#01H
0018 F0                MOVX    @DPTR,A
0019 7B16              MOV     R3,#016H
001B 7D0C              MOV     R5,#0CH
001D FF                MOV     R7,A
001E 120000      E     LCALL   _bRWSMBus
0021 EF                MOV     A,R7
0022 7004              JNZ     ?C0464
                                           ; SOURCE LINE # 2407
                                           ; SOURCE LINE # 2408
0024 7FAE              MOV     R7,#0AEH
0026 8025              SJMP    ?C0533
                                           ; SOURCE LINE # 2410
0028         ?C0464:
                                           ; SOURCE LINE # 2411
0028 900000      E     MOV     DPTR,#batteryFirstUsedDateH
002B E0                MOVX    A,@DPTR
002C 7006              JNZ     ?C0467
002E 900000      E     MOV     DPTR,#batteryFirstUsedDateL
0031 E0                MOVX    A,@DPTR
0032 601C              JZ      ?C0466
0034         ?C0467:
                                           ; SOURCE LINE # 2412
                                           ; SOURCE LINE # 2413
0034 E4                CLR     A
0035 900000      E     MOV     DPTR,#batteryFirstUsedDateH
0038 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2414
0039 900000      E     MOV     DPTR,#batteryFirstUsedDateL
003C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2415
003D 120000      R     LCALL   L?0609
0040 7400        E     MOV     A,#LOW batteryFirstUsedDateL
0042 120000      R     LCALL   L?0539
0045 120000      E     LCALL   _bRWSMBus
0048 EF                MOV     A,R7
0049 700C              JNZ     ?C0465
                                           ; SOURCE LINE # 2416
                                           ; SOURCE LINE # 2417
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 135 

004B 7FAD              MOV     R7,#0ADH
004D         ?C0533:
004D 020000      E     LJMP    _RamDebug
                                           ; SOURCE LINE # 2419
                                           ; SOURCE LINE # 2420
0050         ?C0466:
                                           ; SOURCE LINE # 2422
                                           ; SOURCE LINE # 2423
0050 900000      E     MOV     DPTR,#pProject0
0053 E0                MOVX    A,@DPTR
0054 54FD              ANL     A,#0FDH
0056 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 2424
                                           ; SOURCE LINE # 2425
                                           ; SOURCE LINE # 2427
                                           ; SOURCE LINE # 2428
0057         ?C0465:
0057 22                RET     
             ; FUNCTION Clear_Batt_First_Used_Date (END)

             ; FUNCTION Battery_Expresscharge (BEGIN)
                                           ; SOURCE LINE # 2436
                                           ; SOURCE LINE # 2437
                                           ; SOURCE LINE # 2438
0000 900000      E     MOV     DPTR,#EC_C_modeL
0003 E0                MOVX    A,@DPTR
0004 30E43C            JNB     ACC.4,?C0471
                                           ; SOURCE LINE # 2439
                                           ; SOURCE LINE # 2441
0007         ?C0470:
                                           ; SOURCE LINE # 2442
0007 900000      E     MOV     DPTR,#OEMControl
000A E0                MOVX    A,@DPTR
000B 30E01A            JNB     ACC.0,?C0472
                                           ; SOURCE LINE # 2443
                                           ; SOURCE LINE # 2444
000E 900000      E     MOV     DPTR,#Bat0x3ETempH
0011 E0                MOVX    A,@DPTR
0012 20E42E            JB      ACC.4,?C0471
                                           ; SOURCE LINE # 2445
                                           ; SOURCE LINE # 2446
0015 E0                MOVX    A,@DPTR
0016 4410              ORL     A,#010H
                                           ; SOURCE LINE # 2447
0018 120000      R     LCALL   L?0577
001B 120000      R     LCALL   L?0540
001E 120000      E     LCALL   _bRWSMBus
0021 EF                MOV     A,R7
0022 601F              JZ      ?C0471
                                           ; SOURCE LINE # 2448
                                           ; SOURCE LINE # 2449
0024 7FD1              MOV     R7,#0D1H
                                           ; SOURCE LINE # 2450
                                           ; SOURCE LINE # 2451
                                           ; SOURCE LINE # 2452
0026 8018              SJMP    ?C0534
0028         ?C0472:
                                           ; SOURCE LINE # 2454
                                           ; SOURCE LINE # 2455
0028 900000      E     MOV     DPTR,#Bat0x3ETempH
002B E0                MOVX    A,@DPTR
002C 30E414            JNB     ACC.4,?C0471
C51 COMPILER V8.12   OEM_BATTERY                                                           09/14/2018 11:08:12 PAGE 136 

                                           ; SOURCE LINE # 2456
                                           ; SOURCE LINE # 2457
002F E0                MOVX    A,@DPTR
0030 54EF              ANL     A,#0EFH
                                           ; SOURCE LINE # 2458
0032 120000      R     LCALL   L?0577
0035 120000      R     LCALL   L?0540
0038 120000      E     LCALL   _bRWSMBus
003B EF                MOV     A,R7
003C 6005              JZ      ?C0471
                                           ; SOURCE LINE # 2459
                                           ; SOURCE LINE # 2460
003E 7FD2              MOV     R7,#0D2H
0040         ?C0534:
0040 120000      E     LCALL   _RamDebug
                                           ; SOURCE LINE # 2461
                                           ; SOURCE LINE # 2462
                                           ; SOURCE LINE # 2463
                                           ; SOURCE LINE # 2464
0043         ?C0471:
0043 22                RET     
             ; FUNCTION Battery_Expresscharge (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   6911    ----
   CONSTANT SIZE    =    389    ----
   XDATA SIZE       =   ----      45
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
